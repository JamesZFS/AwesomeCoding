define("rds/account/config",["require","er/controller"],function(require){require("er/controller").registerAction([{type:"rds/account/Edit",path:"/rds/account/edit"},{type:"rds/account/Create",path:"/rds/account/create"},{type:"rds/account/Updatepassword",path:"/rds/account/updatepassword"},{type:"rds/account/List",path:"/rds/account/list"}]);return{}}),define("rds/account/Create",["require","bat-ria/mvc/FormAction","underscore","er/util","../config","../helper","./CreateModel","./CreateView"],function(require){function e(){n.apply(this,arguments)}function t(e){var t=this.model.get("instance"),n="rdsproxy"===t.instanceType?t.sourceInstanceId:t.instanceId,s=this.view,o=s.get("table"),c=s.get("accountName"),l=s.get("password"),d=s.get("password2"),u=s.get("remark"),p=u&&i.trim(s.get("remark").getValue()),m=[],h=[];if(h.push(c.validate()),h.push(l.validate()),h.push(d.validate()),!(i.indexOf(h,!1)>=0))if(l.getValue()===d.getValue())if(u&&p.replace(/([^\x00-\xff])/g,"$1$1$1").length>256)s.get("remark").showValidationMessage("invalid","备注说明不符合规则：最多256个字符（一个汉字等于三个字符）");else{var g=0;if(o)for(g=0;g<o.datasource.length;g++)o.datasource[g].authType&&m.push({dbName:o.datasource[g].dbName,authType:o.datasource[g].authType});var f={accountName:i.trim(c.getValue()),password:l.getValue(),superUserFlag:this.model.get("accountType")||"common"};"postgresql"!==t.engine&&i.extend(f,{remark:p,databasePrivileges:m}),f.type=this.model.get("instance").isRdsproxy?"rdsproxy":"onlyMaster",r.rdsCreateAccount({instanceId:n,account:f}).then(a.bind(function(){this.redirect("#/rds/account/list~instanceId="+this.model.get("instanceId")+"&rdsType="+this.model.get("rdsType"))},this)).fail(a.bind(function(e){this.view.showErrorMessage(e.field)},this))}else d.showValidationMessage("invalid","两次输入的密码不一致")}var n=require("bat-ria/mvc/FormAction"),i=require("underscore"),a=require("er/util"),r=require("../config").api,s=require("../helper");return e.prototype.initBehavior=function(){n.prototype.initBehavior.apply(this,arguments),s.handleDetailPublicEvent(this),this.view.on("submit",t,this),this.view.on("cancel",function(){this.redirect("#/rds/account/list~instanceId="+this.model.get("instanceId")+"&rdsType="+this.model.get("rdsType"))},this)},e.prototype.modelType=require("./CreateModel"),e.prototype.viewType=require("./CreateView"),require("er/util").inherits(e,n),e}),define("rds/account/create.tpl",[],function(){return'\x3c!-- target: TPL_rds_account_create --\x3e\r\n<div class="rds-account-create rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: other_link_wrapper --\x3e\r\n            <a href="#/rds/account/list~instanceId=${instanceId}&rdsType=${rdsType}">账号管理</a>\r\n            <span class="divider">/</span>\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e创建账号\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n        \x3c!-- <div class="form-container detail-content"> --\x3e\r\n            <div class="ui-tab-content">\r\n                <form class="create-account-form" data-ui-type="Form" data-ui-id="form">\r\n                    <div class="form-data-body">\r\n\r\n                        <div class="form-row">\r\n                            <label class="required-label">\x3c!-- if:${accountType} === \'super\' --\x3e高权限账号：\x3c!-- else --\x3e数据库账号：\x3c!-- /if --\x3e</label>\r\n                            <div class="form-value">\r\n                                <p>\r\n                                    <input data-ui-type="TextBox"\r\n                                           data-ui-id="accountName"\r\n                                           data-ui-mode="text"\r\n                                           class="account-name-input" />\r\n                                    <label data-ui-type="Validity"\r\n                                           data-ui-id="accountNameValidity"\r\n                                           class="account-name-validity"></label>\r\n                                </p>\r\n                                <p class="tip">由小写字母、数字、下划线组成、字母开头，字母或数字结尾，最长16个字符</p>\r\n                            </div>\r\n                        </div>\r\n                        \x3c!-- if: ${instance.engine} !== \'postgresql\' && ${accountType} !== \'super\' --\x3e\r\n                        <div class="form-row">\r\n                            <label>数据库授权：</label>\r\n                            <div class="form-value">\r\n                                \x3c!-- if: ${database}.length > 0 --\x3e\r\n                                <div class="table-wrap">\r\n                                    <div data-ui-type="Table"\r\n                                         data-ui-id="table"\r\n                                         data-ui-select="@selectMode"\r\n                                         data-ui-extension-tip-type="TableTip"\r\n                                         data-ui-extension-tableradio-type="TableRadio"\r\n                                         class="database-table">\r\n                                    </div>\r\n                                </div>\r\n                                \x3c!-- else --\x3e\r\n                                <p>暂无数据库，去<a href="#/rds/database/create~instanceId=${databaseInstanceId}&rdsType=${rdsType}">创建数据库</a></p>\r\n                                \x3c!-- /if --\x3e\r\n                            </div>\r\n                        </div>\r\n                        \x3c!-- /if --\x3e\r\n                        <div class="form-row">\r\n                            <label class="required-label">密码：</label>\r\n                            <div class="form-value">\r\n                                <p>\r\n                                    <input data-ui-type="TextBox"\r\n                                           data-ui-id="password"\r\n                                           data-ui-mode="text"\r\n                                           class="password-input"\r\n                                           type="password" />\r\n                                    <label data-ui-type="Validity"\r\n                                           data-ui-id="passwordValidity"\r\n                                           class="password-validity"></label>\r\n                                </p>\r\n                                <p class="tip">由字母、数字或下划线组成，长度6～32位</p>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div class="form-row">\r\n                            <label class="required-label">确认密码：</label>\r\n                            <div class="form-value">\r\n                                <p>\r\n                                    <input data-ui-type="TextBox"\r\n                                           data-ui-id="password2"\r\n                                           data-ui-mode="text"\r\n                                           class="password-input"\r\n                                           type="password" />\r\n                                    <label data-ui-type="Validity"\r\n                                           data-ui-id="password2Validity"\r\n                                           class="password-validity"></label>\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                        \x3c!-- if: ${instance.engine} !== \'postgresql\' --\x3e\r\n                        <div class="form-row">\r\n                            <label>备注说明：</label>\r\n                            <div class="form-value">\r\n                                <p>\r\n                                    <textarea  data-ui-type="TextBox"\r\n                                               data-ui-id="remark"\r\n                                               data-ui-child-name="password"\r\n                                               data-ui-name="remark"></textarea>\r\n                                <p>\r\n                                <p class="tip">最多256个字符（一个汉字等于三个字符）</p>\r\n                                <p>\r\n                                    <label data-ui-type="Validity"\r\n                                           data-ui-id="remarkValidity"\r\n                                           class="remark-validity"></label>\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                        \x3c!-- /if --\x3e\r\n                        <div class="form-row">\r\n                            <div class="form-value">\r\n                                <button data-ui-id="submit-button" data-ui-type="Button" data-ui-skin="ok">确认</button>\r\n                                <a data-ui-id="cancel-button" data-ui-type="Button" data-ui-skin="cancel">取消</a>\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/account/CreateModel",["require","bat-ria/mvc/FormModel","../config","../helper","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/FormModel"),n=require("../config").api,i=require("../helper");return e.prototype.datasource=[{instance:function(e){return n.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return i.handlePublicData(e),e})},isWhiteAccount:function(){return n.rdsIsWhiteAccount()},tab:function(){return{account:"ui-tab-item-active"}}},{database:function(e){var t=e.get("instanceId");return"rdsproxy"===e.get("instance").instanceType&&(t=e.get("instance").sourceInstanceId),e.set("databaseInstanceId",t),n.rdsDatabaseList({instanceId:t,order:"desc",orderBy:"dbName",pageNo:1}).then(function(e){for(var t=e.result,n=0;n<t.length;n++)delete t[n].accountPrivileges,delete t[n].remark,t[n].name=t[n].dbName;return t})}}],e.prototype.prepare=function(){var e="super"===this.get("accountType")?"rdsroot":"";this.set("defaultAccountName",e)},e.prototype.defaultArgs={},require("er/util").inherits(e,t),e}),define("rds/account/CreateView",["require","bat-ria/tpl!./create.tpl","bat-ria/mvc/FormView","underscore","../config","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./create.tpl");var t=require("bat-ria/mvc/FormView"),n=require("underscore"),i=require("../config").reservedKeywords;e.prototype.template="TPL_rds_account_create";var a=[{title:"数据库名称",content:"dbName"},{title:"  权限设置  ",content:function(e){return'<label><input type="radio" name="'+n.escape(e.dbName)+'" value="readOnly" />只读</label><label><input type="radio" name="'+n.escape(e.dbName)+'" value="readWrite" />读写</label>'}}];e.prototype.enterDocument=function(){t.prototype.enterDocument.apply(this,arguments),"common"===this.model.get("accountType")?i.push("root"):i=n.reject(i,function(e){return"root"===e})},e.prototype.uiProperties={accountName:{value:"@defaultAccountName",required:"required",requiredErrorMessage:"账号名称为必填",pattern:/^[a-z][a-z\d_]{0,14}[a-z\d]$/,patternErrorMessage:"账号名称不符合规则",custom:function(e){return!n.contains(i,e)},customErrorMessage:"账号名不能为保留关键字",validityLabel:"accountNameValidity"},password:{required:"required",requiredErrorMessage:"密码为必填",pattern:/^[a-zA-Z\d_]{6,32}$/,patternErrorMessage:"密码不符合规则",validityLabel:"passwordValidity"},password2:{required:"required",requiredErrorMessage:"确认密码为必填",pattern:/^[a-zA-Z\d_]{6,32}$/,patternErrorMessage:"确认密码不符合规则",validityLabel:"password2Validity"},table:{datasource:"@database",fields:a,width:400,select:"multi",defaultRadioValue:"*readOnly"},remark:{width:580,height:100}},e.prototype.uiEvents={"cancel-button:click":function(){this.fire("cancel")}};var r={accountName:"accountName",password:"password",remark:"remark"};return e.prototype.showErrorMessage=function(e){for(var t in e)e.hasOwnProperty(t)&&this.get(r[t]).showValidationMessage("invalid",e[t])},require("er/util").inherits(e,t),e}),define("rds/account/Edit",["require","bat-ria/mvc/FormAction","er/util","er/URL","../config","../helper","./EditModel","./EditView"],function(require){function e(){n.apply(this,arguments)}function t(e){var t=this.view.get("table"),n=[],s=0,o=this.model.get("instance"),c="rdsproxy"===o.instanceType?o.sourceInstanceId:o.instanceId;if(t)for(s=0;s<t.datasource.length;s++)t.datasource[s].authType&&n.push({dbName:t.datasource[s].dbName,authType:t.datasource[s].authType});r.rdsUpdateAccountPermission({instanceId:c,accountName:this.model.get("account").accountName,ETag:this.model.get("account").ETag,databasePrivileges:n}).then(i.bind(function(){var e={instanceId:this.model.get("instanceId")};this.model.get("rdsType")&&(e.rdsType=this.model.get("rdsType")),this.redirect(a.withQuery("#/rds/account/list",e))},this))}var n=require("bat-ria/mvc/FormAction"),i=require("er/util"),a=require("er/URL"),r=require("../config").api,s=require("../helper");return e.prototype.initBehavior=function(){n.prototype.initBehavior.apply(this,arguments),s.handleDetailPublicEvent(this),this.view.showCurrentPrivileges.call(this.view,this.model.get("account").accountName),this.view.on("submit",t,this),this.view.on("cancel",function(){var e={instanceId:this.model.get("instanceId")};this.model.get("rdsType")&&(e.rdsType=this.model.get("rdsType")),this.redirect(a.withQuery("#/rds/account/list",e))},this)},e.prototype.modelType=require("./EditModel"),e.prototype.viewType=require("./EditView"),require("er/util").inherits(e,n),e}),define("rds/account/edit.tpl",[],function(){return'\x3c!-- target: TPL_rds_account_edit --\x3e\r\n<div class="rds-account-edit rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: other_link_wrapper --\x3e\r\n            <a href="#/rds/account/list~instanceId=${instanceId}&rdsType=${rdsType}">账号管理</a>\r\n            <span class="divider">/</span>\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e权限修改\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n        \x3c!-- <div class="form-container detail-content"> --\x3e\r\n            <div class="ui-tab-content">\r\n                <form class="create-account-form"\r\n                      data-ui-type="Form"\r\n                      data-ui-id="form">\r\n\r\n                    <div class="form-row">\r\n                        <label>数据库账号：</label>\r\n                        <div class="form-value">\r\n                            <span class="account-name">${account.accountName}</span>\r\n                        </div>\r\n                    </div>\r\n                    <div class="form-row">\r\n                        <label>数据库授权：</label>\r\n                        <div class="form-value">\r\n                            \x3c!-- if: ${database}.length > 0 --\x3e\r\n                            <div class="table-wrap">\r\n                                <div data-ui-type="Table"\r\n                                     data-ui-id="table"\r\n                                     data-ui-select="@selectMode"\r\n                                     data-ui-extension-tip-type="TableTip"\r\n                                     data-ui-extension-tableradio-type="TableRadio"\r\n                                     class="database-table">\r\n                                </div>\r\n                            </div>\r\n                            \x3c!-- else --\x3e\r\n                            <p>暂无数据库，去<a href="#/rds/database/create~instanceId=${databaseInstanceId}">创建数据库</a></p>\r\n                            \x3c!-- /if --\x3e\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div class="form-row">\r\n                        <label>备注说明：</label>\r\n                        <div class="form-value">\r\n                            <p class="account-remark">${account.remark}</p>\r\n                        </div>\r\n                    </div>\r\n                    <div class="form-row">\r\n                        <div class="form-value">\r\n                            <button data-ui-id="submit-button" data-ui-type="Button" data-ui-skin="ok">确认</button>\r\n                            <a data-ui-id="cancel-button" data-ui-type="Button" data-ui-skin="cancel">取消</a>\r\n                        </div>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/account/EditModel",["require","bat-ria/mvc/FormModel","../config","../helper","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/FormModel"),n=require("../config").api,i=require("../helper");return e.prototype.datasource=[{tab:function(){return{account:"ui-tab-item-active"}},instance:function(e){return n.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return i.handlePublicData(e),e})},isWhiteAccount:function(){return n.rdsIsWhiteAccount()},account:function(e){return n.rdsAccountDetail({instanceId:e.get("instanceId"),accountName:e.get("accountName")}).then(function(e){return/^\s*$/.test(e.remark)&&(e.remark="暂无"),e})}},{database:function(e){var t=e.get("instanceId");return"rdsproxy"===e.get("instance").instanceType&&(t=e.get("instance").sourceInstanceId),e.set("databaseInstanceId",t),n.rdsDatabaseList({instanceId:t,order:"desc",orderBy:"dbName",pageNo:1}).then(function(e){for(var t=e.result,n=0;n<t.length;n++)delete t[n].remark,t[n].name=t[n].dbName;return t})}}],e.prototype.defaultArgs={},require("er/util").inherits(e,t),e}),define("rds/account/EditView",["require","bat-ria/tpl!./edit.tpl","bat-ria/mvc/FormView","underscore","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./edit.tpl");var t=require("bat-ria/mvc/FormView"),n=require("underscore");e.prototype.template="TPL_rds_account_edit";var i=[{title:"数据库名称",content:"dbName"},{title:"权限设置",content:function(e){return'<label><input type="radio" name="'+n.escape(e.dbName)+'" value="readOnly" />只读</label><label><input type="radio" name="'+n.escape(e.dbName)+'" value="readWrite" />读写</label>'}}];return e.prototype.uiProperties={table:{datasource:"@database",fields:i,width:400,select:"multi",defaultRadioValue:"*readOnly"}},e.prototype.uiEvents={"cancel-button:click":function(){this.fire("cancel")}},e.prototype.showCurrentPrivileges=function(e){this.get("table")&&this.get("table").setCurrentAccountPrivileges(e)},require("er/util").inherits(e,t),e}),define("rds/account/List",["require","bat-ria/mvc/BaseAction","er/util","er/URL","underscore","esui/lib","../config","../helper","./ListModel","./ListView","../util"],function(require){function e(){o.apply(this,arguments)}function t(){this.reload()}function n(e){var t=this,n=this.model.get("instance");"super"===e.accountType&&"common"===n.superUserFlag?this.view.waitConfirm({title:"首次创建super账号",content:"首次创建高权限账号后，用户可使用高权限账号通过命令行的方式管理账号和数据库，控制台创建普通账号和数据库时仍可以进行授权操作，但账号管理及数据库管理列表页面将不再展示账号与数据库之间的关联",width:700}).then(function(){t.redirect(l.withQuery("/rds/account/create",{instanceId:n.instanceId,accountType:e.accountType,rdsType:t.model.get("rdsType")}))}):this.redirect(l.withQuery("/rds/account/create",{instanceId:n.instanceId,accountType:e.accountType,rdsType:t.model.get("rdsType")}))}function i(e){var t=e.value,n=e.target.model.get("tableData"),i=n[e.rowIndex].accountName,a=n[e.rowIndex].remark;t!==a&&p.rdsUpdateAccountDesc({instanceId:this.model.get("accountInstanceId"),accountName:i,remark:t}).then(c.bind(function(){this.view.get("table").setCellText('<span class="account-remark">'+require("../util").encodeHTML(t)+'</span><span class="ui-table-cell-editentry"data-row="'+e.rowIndex+'" data-col="'+e.columnIndex+'"></span>',e.rowIndex,e.columnIndex),n[e.rowIndex].remark=t},this)).fail(function(t){e.target.get("table").showEditError(t.field.remark)})}function a(e){var t=this,n=this.view.get("table").datasource[e.itemIndex];this.view.waitConfirm({title:document.title,content:"账号删除后，该账号相关操作会失败，确定删除吗？",width:500}).then(function(){p.rdsDeleteAccount({instanceId:t.model.get("accountInstanceId"),accountName:n.accountName}).then(t.reload)})}function r(e){var t=this.view.get("table").datasource[e.itemIndex];this.view.waitActionDialog({title:"重置密码",width:500,needFoot:!0,url:"/rds/account/updatepassword",actionOptions:{accountName:t.accountName,instanceId:this.model.get("accountInstanceId")}}).then(c.bind(function(e){var t=e.target.getAction(),n=e.target.getChild("foot").getChild("btnOk"),i=e.target.getChild("foot").getChild("btnCancel"),a=e.target,r=function(e){a.dispose()};n.on("click",function(){t.submit(r)}),i.on("click",function(){a.dispose()}),a.resize()},this))}function s(e){var t=this.view.get("table").datasource[e.itemIndex].accountName,n=this.model.get("instance").instanceId,i=this.model.get("rdsType"),a={instanceId:n,accountName:t};i&&(a.rdsType=i),this.redirect(l.withQuery("#/rds/account/edit",a))}var o=require("bat-ria/mvc/BaseAction"),c=require("er/util"),l=require("er/URL"),d=require("underscore"),u=require("esui/lib"),p=require("../config").api,m=require("../helper");return e.prototype.initBehavior=function(){o.prototype.initBehavior.apply(this,arguments),m.handleDetailPublicEvent(this),function(e){d.each(e.datasource,function(t,n){var i=e.getRow(n),a=u.g(e.getBodyCellId(n,0)),r=u.getChildren(a)[0].children[0].children[0];u.hasClass(r,"invaild-label")&&u.addClass(i,"invaild-row")})}(this.view.get("table")),this.view.on("refreshAccountList",t,this),this.view.on("saveEdit",i,this),this.view.on("deleteAccount",a,this),this.view.on("updatePassword",r,this),this.view.on("updatePermission",s,this),this.view.on("createAccount",n,this);var e=this.model.get("instance");if("postgresql"===e.engine&&this.model.get("tableData").length>0&&this.view.get("createAccount").disable(),this.view.get("createSuperAccount")){var c=!!d.find(this.model.get("tableData"),function(e){return"super"===e.superUserFlag});"MySQL"===e.engine&&c&&this.view.get("createSuperAccount").disable()}},e.prototype.modelType=require("./ListModel"),e.prototype.viewType=require("./ListView"),require("er/util").inherits(e,o),e}),define("rds/account/list.tpl",[],function(){return'\x3c!-- target: TPL_rds_account_list --\x3e\r\n<div class="rds-account-list rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e账号管理\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                <div class="table-full-wrap">\r\n                    \x3c!-- if: ${instance.isRdsproxy} --\x3e\r\n                    <div class="ui-row">\r\n                        <div class="tip-grey">注：连接到RDS代理实例，需使用代理实例专有账号、密码；创建代理实例专有账号的同时，将自动将该账号同步到主实例</div>\r\n                    </div>\r\n                    \x3c!-- /if --\x3e\r\n                    <div class="ui-row">\r\n                        \x3c!--if: ${instance.readOnly} --\x3e\r\n                        <a href="#/rds/account/list~instanceId=${instance.sourceInstanceId}"\r\n                            class="ui-ctrl ui-button">返回主实例账号管理</a>\r\n                        \x3c!-- elif: ${instance.isRdsproxy} --\x3e\r\n                        <button data-ui-type="Button" data-ui-id="createAccount"\r\n                                data-ui-skin="create">创建代理实例专有账号</button>\r\n                        <a href="#/rds/account/list~instanceId=${instance.sourceInstanceId}"\r\n                            class="ui-ctrl ui-button">返回主实例账号管理</a>\r\n                        \x3c!-- elif: ${instance.engine} === \'postgresql\' --\x3e\r\n                        <button data-ui-type="Button" data-ui-id="createAccount"\r\n                                data-ui-skin="create">创建管理员帐号</button>\r\n                        \x3c!-- elif: ${instance.engine} === \'MySQL\' --\x3e\r\n                        <button data-ui-type="Button" data-ui-id="createAccount"\r\n                                data-ui-skin="create">创建账号</button>\r\n                        <button data-ui-type="Button" data-ui-id="createSuperAccount"\r\n                                data-ui-skin="create">创建super账号</button>\r\n                        <a class="help-link" target="_blank" href="https://cloud.baidu.com/doc/RDS/GettingStarted.html#.E7.AE.A1.E7.90.86.E9.AB.98.E6.9D.83.E9.99.90.E8.B4.A6.E5.8F.B7\r\n"><i class="iconfont icon-link"></i>帮助文档</a>\r\n                        \x3c!-- else --\x3e\r\n                        <button data-ui-type="Button" data-ui-id="createAccount"\r\n                                data-ui-skin="create">创建账号</button>\r\n                        \x3c!--/if--\x3e\r\n                        <button data-ui-type="Button" data-ui-id="refreshAccountList"\r\n                        data-ui-skin="refresh" class="refresh-button"></button>\r\n                    </div>\r\n                    \x3c!-- import: listEditableTableWithCommand --\x3e\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/account/ListModel",["require","bat-ria/mvc/BaseModel","underscore","../config","../helper","../tips","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("underscore"),i=require("../config").api,a=require("../helper");return e.prototype.datasource=[{tips:function(){return require("../tips")},instance:function(e){return i.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return a.handlePublicData(e),e})},isWhiteAccount:function(){return i.rdsIsWhiteAccount()},tab:function(){return{account:"ui-tab-item-active"}}},{sourceInstance:function(e){var t=e.get("instance").sourceInstanceId;return t?i.rdsInstanceDetail({instanceId:t}):null}},{tableData:function(e){var t=e.get("instance").engine,a=e.get("instance").instanceType,r=e.get("sourceInstance")?"super"===e.get("sourceInstance").superUserFlag:"super"===e.get("instance").superUserFlag;return e.set("isSuperAccount",r),i.rdsAccountList({instanceId:e.get("instanceId"),order:"desc",orderBy:"accountName",pageNo:1}).then(function(e){n.each(e.result,function(e){e.instanceType=a,e.engine=t,e.isSuperAccount=r});var i=n.sortBy(e.result,function(e){return e.type});return"rdsproxy"===a?i.reverse():i})}}],e.prototype.defaultArgs={order:"desc",orderBy:"accountName"},e.prototype.prepare=function(){a.getDelayInfo(this);var e=this.get("instance"),t="rdsproxy"===e.instanceType?e.sourceInstanceId:e.instanceId;this.set("accountInstanceId",t)},require("er/util").inherits(e,t),e}),define("rds/account/ListView",["require","bat-ria/tpl!./list.tpl","bat-ria/mvc/BaseView","underscore","common/util/tableUtil","../config","../enums","../util","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./list.tpl");var t=require("bat-ria/mvc/BaseView"),n=require("underscore"),i=require("common/util/tableUtil"),a=require("../config"),r=require("../enums"),s=!0;e.prototype.template="TPL_rds_account_list";var o=[{title:"账号",width:50,content:function(e){return"rdsproxy"===e.type&&"rdsproxy"===e.instanceType||"onlyMaster"===e.type&&"rdsproxy"!==e.instanceType?n.escape(e.accountName):'<span class="invaild-label">'+n.escape(e.accountName)+"</span>"}},{title:"账号状态",width:20,content:function(e){return'<span class="status '+a.STAUTS_CLASS[e.accountStatus]+'">'+(r.ACCOUNT_STATUS.getTextFromValue(e.accountStatus)||e.accountStatus)+"</span>"}},{title:"账号类型",width:30,content:function(e){return"postgresql"===e.engine?"管理员帐号":r.ACCOUNT_TYPE.getTextFromValue(e.superUserFlag)||r.ACCOUNT_TYPE.getTextFromValue(e.type)}},{title:"所属数据库",width:50,content:function(e){for(var t="",i="",a=0;a<e.databasePrivileges.length;a++)i="readOnly"===e.databasePrivileges[a].authType?"只读":"读写",t+=n.escape(e.databasePrivileges[a].dbName)+"&nbsp;"+n.escape(i)+"<br />";return t}},{title:"描述",width:80,content:function(e,t,n){var i="rdsproxy"===e.type&&"rdsproxy"===e.instanceType||"onlyMaster"===e.type&&"rdsproxy"!==e.instanceType,a=s&&i?'<span class="ui-table-cell-editentry"data-row="'+t+'" data-col="'+n+'"></span>':"";return'<span class="account-remark">'+require("../util").encodeHTML(e.remark)+"</span>"+a},editable:function(e){return s},editContent:function(e){return e.remark},editRules:{custom:function(e){return e.replace(/([^\x00-\xff])/g,"$1$1$1").length<=256},customErrorMessage:"备注说明不符合规则：最多256个字符（一个汉字等于三个字符）"}},{title:"操作",width:70,content:function(e,t){var n="rdsproxy"===e.type&&"rdsproxy"===e.instanceType||"onlyMaster"===e.type&&"rdsproxy"!==e.instanceType,i="";return s&&n?(i='<span class="oprations"><a data-command="updatePassword" data-command-args="'+t+'">修改密码</a>',e.isSuperAccount||"postgresql"===e.engine||(i+='<a data-command="updatePermission" data-command-args="'+t+'">修改权限</a>'),i+='<a data-command="deleteAccount" data-command-args="'+t+'">删除</a></span>'):(i='<span class="oprations oprations-disabled"><a>修改密码</a>',e.isSuperAccount||"postgresql"===e.engine||(i+="<a>修改权限</a>"),i+="<a>删除</a></span>")}}];return e.prototype.getUIProperties=function(){var e=n.clone(o);return this.model.get("isSuperAccount")&&e.splice(3,1),"postgresql"===this.model.get("instance").engine&&e.splice(3,2),{table:i.tableProperty(e,{datasource:"@tableData",select:"",editable:1})}},e.prototype.uiEvents={"table:saveedit":function(e){this.fire("saveEdit",e)},"table:command":function(e){s&&this.fire(e.name,{itemIndex:+e.args})},"refreshAccountList:click":function(){this.fire("refreshAccountList")},"createAccount:click":function(){this.fire("createAccount",{accountType:"common"})},"createSuperAccount:click":function(){this.fire("createAccount",{accountType:"super"})}},e.prototype.enterDocument=function(){var e=this.model.get("instance"),i=n.without(a.oprationDisableStatus,"migrating","backuping"),r=n.contains(i,e.instanceStatus)||e.readOnly;s=!r,t.prototype.enterDocument.call(this,arguments);var o=this.get("createAccount"),c=this.get("createSuperAccount");r&&(o&&o.disable(),c&&c.disable())},require("er/util").inherits(e,t),e}),define("rds/account/Updatepassword",["require","bat-ria/mvc/FormAction","underscore","../config","er/util","./UpdatepasswordModel","./UpdatepasswordView"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/FormAction"),n=require("underscore"),i=require("../config").api,a=require("er/util");return e.prototype.modelType=require("./UpdatepasswordModel"),e.prototype.viewType=require("./UpdatepasswordView"),e.prototype.submit=function(e,t){var r=this.view.get("updatePasswordForm"),s=r.getData(),o=n.trim(s.password),c=n.trim(s.password2);r.validate()&&(o===c?i.rdsUpdateAccountPassword({instanceId:this.model.get("instanceId"),accountName:this.model.get("account").accountName,password:o}).then(function(){e()}).fail(a.bind(function(e){this.view.showErrorMessage(e.field)},this)):this.view.get("password2Input").showValidationMessage("invalid","两次输入的密码不相同"))},require("er/util").inherits(e,t),e}),define("rds/account/updatepassword.tpl",[],function(){return'\x3c!-- target: TPL_rds_account_updatepassword --\x3e\r\n<div class="rds-account-updatepassword">\r\n    <form class="update-password-form"\r\n        data-ui-type="Form"\r\n        data-ui-id="updatePasswordForm">\r\n\r\n        <div class="form-data-body">\r\n\r\n            <div class="form-row">\r\n                <label>账号：</label>\r\n                <div class="form-value"><span class="account-name">${account.accountName}</span></div>\r\n            </div>\r\n\r\n            <div class="form-row">\r\n                <label>新密码：<i>*</i></label>\r\n                <div class="form-value">\r\n                    <p>\r\n                        <input data-ui-type="TextBox"\r\n                               data-ui-id="passwordInput"\r\n                               data-ui-child-name="password"\r\n                               data-ui-name="password"\r\n                               type="password"\r\n                               autocomplete="off" />\r\n                        <label data-ui-type="Validity"\r\n                               data-ui-id="passwordValidity"\r\n                               class="password-validity"></label>\r\n                    <p>\r\n                    <p class="tip">由字母、数字或下划线组成，长度6～32位</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div class="form-row">\r\n                <label>确认新密码：<i>*</i></label>\r\n                <div class="form-value">\r\n                    <p>\r\n                        <input data-ui-type="TextBox"\r\n                               data-ui-id="password2Input"\r\n                               data-ui-child-name="password2"\r\n                               data-ui-name="password2"\r\n                               type="password" />\r\n                        <label data-ui-type="Validity"\r\n                               data-ui-id="password2Validity"\r\n                               class="password2-validity"></label>\r\n                    <p>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </form>\r\n</div>\r\n\r\n\x3c!-- target: TPL_rds_account_updatepassword_child --\x3e\r\n\x3c!-- import: TPL_rds_account_updatepassword --\x3e\r\n'}),define("rds/account/UpdatepasswordModel",["require","bat-ria/mvc/FormModel","common/user","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/FormModel");return e.prototype.datasource={account:function(e){return{accountName:e.get("accountName")}},instanceId:function(e){return e.get("instanceId")},userInfo:function(){return require("common/user").visitor}},e.prototype.defaultArgs={},require("er/util").inherits(e,t),e}),define("rds/account/UpdatepasswordView",["require","bat-ria/tpl!./updatepassword.tpl","bat-ria/mvc/FormView","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./updatepassword.tpl");var t=require("bat-ria/mvc/FormView");e.prototype.template="TPL_rds_account_updatepassword",e.prototype.uiProperties={passwordInput:{width:160,required:"required",requiredErrorMessage:"密码为必填",pattern:/^[a-zA-Z\d_]{6,32}$/,patternErrorMessage:"密码不符合规则",validityLabel:"passwordValidity"},password2Input:{width:160,required:"required",requiredErrorMessage:"密码为必填",pattern:/^[a-zA-Z\d_]{6,32}$/,patternErrorMessage:"密码不符合规则",validityLabel:"password2Validity"}},e.prototype.uiEvents={};var n={password:"passwordInput"};return e.prototype.showErrorMessage=function(e){for(var t in e)e.hasOwnProperty(t)&&this.get(n[t]).showValidationMessage("invalid",e[t])},require("er/util").inherits(e,t),e}),define("rds/argument/config",["require","er/controller"],function(require){require("er/controller").registerAction([{type:"rds/argument/Edit",path:"/rds/argument/edit"},{type:"rds/argument/History",path:"/rds/argument/history"},{type:"rds/argument/List",path:"/rds/argument/list"}]);return{editTypeMap:{INTEGER:"integer",STRING:"string",SET:"set<string>"}}}),define("rds/argument/Edit",["require","bat-ria/mvc/BaseAction","etpl","./config","underscore","./EditModel","./EditView","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseAction"),n=require("etpl"),i=require("./config"),a=require("underscore");return e.prototype.initBehavior=function(){t.prototype.initBehavior.apply(this,arguments);var e=this.model.store;switch(e.type){case i.editTypeMap.INTEGER:(function(e){var t=n.getRenderer("TPL_rds_argument_range")(e);this.view.get("editPanel").setContent(t)}).call(this,e);break;case i.editTypeMap.STRING:(function(e){var t=n.getRenderer("TPL_rds_argument_enums")(e);this.view.get("editPanel").setContent(t);var i=this.view.get("modifySelect"),r=e.allowedValues.split(","),s=a.map(r,function(e){return{name:e,value:e}}),o=a.indexOf(r,e.value);i.updateDatasource(s),i.set("selectedIndex",o||0)}).call(this,e);break;case i.editTypeMap.SET:(function(e){e.values=e.allowedValues.replace(/\s/g,"").split(",");var t=n.getRenderer("TPL_rds_argument_set")(e);this.view.get("editPanel").setContent(t),this.view.get("modifyCheckbox").setRawValue(e.value.split(","))}).call(this,e)}},e.prototype.submit=function(){var e=this,t=e.view.get("modifyValue"),n=e.view.get("modifySelect"),i=e.view.get("modifyCheckbox"),r="";if(t){if(t.custom=function(n){var i=e.model.store.allowedValues.split("-");return t.customErrorMessage="参数值范围["+a.escape(e.model.store.allowedValues)+"]",i[1]-i[0]>=0?n-i[0]>=0&&n-i[1]<=0:n-i[1]>=0&&n-i[0]<=0},!t.validate())return;r=t.getValue()}return n&&(r=n.getValue()),i&&(r=i.getValue()),e.model.rdsArgumentModify({name:e.model.store.name,value:r,etag:e.model.store.etag,applyMethod:e.model.store.dynamic?"immediate":"pendingReboot"})},e.prototype.modelType=require("./EditModel"),e.prototype.viewType=require("./EditView"),require("er/util").inherits(e,t),e}),define("rds/argument/edit.tpl",[],function(){return'\x3c!-- target: TPL_rds_argument_edit --\x3e\r\n<div data-ui="id:editPanel;type:Panel" class="rds-argument-edit">\r\n</div>\r\n\r\n\x3c!-- target: TPL_rds_argument_edit_child --\x3e\r\n\x3c!-- import: TPL_rds_argument_edit --\x3e\r\n\r\n\x3c!-- target: TPL_rds_argument_range --\x3e\r\n<div class="modify-value-range">\r\n\t${name} ：\r\n\t<input data-ui-type="TextBox"\r\n\t    data-ui-id="modifyValue"\r\n\t    data-ui-mode="text"\r\n\t    value="${value}" />\r\n</div>\r\n\r\n\x3c!-- target: TPL_rds_argument_enums --\x3e\r\n<div class="modify-value-enums">\r\n\t${name}：\r\n\t<select data-ui="type:Select;id:modifySelect;" style="width:200px;">\r\n\t\t<option value=\'none\'>无可用值</option>\r\n\t</select>\r\n</div>\r\n\r\n\x3c!-- target: TPL_rds_argument_set --\x3e\r\n<div class="modify-value-set">\r\n\t<div data-ui-type="BoxGroup"\r\n         data-ui-id="modifyCheckbox"\r\n         data-ui-name="modifyCheckbox"\r\n         data-ui-orientation="vertical"\r\n         data-ui-box-type="checkbox" >\r\n           \t\x3c!--for: ${values} as ${item},${index} --\x3e\r\n                <input type="checkbox" id="modify${item}" name="modifyCheckbox" value="${item}"/>\r\n                <label for="modify${item}">${item}</label>\r\n            \x3c!--/for--\x3e\r\n        </ul>\r\n    </div>\r\n</div>\r\n'}),define("rds/argument/EditModel",["require","bat-ria/mvc/BaseModel","../config","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("../config").api;return e.prototype.datasource=null,e.prototype.rdsArgumentModify=function(e){var t={instanceId:this.store.instanceId,modified:[e]};return n.rdsArgumentModify(t)},require("er/util").inherits(e,t),e}),define("rds/argument/EditView",["require","bat-ria/tpl!./edit.tpl","bat-ria/mvc/FormView","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./edit.tpl");var t=require("bat-ria/mvc/FormView");return e.prototype.template="TPL_rds_argument_edit",e.prototype.uiProperties={modifyValue:{placeholder:"请输入参数值",required:"required",customErrorMessage:"参数值为整形数值"}},e.prototype.uiEvents={},require("er/util").inherits(e,t),e}),define("rds/argument/History",["require","bat-ria/mvc/BaseAction","../helper","./HistoryModel","./HistoryView","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseAction"),n=require("../helper");return e.prototype.modelType=require("./HistoryModel"),e.prototype.viewType=require("./HistoryView"),e.prototype.initBehavior=function(){t.prototype.initBehavior.apply(this,arguments),n.handleDetailPublicEvent(this),this.view.updatePageAndTable()},require("er/util").inherits(e,t),e}),define("rds/argument/history.tpl",[],function(){return'\x3c!-- target: TPL_rds_argument_history --\x3e\r\n<div class="rds-argument-history rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: other_link_wrapper --\x3e\r\n            <a href="#/rds/argument/list~instanceId=${instanceId}&rdsType=${rdsType}">参数设置</a>\r\n            <span class="divider">/</span>\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e修改历史\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n\t    \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                <div class="ui-smart-tab">\r\n                    <ul class="ui-tab-navigator">\r\n                        <li class="ui-tab-item">\r\n                            <a href="#/rds/argument/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">可修改参数</a>\r\n                        </li>\r\n                        <li class="ui-tab-item ui-tab-item-active">\r\n                            <a href="#/rds/argument/history~instanceId=${instance.instanceId}&rdsType=${rdsType}">修改历史</a>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n                <div class="table-full-wrap">\r\n                    \x3c!-- import: listEditableTableWithCommand --\x3e\r\n                    <div class="ui-row clearfix">\r\n                        \x3c!-- import: listPager --\x3e\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/argument/HistoryModel",["require","bat-ria/mvc/BaseModel","underscore","../config","../helper","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("underscore"),i=require("../config").api,a=require("../helper");return e.prototype.datasource={instance:function(e){return i.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return a.handlePublicData(e),e})},isWhiteAccount:function(){return i.rdsIsWhiteAccount()},tab:function(){return{argument:"ui-tab-item-active"}}},e.prototype.prepare=function(){a.getDelayInfo(this)},e.prototype.getHistoryList=function(e){var t={instanceId:this.get("instanceId")};return n.extend(t,e),i.rdsArgumentHistory(t).then(function(e){return n.each(e.result,function(e){"pendingReboot"===e.status&&(e.stateText="需重启"),"success"===e.status&&(e.stateText="生效"),"failed"===e.status&&(e.stateText="未生效")}),e})},require("er/util").inherits(e,t),e}),define("rds/argument/HistoryView",["require","bat-ria/tpl!./history.tpl","common/util/tableUtil","bat-ria/mvc/BaseView","common/util/timeUtil","underscore","esui/Tip","esui/lib","esui","er/util"],function(require){function e(){n.apply(this,arguments)}require("bat-ria/tpl!./history.tpl");var t=require("common/util/tableUtil"),n=require("bat-ria/mvc/BaseView"),i=require("common/util/timeUtil"),a=require("underscore");require("esui/Tip"),e.prototype.template="TPL_rds_argument_history";var r=[{title:"参数名",content:function(e,t,n){return e.name}},{title:"变更前参数",content:function(e,t,n){return e.beforeValue&&e.beforeValue.length>20?[a.escape(e.beforeValue).slice(0,20)+"...",'<span data-ui-type="Tip" ','data-ui-arrow="1" ','class="price-tip" ','data-ui-id="',e.name,'Tip" ','title="',e.beforeValue,'"></span>'].join(""):e.beforeValue||"-"}},{title:"变更后参数",content:function(e,t,n){return e.afterValue&&e.afterValue.length>20?[a.escape(e.afterValue).slice(0,20)+"...",'<span data-ui-type="Tip" ','data-ui-arrow="1" ','class="price-tip" ','data-ui-id="',e.name,'argTip" ','title="',e.afterValue,'"></span>'].join(""):e.afterValue||"-"}},{title:"变更是否生效",content:function(e,t,n){return e.stateText}},{title:"变更时间",content:function(e,t,n){return i.toTime(e.updateTime)}}];return e.prototype.uiProperties={table:t.tableProperty(r,{datasource:[],select:"",editable:!1}),pager:{pageSize:30}},e.prototype.updatePageAndTable=function(e){var t=this.get("pager"),n=this.get("table"),i={pageNo:t.page,pageSize:t.pageSize};a.extend(i,e),this.model.getHistoryList(i).then(function(e){n.setDatasource(e.result),t.set("page",e.pageNo),t.set("pageSize",e.pageSize),t.set("count",e.totalCount)})},e.prototype.uiEvents={pager:{pagechange:function(){this.updatePageAndTable()},pagesizechange:function(){this.updatePageAndTable()}},"refreshArgsConfigList:click":function(){this.updatePageAndTable({pageNo:1,pageSize:10})}},e.prototype.enterDocument=function(){n.prototype.enterDocument.apply(this,arguments);var e=this.get("table");e.on("bodyChange",function(){a.each(e.datasource,function(t,n){var i=require("esui/lib").g(e.getBodyCellId(n,1));require("esui").init(i),i=require("esui/lib").g(e.getBodyCellId(n,2)),require("esui").init(i)})}),e.setDatasource(e.datasource)},require("er/util").inherits(e,n),e}),define("rds/argument/List",["require","bat-ria/mvc/BaseAction","underscore","../config","../helper","./ListModel","./ListView","er/util"],function(require){function e(){a.apply(this,arguments)}function t(e){var t=this;i.call(this)?this.view.waitAlert("当前数据库状态不允许此操作"):t.view.waitActionDialog({title:"修改运行参数值",width:800,needFoot:!0,url:"/rds/argument/edit",actionOptions:e.item}).then(function(e){var n=e.target;n.resize();var i=n.getFoot().getChild("btnOk"),a=n.getFoot().getChild("btnCancel");i.on("click",function(e){n.getAction().submit().then(function(){n.dispose(),t.view.updateTableAndPager()})}),a.on("click",function(e){n.dispose()})})}function n(e){if(!i.call(this)){var t=this.view,n=e.item;return this.model.rdsArgumentModify({name:n.name,value:n.value,etag:n.etag,applyMethod:n.dynamic?"immediate":"pendingReboot"}).then(function(){t.updateTableAndPager()})}this.view.waitAlert("当前数据库状态不允许此操作")}function i(){return r.contains(s.oprationDisableStatus,this.model.get("instance").instanceStatus)}var a=require("bat-ria/mvc/BaseAction"),r=require("underscore"),s=require("../config"),o=require("../helper");return e.prototype.initBehavior=function(){a.prototype.initBehavior.apply(this,arguments),o.handleDetailPublicEvent(this),this.view.updateTableAndPager(),this.view.on("editArgument",t,this),this.view.on("resetArgumet",n,this)},e.prototype.modelType=require("./ListModel"),e.prototype.viewType=require("./ListView"),require("er/util").inherits(e,a),e}),define("rds/argument/list.tpl",[],function(){return'\x3c!-- target: TPL_rds_argument_list --\x3e\r\n<div class="rds-argument-list rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e参数设置\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                <button data-ui-type="Button" data-ui-id="refreshArgsConfigList" data-ui-skin="refresh" class="refresh-button"></button>\r\n                <span class="ui-group ui-search-group floated right margin-right">\r\n                    <input class="search-box" data-ui-type="TextBox" data-ui-id="keyword" data-ui-value="@keyword" placeholder="输入参数名进行搜索" />\r\n                    <button data-ui-type="Button" data-ui-id="searchBtn"></button>\r\n                </span>\r\n                <div class="ui-smart-tab">\r\n                    <ul class="ui-tab-navigator">\r\n                        <li class="ui-tab-item ui-tab-item-active">\r\n                            <a href="#/rds/argument/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">可修改参数</a>\r\n                        </li>\r\n                        <li class="ui-tab-item">\r\n                            <a href="#/rds/argument/history~instanceId=${instance.instanceId}&rdsType=${rdsType}">修改历史</a>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n                <div class="table-full-wrap">\r\n                    \x3c!-- import: listEditableTableWithCommand --\x3e\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/argument/ListModel",["require","bat-ria/mvc/BaseModel","underscore","../config","../helper","../tips","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("underscore"),i=require("../config").api,a=require("../helper");return e.prototype.datasource={tips:function(){return require("../tips")},instance:function(e){return i.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return a.handlePublicData(e),e})},isWhiteAccount:function(){return i.rdsIsWhiteAccount()},tab:function(){return{argument:"ui-tab-item-active"}}},e.prototype.prepare=function(){a.getDelayInfo(this)},e.prototype.getModifiedList=function(e){var t={instanceId:this.get("instanceId"),keyword:this.get("keyword")||""};return n.extend(t,e),i.rdsArgumentList(t)},e.prototype.rdsArgumentModify=function(e){var t={instanceId:this.get("instanceId"),modified:[e]};return i.rdsArgumentModify(t)},require("er/util").inherits(e,t),e}),define("rds/argument/ListView",["require","bat-ria/tpl!./list.tpl","common/util/tableUtil","bat-ria/mvc/BaseView","underscore","esui/Tip","etpl","esui/lib","esui","er/util"],function(require){function e(){n.apply(this,arguments)}require("bat-ria/tpl!./list.tpl");var t=require("common/util/tableUtil"),n=require("bat-ria/mvc/BaseView"),i=require("underscore");require("esui/Tip");var a=require("etpl");e.prototype.template="TPL_rds_argument_list";var r=[{title:"参数名",minWidth:200,content:function(e,t,n){return e.name}},{title:"参数值范围",minWidth:240,content:function(e,t,n){var i=e.allowedValues||"无";return i.length<=20?i:[i.slice(0,20)+"...",'<span data-ui-type="Tip" ','data-ui-arrow="1" ','class="price-tip" ','data-ui-id="',e.name,'Tip" ','data-ui-content="',"<span class='rds-args-tip'>",i,'</span>"></span>'].join("")}},{field:"value",minWidth:200,title:"运行参数值",content:function(e,t,n){var r='<span data-ui-type="Tip" data-ui-arrow="1" title="${value}"></span>',s=['<label class="view-label" ','data-command="editArgument" data-command-args="',t,'">编辑</label>','<label class="view-label" ',' data-command="resetArgumet" data-command-args="',t,'">恢复</label>'],o="当前值："+(e.value&&e.value.length>0?i.escape(e.value):i.escape(e.defaultValue)),c="";return o.length>=30&&(o=o.slice(0,30)+a.compile(r)(e)),e.pendingValue&&e.pendingValue.length>0&&(e.pendingValue.length>=30?o=e.pendingValue.slice(0,30)+a.compile(r)(e):c+="<br/>重启后："+i.escape(e.pendingValue)),e.modifiable&&(o+=s.slice(0,4).join(""),c+=c.length>0?s.slice(4,8).join(""):""),o+c}},{title:"是否需要重启",width:110,stable:!0,content:function(e,t,n){return e.dynamic?"否":"是"}},{title:"参数描述",minWidth:200,content:function(e,t,n){return i.escape(e.description)}}];return e.prototype.uiProperties={table:t.tableProperty(r,{datasource:[],select:""})},e.prototype.updateTableAndPager=function(){var e=this.get("table");this.model.getModifiedList().then(function(t){e.setDatasource(t.items)})},e.prototype.uiEvents={"table:command":function(e){var t=this.get("table").datasource[e.args];t.instanceId=this.model.get("instanceId"),this.fire(e.name,{item:t})},"refreshArgsConfigList:click":function(){this.updateTableAndPager()},"searchBtn:click":function(){var e=i.trim(this.get("keyword").getValue());this.model.set("keyword",e),this.updateTableAndPager()}},e.prototype.enterDocument=function(){n.prototype.enterDocument.apply(this,arguments);var e=this.get("table");e.on("bodyChange",function(){i.each(e.datasource,function(t,n){var i=require("esui/lib").g(e.getBodyCellId(n,1));require("esui").init(i),i=require("esui/lib").g(e.getBodyCellId(n,2)),require("esui").init(i)})}),e.setDatasource(e.datasource)},require("er/util").inherits(e,n),e}),define("rds/backup/config",["require","er/controller"],function(require){require("er/controller").registerAction([{type:"rds/backup/List",path:"/rds/backup/list"}]);return{}}),define("rds/backup/List",["require","bat-ria/mvc/BaseAction","er/util","underscore","er/URL","../config","../helper","./ListModel","./ListView"],function(require){function e(){r.apply(this,arguments)}function t(e){var t=this,n=this.view.get("table").datasource[e.itemIndex];this.view.waitConfirm({title:document.title,content:"RDS回滚后会覆盖数据，且无法恢复。同时回滚期间数据库服务会中断，确定回滚吗？",width:500}).then(function(){d.rdsRebaseBackup({instanceId:t.model.get("instance").instanceId,snapshotId:n.snapshotId}).then(t.reload)})}function n(e){var t=this.view.get("table").datasource[e.itemIndex],n=this.model.get("instance").instanceId;d.rdsBackupDownloadUrl({instanceId:n,snapshotId:t.snapshotId,downloadValidTime:30}).then(s.bind(function(e){this.view.waitActionDialog({title:"下载",width:800,needFoot:!0,url:"/rds/download",defaultFoot:'<div class="ok-button ui-dialog-ok-btn"data-ui="type:Button;id:btnFootOk;childName:btnOk;">直接下载</div><div data-ui="type:Button;id:btnFootCancel;childName:btnCancel;">取消</div>',actionOptions:{idKey:"snapshotId",instanceId:n,backupId:t.snapshotId,urlApi:d.rdsBackupDownloadUrl,downloadUrl:e.url,downloadExpires:e.downloadExpires}}).then(function(e){var t=e.target,n=t.getAction(),i=t.getChild("foot").getChild("btnOk"),a=t.getChild("foot").getChild("btnCancel");t.main.className+=" download-dialog",i.on("click",function(){n.download()}),a.on("click",function(){t.dispose()}),t.resize()})},this))}function i(){var e=this,t=this.model.get("instanceId");this.view.waitConfirm({title:"备份实例",content:"您确定要立即备份此实例吗？",width:500}).then(function(){d.rdsDoBackup({instanceId:t}).then(s.bind(e.reload,e))})}function a(){var e=this.model.get("instance").instanceId,t=this,n=this.model.get("instance");this.view.waitActionDialog({title:"设置备份周期",width:800,needFoot:!0,url:"/rds/settimepoint",defaultFoot:'<div class="ok-button ui-dialog-ok-btn"data-ui="type:Button;id:btnFootOk;childName:btnOk;">确定</div><div data-ui="type:Button;id:btnFootCancel;childName:btnCancel;">取消</div>',actionOptions:{instanceId:e,backupPolicy:this.model.get("backupPolicy"),isEnhanced:"enhanced"===n.applicationType||"raft"===n.instanceType}}).then(function(e){var n=e.target.getAction(),i=e.target.getChild("foot").getChild("btnOk"),a=e.target.getChild("foot").getChild("btnCancel"),r=e.target;i.on("click",function(){n.submit(function(){t.view.showToast("修改成功"),t.reload()})}),a.on("click",function(){r.dispose()}),r.resize()})}var r=require("bat-ria/mvc/BaseAction"),s=require("er/util"),o=require("underscore"),c=require("er/URL"),l=require("../config"),d=l.api,u=require("../helper");return e.prototype.initBehavior=function(){r.prototype.initBehavior.apply(this,arguments),u.handleDetailPublicEvent(this),this.view.on("rebase",t,this),this.view.on("download",n,this),this.view.on("backup",i,this),this.view.on("updatebackupPolicy",a,this),this.view.on("createClone",this.createClone,this),this.view.on("refresh",this.reload,this);var e=this.model.get("instance");o.contains(l.oprationDisableStatus,e.instanceStatus)&&(this.view.get("backupInstance").disable(),this.view.get("backupSetting").disable()),"postgresql"===e.engine&&this.view.get("backupSetting").disable()},e.prototype.modelType=require("./ListModel"),e.prototype.viewType=require("./ListView"),e.prototype.createClone=function(){this.redirect(c.withQuery("/rds/create",{instanceId:this.model.get("instanceId"),type:"clone"}))},require("er/util").inherits(e,r),e}),define("rds/backup/list.tpl",[],function(){return'\x3c!-- target: TPL_rds_backup_list --\x3e\r\n<div class="rds-backup-list rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e备份列表\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                \x3c!-- if: ${instance.engine} !== \'postgresql\' --\x3e\r\n                <div class="tip-grey">总备份存储量：${usedSpaceInMB} （免费赠送${freeSpaceInMB}备份存储空间）</div>\r\n                \x3c!-- /if --\x3e\r\n                <div class="table-full-wrap">\r\n                    <div class="ui-row">\r\n                        <button data-ui-id="backupInstance" data-ui-type="Button" class="backup-instance">手动备份</button>\r\n                        <button data-ui-id="backupSetting" data-ui-type="Button">自动备份设置</button>\r\n                        \x3c!-- if: ${instance.engine} === \'postgresql\' --\x3e\r\n                        <span data-ui-type="Tip" data-ui-content="${tips.rdsPgBackupTip}"></span>\r\n                        \x3c!-- /if --\x3e\r\n\r\n\r\n                        <button data-ui-type="Button" data-ui-id="refreshBtn" data-ui-skin="refresh"\r\n                        class="refresh-button"></button>\r\n                        \x3c!-- if: ${instance.engine} === \'MySQL\' --\x3e\r\n                        \x3c!-- if: !${instance.sourceInstanceId} && ${instance.instanceType} !== \'financial\' && ${rdsType} !== \'dcc\' --\x3e\r\n                        <button data-ui-id="createClone" class="float-right" data-ui-type="Button">克隆实例</button>\r\n                        \x3c!-- /if --\x3e\r\n                        <a target="_blank" href="https://cloud.baidu.com/doc/RDS/GettingStarted.html#.E4.B8.8B.E8.BD.BD.E5.A4.87.E4.BB.BD" class="float-right"><i class="iconfont icon-link font-12"></i>如何本地恢复备份</a>\r\n\r\n                        \x3c!-- /if --\x3e\r\n\r\n                    </div>\r\n                    \x3c!-- import: listTableWithCommand --\x3e\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/backup/ListModel",["require","bat-ria/mvc/BaseModel","../config","../helper","../tips","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("../config").api,i=require("../helper"),a=require("../tips");return e.prototype.datasource={tips:function(){return a},instance:function(e){return n.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(t){return i.handlePublicData(t),e.set("backupPolicy",t.backupPolicy),t})},isWhiteAccount:function(){return n.rdsIsWhiteAccount()},tab:function(){return{backup:"ui-tab-item-active"}},tableData:function(e){return n.rdsBackupList({instanceId:e.get("instanceId")}).then(function(t){var n=t.freeSpaceInMB>1024?parseInt(t.freeSpaceInMB/1024,10)+"GB":t.freeSpaceInMB+"MB",i=t.usedSpaceInMB>1024?parseInt(t.usedSpaceInMB/1024,10)+"GB":t.usedSpaceInMB+"MB";return e.set("freeSpaceInMB",n),e.set("usedSpaceInMB",i),t.page.result})}},require("er/util").inherits(e,t),e}),define("rds/backup/ListView",["require","bat-ria/tpl!./list.tpl","bat-ria/mvc/BaseView","common/util/tableUtil","moment","humanize","underscore","../config","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./list.tpl");var t=require("bat-ria/mvc/BaseView"),n=require("common/util/tableUtil"),i=require("moment"),a=require("humanize"),r=require("underscore"),s=require("../config"),o=!0;e.prototype.template="TPL_rds_backup_list";var c={creating:"创建中",available:"可用",deleting:"删除中",failed:"失败",CLASS:{creating:"warning",available:"normal",deleting:"warning",failed:"error"}},l={manual:"手动创建",automated:"自动创建"},d=[{title:"&nbsp;备份开始/持续时间&nbsp;",content:function(e){var t=i(e.snapshotStartTime).format("YYYY-MM-DD HH:mm:ss"),n=i(e.snapshotStartTime),a="";if(e.snapshotEndTime&&"available"===e.snapshotStatus){if((a=i(e.snapshotEndTime).diff(n,"minute"))>=60){var r=parseInt(a/60,10);a=r+"小时"+(a-60*r)+"分钟"}else a+="分钟"}else a="-";return t+"/"+a}},{title:"备份大小",content:function(e){return a.filesize(e.snapshotSizeInBytes)}},{title:"生成方式",content:function(e){return"物理备份"}},{title:"备份类型",content:function(e){return l[e.snapshotType]||e.snapshotType}},{title:"状态",width:100,stable:!0,content:function(e){var t=c[e.snapshotStatus]||e.snapshotStatus;return'<span class="status '+c.CLASS[e.snapshotStatus]+'">'+r.escape(t)+"</span>"}},{title:"操作",width:100,stable:!0,content:function(e,t){var n=o?"oprations":"oprations oprations-disabled";return"available"===e.snapshotStatus?'<span class="'+n+'"><a data-command="download" data-command-args="'+t+'">下载</a><a data-command="rebase" data-command-args="'+t+'">恢复</a></span>':""}}];return e.prototype.uiProperties={table:n.tableProperty(d,{select:""})},e.prototype.uiEvents={"table:select":function(e){this.fire("tableSelect",e)},"table:command":function(e){o&&this.fire(e.name,{itemIndex:+e.args})},"refreshBtn:click":function(){this.fire("refresh")},"backupInstance:click":function(){this.fire("backup")},"backupSetting:click":function(){this.fire("updatebackupPolicy")},"createClone:click":function(){this.fire("createClone")}},e.prototype.enterDocument=function(){o=!r.contains(s.oprationDisableStatus,this.model.get("instance").instanceStatus),t.prototype.enterDocument.call(this,arguments)},require("er/util").inherits(e,t),e}),define("rds/binlog/config",["require","er/controller"],function(require){require("er/controller").registerAction([{type:"rds/binlog/List",path:"/rds/binlog/list"}]);return{}}),define("rds/binlog/List",["require","bat-ria/mvc/ListAction","er/util","moment","../config","../helper","./ListModel","./ListView"],function(require){function e(){i.apply(this,arguments)}function t(e){var t=this.view.get("table").datasource[e.itemIndex],n=this.model.get("instance").instanceId;s.rdsBinlogDownloadUrl({instanceId:n,binlogId:t.binlogId,downloadValidTime:30}).then(a.bind(function(e){this.view.waitActionDialog({title:"下载",width:800,needFoot:!0,url:"/rds/download",defaultFoot:'<div class="ok-button ui-dialog-ok-btn"data-ui="type:Button;id:btnFootOk;childName:btnOk;">直接下载</div><div data-ui="type:Button;id:btnFootCancel;childName:btnCancel;">取消</div>',actionOptions:{idKey:"binlogId",instanceId:n,backupId:t.binlogId,urlApi:s.rdsBinlogDownloadUrl,downloadUrl:e.url,downloadExpires:e.downloadExpires}}).then(function(e){var t=e.target,n=t.getAction(),i=t.getChild("foot").getChild("btnOk"),a=t.getChild("foot").getChild("btnCancel");t.main.className+=" download-dialog",i.on("click",function(){n.download()}),a.on("click",function(){t.dispose()}),t.resize()})},this))}function n(){var e=this.view.get("calendar").getValue(),t=r.utc(e+" 00:00:00+08:00").format("YYYY-MM-DDTHH:mm:ss")+"Z";this.model.defaultArgs.date=t,this.reload()}var i=require("bat-ria/mvc/ListAction"),a=require("er/util"),r=require("moment"),s=require("../config").api,o=require("../helper");return e.prototype.initBehavior=function(){i.prototype.initBehavior.apply(this,arguments),o.handleDetailPublicEvent(this),this.view.get("calendar").setValue(r(this.model.defaultArgs.date).format("YYYY-MM-DD")),this.view.on("download",t,this),this.view.on("dateSelect",n,this)},e.prototype.modelType=require("./ListModel"),e.prototype.viewType=require("./ListView"),require("er/util").inherits(e,i),e}),define("rds/binlog/list.tpl",[],function(){return'\x3c!-- target: TPL_rds_binlog_list --\x3e\r\n<div class="rds-binlog-list rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e日志管理\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                <div class="ui-smart-tab">\r\n                    <ul class="ui-tab-navigator">\r\n                        <li class="ui-tab-item ui-tab-item-active">\r\n                            <a href="#/rds/binlog/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">BINLOG</a>\r\n                        </li>\r\n                        \x3c!-- if: ${rdsType} !== \'raft\' --\x3e\r\n                        <li class="ui-tab-item">\r\n                            <a href="#/rds/log/slowlog~instanceId=${instance.instanceId}&rdsType=${rdsType}">SLOWLOG</a>\r\n                        </li>\r\n                        \x3c!-- /if --\x3e\r\n                    </ul>\r\n                </div>\r\n                <div class="tip-grey">\r\n                    \x3c!-- if: ${instance.applicationType} !== \'enhanced\' && ${instance.instanceType} !== \'financial\' --\x3e\r\n                    ${tips.floatTip.binlog}\r\n                    \x3c!-- else --\x3e\r\n                    ${tips.floatTip.enhancedBinlog | raw}\r\n                    \x3c!-- /if --\x3e\r\n                </div>\r\n                <div class="table-full-wrap">\r\n                    <div class="ui-row">\r\n                        <span>选择时间日期：</span>\r\n                        <span data-ui-type="Calendar" data-ui-id="calendar"></span>\r\n                    </div>\r\n                    \x3c!-- import: listTableWithCommand --\x3e\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/binlog/ListModel",["require","bat-ria/mvc/ListModel","moment","../config","../helper","../tips","er/util"],function(require){function e(){t.apply(this,arguments),this.listRequester=i.rdsBinlogList}var t=require("bat-ria/mvc/ListModel"),n=require("moment"),i=require("../config").api,a=require("../helper");e.prototype.datasource={tips:function(){return require("../tips")},instance:function(e){return i.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return a.handlePublicData(e),e})},isWhiteAccount:function(){return i.rdsIsWhiteAccount()},tab:function(){return{log:"ui-tab-item-active"}}};var r=new Date;return r.setHours(0),r.setMinutes(0),r.setSeconds(0),e.prototype.defaultArgs={order:"desc",orderBy:"id",date:n.utc(r).format("YYYY-MM-DDTHH:mm:ss")+"Z"},require("er/util").inherits(e,t),e}),define("rds/binlog/ListView",["require","bat-ria/tpl!./list.tpl","bat-ria/mvc/ListView","common/util/tableUtil","moment","humanize","underscore","../config","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./list.tpl");var t=require("bat-ria/mvc/ListView"),n=require("common/util/tableUtil"),i=require("moment"),a=require("humanize"),r=require("underscore"),s=require("../config"),o=!0;e.prototype.template="TPL_rds_binlog_list";var c=[{title:"序列号",content:"binlogId"},{title:"文件大小",content:function(e){return a.filesize(e.binlogSizeInBytes)}},{title:"Binlog文件记录的开始时间",content:function(e){return i(e.binlogStartTime).format("YYYY-MM-DD HH:mm:ss")}},{title:"Binlog文件记录的结束时间",content:function(e){return i(e.binlogEndTime).format("YYYY-MM-DD HH:mm:ss")}},{title:"操作",content:function(e,t){return'<span class="'+(o?"oprations":"oprations oprations-disabled")+'"><a data-command="download" data-command-args="'+t+'">下载</a></span>'}}];return e.prototype.getUIProperties=function(){return"financial"===this.model.get("instance").instanceType&&c.pop(),{table:n.tableProperty(c,{select:""}),calendar:{range:{begin:new Date(2014,5,1),end:new Date}}}},e.prototype.uiEvents={"table:command":function(e){o&&this.fire(e.name,{itemIndex:+e.args})},"calendar:change":function(){this.get("calendar").layer.hide(),this.fire("dateSelect")}},e.prototype.enterDocument=function(){var e=this.model.get("instance");o=!(r.contains(s.oprationDisableStatus,e.instanceStatus)&&"migrating"!==e.instanceStatus),t.prototype.enterDocument.call(this,arguments)},require("er/util").inherits(e,t),e}),define("rds/cluster/config",["exports","module","er/controller","babel-runtime/helpers/interop-require-default"],function(exports,module,e,t){t["default"](e)["default"].registerAction([{type:"rds/cluster/Setting",path:"/rds/cluster/setting"}]);module.exports={}}),define("rds/cluster/Setting",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","bat-ria/mvc/BaseAction","babel-runtime/helpers/interop-require-default","underscore","../helper","./SettingModel","./SettingView"],function(exports,module,e,t,n,i,a,r,s,o,c){var l=a["default"](i),d=a["default"](r),u=a["default"](s),p=a["default"](o),m=a["default"](c),h=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.initBehavior=function(){i.prototype.initBehavior.call(this),this.view.on("refresh",this.reload,this),this.view.on("updateReplicaSwitch",this.updateReplicaSwitch,this),u["default"].handleDetailPublicEvent(this),this.updateReplicaBehindMaster()},a.prototype.updateReplicaBehindMaster=function(){var e=this,t=d["default"].map(d["default"].filter(this.model.get("tableData"),function(e){return"readReplica"===e.instanceType}),function(e){return e.instanceId});d["default"].each(t,function(t){e.model.updateReplicaBehindMaster(t).then(function(n){e.updateTableData({instanceId:t,secondsBehindMaster:n.secondsBehindMaster})})})},a.prototype.updateTableData=function(e){var t=this.model.get("tableData");d["default"].each(t,function(t){t.instanceId!==e.instanceId||(t.secondsBehindMaster=e.secondsBehindMaster)}),this.model.set("tableData",t),this.view.get("table").setDatasource(t)},a.prototype.updateReplicaSwitch=function(e){var t=this,n={rdsproxyId:this.model.get("instanceId")};e.checked?d["default"].extend(n,{onlineReadRepicIds:e.item.instanceId}):d["default"].extend(n,{offlineReadRepicIds:e.item.instanceId}),this.model.updateReplicaSwitch(n).then(function(e){t.view.showToast("流量开关修改成功")},function(e){t.view.showToast(e.global?e.global:"流量开关修改失败",{messageType:"error"}),t.reload()})},t["default"](a,[{key:"modelType",get:function(){return p["default"]}},{key:"viewType",get:function(){return m["default"]}}]),a}(l["default"]);module.exports=h}),define("rds/cluster/setting.tpl",[],function(){return'\x3c!-- target: TPL_rds_setting --\x3e\n<div class="rds-setting rds-main-wrap main-wrap-new">\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\n    <div class="content-wrap">\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\n            \x3c!-- block: list_link --\x3e\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\n            \x3c!-- else --\x3e#/rds/list"\n            \x3c!-- /if --\x3e\n            \x3c!-- /block --\x3e\n            \x3c!-- block: text_content_wrapper --\x3e集群管理\x3c!-- /block --\x3e\n        \x3c!-- /import --\x3e\n        \x3c!-- import: TPL_rds_tab --\x3e\n            <div class="ui-tab-content">\n                <div class="table-full-wrap">\n                    <div class="ui-row">\n                        <button data-ui-id="refresh" data-ui-type="Button" data-ui-skin="refresh"></button>\n                    </div>\n                    <div data-ui-type="Table" data-ui-id="table" data-ui-extension-tip-type="TableTip"\n                        data-ui-extension-command-type="Command" data-ui-extension-tableedit-type="TableEdit"\n                        data-ui-extension-tableex-type="TableEx"></div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n'}),define("rds/cluster/SettingModel",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/class-call-check","bat-ria/mvc/BaseModel","babel-runtime/helpers/interop-require-default","underscore","../config","../helper","../tips"],function(exports,module,e,t,n,i,a,r,s,o){var c=i["default"](n),l=i["default"](a),d=i["default"](s),u=i["default"](o),p={"X-silence":!0,"x-silent":!0},m=function(n){function i(){t["default"](this,i),n.apply(this,arguments)}return e["default"](i,n),i.prototype.getDatasource=function(){return{tab:function(){return{cluster:"ui-tab-item-active"}},instance:function(e){return r.api.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return d["default"].handlePublicData(e),e})},tableData:function(e){return r.api.rdsProxyManageList({instanceId:e.get("instanceId")}).then(function(e){return e.result})},tips:function(){return u["default"]}}},i.prototype.prepare=function(){var e=this.get("tableData"),t=this.get("instance");l["default"].each(e,function(e){return e.rdsproxyStatus=t.instanceStatus})},i.prototype.updateReplicaSwitch=function(e){return r.api.rdsSwitchReplica(e,p)},i.prototype.updateReplicaBehindMaster=function(e){return r.api.rdsReplicaBehindMaster({instanceId:e},p)},i}(c["default"]);module.exports=m}),define("rds/cluster/SettingView",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","bat-ria/tpl!./setting.tpl","bat-ria/mvc/BaseView","babel-runtime/helpers/interop-require-default","inf-ria/ui/ToggleButton","underscore","common/util/tableUtil"],function(exports,module,e,t,n,i,a,r,s,o,c){var l=r["default"](a),d=r["default"](o),u=r["default"](c),p=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.getUIProperties=function(){var e=[{title:"实例名称/ID",content:function(e){var t="";"readReplica"===e.instanceType?t="read-only":"rdsproxy"===e.instanceType?t="rds-proxy":"master"===e.instanceType&&(t="master");return'<span class="'+t+'"><a href="#/rds/detail~instanceId='+d["default"].escape(e.instanceId)+'" class="rds-type-icon instance-name">'+d["default"].escape(e.instanceName)+'</a><br><span class="instance-id" >'+d["default"].escape(e.instanceShortId)+"</span></span>"}},{title:"实例规格",content:function(e){return(e.cpuCount||"-")+"核 / "+(e.allocatedMemoryInGB||"-")+"G"}},{title:"磁盘空间",content:function(e){var t=e.usedStorageInGB?e.usedStorageInGB.toFixed(2):"-",n=e.allocatedStorageInGB||"-",i="0%";if("-"!==t&&"-"!==n){i=Math.round(t/n*1e4)/100+"%"}return'<span class="storage-wrap">\n                        <span class="storage-used" style="width:'+i+'"></span>\n                    </span>  '+t+"GB/"+n+"GB"}},{title:"主从延迟",content:function(e){return"readReplica"===e.instanceType&&d["default"].isNumber(e.secondsBehindMaster)?e.secondsBehindMaster+"秒":"-"}},{title:"只读实例流量开关",tip:"@tips.rdsReplicaSwitchTip",content:function(e,t){var n=d["default"].contains(["creating","failed","deleting","deleted"],e.instanceStatus)||"available"!==e.rdsproxyStatus;return"readReplica"===e.instanceType?'<div data-ui-type="ToggleButton" data-ui-x-event-type="change" data-ui-id="a'+t+'" data-ui-x-event-bubble="true" data-ui-x-row-index="'+t+'"data-ui-disabled="'+(n?"disabled":"")+'" '+(1===e.onlineStatus?' data-ui-checked="true"':"")+"></div>":"-"}}];return{table:u["default"].tableProperty(e,{select:"",columnResizable:!0,columnRenderIndexes:[4],datasource:"@tableData"})}},a.prototype.getUIEvents=function(){var e=this;return{"refresh:click":function(){return e.fire("refresh")},"table:change":function(t){if(!0===t.bubble){var n=t.originalTarget,i=n.get("xRowIndex"),a=t.target.datasource[i];e.fire("updateReplicaSwitch",{item:a,checked:n.isChecked()})}}}},t["default"](a,[{key:"template",get:function(){return"TPL_rds_setting"}}]),a}(l["default"]);module.exports=p}),define("rds/common.tpl",[],function(){return'\x3c!-- target: TPL_rds_side_bar --\x3e\r\n<ul class="sidebar" id="sidebar" data-menu="${menu}">\r\n    <li class="area">\r\n        华北 - 北京\r\n    </li>\r\n    <li class="menu-header">\r\n        关系型数据库RDS\r\n    </li>\r\n    <li class="menu-item menu-item-common instance" sidetype="instance">\r\n        <a href="#/rds/list"><i class="iconfont icon-bccinstance"></i>\r\n            \x3c!-- if: ${region} === \'fwh\' --\x3e\r\n            通用版实例\r\n            \x3c!-- else --\x3e\r\n            实例\r\n            \x3c!-- /if --\x3e\r\n        </a>\r\n\r\n    </li>\r\n    <li class="menu-item menu-item-common raft-instance" sidetype="raftInstance">\r\n        <a href="#/rds/list~rdsType=raft"><i class="iconfont icon-bccinstance"></i>\r\n            \x3c!-- if: ${region} === \'fwh\' --\x3e\r\n            金融raft版实例\r\n            \x3c!-- else --\x3e\r\n            金融实例\r\n            \x3c!-- /if --\x3e\r\n        </a>\r\n    </li>\r\n    \x3c!-- if: ${region} === \'bj\' || ${region} === \'gz\' || ${region} === \'su\' || ${region} === \'bd\' || ${region} === \'hb-fsg\' --\x3e\r\n    <li class="menu-item menu-item-common dcc-instance" sidetype="dccInstance">\r\n        <a href="#/rds/list~rdsType=dcc"><i class="iconfont icon-bccinstance"></i>专属实例</a>\r\n\r\n    </li>\r\n    \x3c!-- /if --\x3e\r\n    <li class="menu-item menu-item-common" sidetype="tag">\r\n        <a target="_blank" href="/tag/#/tag/instance/list"><i class="iconfont icon-link"></i>标签管理</a>\r\n    </li>\r\n</ul>\r\n\r\n\x3c!-- target: TPL_rds_side_bar_new --\x3e\r\n\x3c!-- if: ${rdsType} === \'raft\' --\x3e\r\n\x3c!-- use: TPL_rds_side_bar(menu="raftInstance", region=${consoleContext.region.rawId}) --\x3e\r\n\x3c!-- elif: ${rdsType} === \'dcc\' --\x3e\r\n\x3c!-- use: TPL_rds_side_bar(menu="dccInstance", region=${consoleContext.region.rawId}) --\x3e\r\n\x3c!-- else --\x3e\r\n\x3c!-- use: TPL_rds_side_bar(menu="instance", region=${consoleContext.region.rawId}) --\x3e\r\n\x3c!-- /if --\x3e\r\n\r\n\x3c!-- target: TPL_rds_breadcrumb --\x3e\r\n<p class="breadcrumb">\r\n    <span>产品服务</span>\r\n    <span class="divider">/</span>\r\n    \x3c!-- block: list_wrapper --\x3e\r\n    <a href="\x3c!-- block: list_link --\x3e\x3c!-- /block --\x3e">\r\n        \x3c!-- block: list_text --\x3e关系型数据库RDS-实例列表\x3c!-- /block --\x3e\r\n    </a>\r\n    \x3c!-- /block --\x3e\r\n    <span class="divider">/</span>\r\n    \x3c!-- block: other_link_wrapper --\x3e\x3c!-- /block --\x3e\r\n    \x3c!-- block: text_wrapper --\x3e\r\n        <span class="active">\r\n            \x3c!-- block: text_content_wrapper --\x3e基本信息\x3c!-- /block --\x3e\r\n        </span>\r\n    \x3c!-- /block --\x3e\r\n</p>\r\n\r\n\x3c!-- target: TPL_rds_tab --\x3e\r\n\r\n<div class="instance-info">\r\n    <h1>\x3c!-- if: ${rdsType} === \'dcc\' --\x3e专属实例\x3c!-- /if --\x3eID：${instance.instanceShortId}  <span class="instance-name">(名称：${instance.instanceName})</span>\r\n    \x3c!-- if: ${instance.readOnly}--\x3e\r\n        <span class="rds-readonly-icon"></span>\r\n    \x3c!-- /if --\x3e\r\n    \x3c!-- if: ${instance.isRdsproxy} --\x3e\r\n        <span class="rds-proxy-icon"></span>\r\n    \x3c!-- /if --\x3e\r\n    </h1>\r\n    \x3c!-- <h1 class="engine-label">${instance.engineName}</h1> --\x3e\r\n    <span class="status ${instance.instanceStatusClass}">\r\n        ${instance.instanceStatusText}\r\n    </span>\r\n    \x3c!-- if: ${instance.instanceStatus} !== \'creating\' && ${instance.readOnly}--\x3e\r\n    <span data-ui-type="Label" data-ui-id="delayTime" class="rds-readonly-delay"></span>\r\n    \x3c!-- /if --\x3e\r\n    <span class="ui-group ui-button-group">\r\n    \x3c!-- if: ${instance.instanceType} !== \'financial\' --\x3e\r\n        \x3c!-- if: ${instance.engine} === \'MySQL\' && ${rdsType} !== \'dcc\' --\x3e\r\n            \x3c!--if: ${instance.readOnly}--\x3e\r\n        <a href="https://bce.baidu.com/doc/RDS/GettingStarted.html#.B0.8A.50.D7.52.16.8E.0A.76.D8.A6.79.74.2F.81.13"\r\n            target="_blank" class="ui-ctrl ui-button">只读实例文档\r\n        </a>\r\n            \x3c!-- elif: ${instance.isRdsproxy} --\x3e\r\n        <a href="https://bce.baidu.com/doc/RDS/GettingStarted.html#.E4.BD.BF.E7.94.A8.E4.BB.A3.E7.90.86.E5.AE.9E.E4.BE.8B"\r\n            target="_blank" class="ui-ctrl ui-button">代理实例文档\r\n        </a>\r\n            \x3c!-- else --\x3e\r\n        <a href="#/rds/create~instanceId=${instance.instanceId}&type=rdsproxy" class="ui-ctrl ui-button skin-create skin-create-button create-rdsproxy">创建代理实例</a>\r\n        <div data-ui-type="Tip" data-ui-content="${tips.rdsproxyInstanceTip}" class="readonly-tip" data-ui-layer-width="400"></div>\r\n        <a href="#/rds/create~instanceId=${instance.instanceId}" class="ui-ctrl ui-button skin-create skin-create-button create-readonly">创建只读实例</a>\r\n        <div data-ui-type="Tip" data-ui-content="${tips.readOnlyInstanceTip}" class="readonly-tip" data-ui-layer-width="400"></div>\r\n            \x3c!-- /if --\x3e\r\n        \x3c!-- /if --\x3e\r\n        <button data-ui-id="rebootInstance" data-ui-type="Button">重启实例</button>\r\n        \x3c!-- if: ${instance.engine} === \'MySQL\' --\x3e\r\n            \x3c!-- if: ${instance.instanceType} === \'rdsproxy\' --\x3e\r\n            \x3c!-- elif: ${instance.instanceStatus} === \'creating\' || ${instance.instanceStatus} !== \'notExist\' --\x3e\r\n            <a id="php-admin-button" class="ui-ctrl ui-button php-admin" href="void(0);">数据库管理工具</a>\r\n            \x3c!-- else --\x3e\r\n            <a class="ui-ctrl ui-button php-admin php-admin-disable">数据库管理工具</a>\r\n            \x3c!-- /if --\x3e\r\n        \x3c!-- /if --\x3e\r\n    \x3c!-- /if --\x3e\r\n    </span>\r\n</div>\r\n\r\n<div class="detail-content">\r\n    <ul class="ui-tab-navigator">\r\n        <li class="ui-tab-item ${tab.detail}">\r\n            <a href="#/rds/detail~instanceId=${instance.instanceId}&rdsType=${rdsType}">基本信息</a>\r\n        </li>\r\n        \x3c!-- if: ${instance.instanceStatus} !== \'creating\' && ${instance.instanceStatus} !== \'initing\'--\x3e\r\n        <li class="ui-tab-item ${tab.account}">\r\n            <a href="#/rds/account/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">账号管理</a>\r\n        </li>\r\n            \x3c!-- if: !${instance.isRdsproxy} --\x3e\r\n        <li class="ui-tab-item ${tab.database}">\r\n            <a href="#/rds/database/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">数据库管理</a>\r\n        </li>\r\n                \x3c!-- if: ${instance.engine} === \'postgresql\' --\x3e\r\n        <li class="ui-tab-item ui-tab-item-disable" title="暂不支持此功能">\r\n            <span>参数配置</span>\r\n        </li>\r\n                \x3c!-- elif: ${rdsType} !== \'raft\' --\x3e\r\n        <li class="ui-tab-item ${tab.argument}">\r\n            <a href="#/rds/argument/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">参数配置</a>\r\n        </li>\r\n                \x3c!-- /if --\x3e\r\n            \x3c!-- /if --\x3e\r\n        <li class="ui-tab-item ${tab.monitor}">\r\n            <a href="#/rds/monitor~instanceId=${instance.instanceId}&rdsType=${rdsType}">监控</a>\r\n        </li>\r\n            \x3c!-- if: !${instance.isRdsproxy} --\x3e\r\n                \x3c!--if: ${instance.readOnly} --\x3e\r\n        <li class="ui-tab-item ${tab.log}">\r\n            <a href="#/rds/log/slowlog~instanceId=${instance.instanceId}&rdsType=${rdsType}">日志</a>\r\n        </li>\r\n                \x3c!-- elif: ${instance.engine} === \'sqlserver\' --\x3e\r\n        <li class="ui-tab-item ${tab.backup}">\r\n            <a href="#/rds/backup/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">备份</a>\r\n        </li>\r\n        <li class="ui-tab-item ${tab.log}">\r\n            <a href="#/rds/log/slowlog~instanceId=${instance.instanceId}&rdsType=${rdsType}">日志</a>\r\n        </li>\r\n                \x3c!-- else --\x3e\r\n                    \x3c!-- if: ${instance.instanceType} !== \'financial\' --\x3e\r\n        <li class="ui-tab-item ${tab.backup}">\r\n            <a href="#/rds/backup/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">备份</a>\r\n        </li>\r\n                    \x3c!-- /if --\x3e\r\n                    \x3c!-- if: ${instance.engine} === \'postgresql\' --\x3e\r\n        <li class="ui-tab-item ui-tab-item-disable" title="暂不支持此功能">\r\n            <span>日志</span>\r\n        </li>\r\n                    \x3c!-- else --\x3e\r\n        <li class="ui-tab-item ${tab.log}">\r\n            <a href="#/rds/binlog/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">日志</a>\r\n        </li>\r\n                    \x3c!-- /if --\x3e\r\n                \x3c!-- /if --\x3e\r\n            \x3c!-- /if --\x3e\r\n        <li class="ui-tab-item ${tab.security}">\r\n            <a href="#/rds/whitelist/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">安全</a>\r\n        </li>\r\n        \x3c!-- if: ${instance.isRdsproxy} --\x3e\r\n        <li class="ui-tab-item ${tab.cluster}">\r\n            <a href="#/rds/cluster/setting~instanceId=${instance.instanceId}&rdsType=${rdsType}">集群管理</a>\r\n        </li>\r\n        \x3c!-- /if --\x3e\r\n        \x3c!-- /if --\x3e\r\n    </ul>\r\n\r\n\r\n\r\n\x3c!-- target: TPL_rds_security_tab --\x3e\r\n\r\n<ul class="ui-tab-navigator">\r\n    \x3c!-- if: ${instance.engine} === \'MySQL\' && ${instance.engineVersion} !== \'5.5\' && ${instance.instanceType} !== \'financial\' && ${rdsType} !== \'dcc\' --\x3e\r\n    <li class="ui-tab-item ${tab.whitelist}">\r\n        <a href="#/rds/whitelist/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">白名单</a>\r\n    </li>\r\n    <li class="ui-tab-item ${tab.firewall}">\r\n        <a href="#/rds/security/firewall~instanceId=${instance.instanceId}&rdsType=${rdsType}">DB防火墙</a>\r\n    </li>\r\n    \x3c!-- else --\x3e\r\n    <li class="ui-tab-item ${tab.whitelist}">\r\n        <a href="#/rds/whitelist/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">白名单</a>\r\n    </li>\r\n    \x3c!-- /if --\x3e\r\n\r\n    \x3c!-- if: ${instance.engineVersion} === \'5.7\' && ${instance.instanceType} === \'master\' --\x3e\r\n    <li class="ui-tab-item ${tab.ssl}">\r\n        <a href="#/rds/security/ssl~instanceId=${instance.instanceId}&rdsType=${rdsType}">SSL</a>\r\n    </li>\r\n    \x3c!-- /if --\x3e\r\n</ul>\r\n'}),define("rds/config",["require","underscore","er/controller","common/config"],function(require){var e=require("underscore"),t=require("er/controller"),n=require("common/config").getConfig();n.index="/rds/list";e.extend(n.api,{userInfo:"/api/iam/basicinfo/detail",rdsArgumentList:"/api/rds/argument/list",rdsArgumentModify:"/api/rds/argument/modify",rdsArgumentHistory:"/api/rds/argument/history",rdsMigrationTask:"/api/rds/migration/task",rdsMigrationCancel:"/api/rds/migration/cancel",rdsMigrationStopSync:"/api/rds/migration/stop_synchronous",rdsMigrationStart:"/api/rds/migration/start",rdsMigrationCheck:"/api/rds/migration/check",rdsMigrationCommit:"/api/rds/migration/commit",rdsConnectDb:"/api/rds/migration/connect",rdsMigrationList:"/api/rds/migration/list",rdsGetCheckCode:"/api/rds/instance/get_check_code",rdsCreateInstance:"/api/rds/instance/create",rdsCreateOrder:"/api/rds/instance/order",rdsReCharge:"/api/rds/instance/recharge",rdsGetPrice:"/api/rds/instance/get_price",rdsGetPriceDifference:"/api/rds/instance/price_difference",rdsInstanceList:"/api/rds/instance/list",rdsUpdateInstanceName:"/api/rds/instance/update_name",rdsInstanceDetail:"/api/rds/instance/detail",rdsUpdateInternetAccess:"/api/rds/instance/update_internet_access",rdsUpdateInstanceDomain:"/api/rds/instance/update_domain",rdsRebootInstance:"/api/rds/instance/reboot",rdsAccountList:"/api/rds/account/list",rdsAccountDetail:"/api/rds/account/detail",rdsUpdateAccountDesc:"/api/rds/account/update_desc",rdsCreateAccount:"/api/rds/account/create",rdsUpdateAccountPassword:"/api/rds/account/update_password",rdsUpdateAccountPermission:"/api/rds/account/update_permission",rdsUpdataConfiguration:"/api/rds/instance/update_configuration",rdsDeleteAccount:"/api/rds/account/delete",rdsDatabaseList:"/api/rds/database/list",rdsUpdateDatabaseDesc:"/api/rds/database/update_desc",rdsCreateDatabase:"/api/rds/database/create",rdsDeleteDatabase:"/api/rds/database/delete",rdsBackupList:"/api/rds/backup/list",rdsBackupDownloadUrl:"/api/rds/backup/download_url",rdsBackupSetting:"/api/rds/backup/setting",rdsDoBackup:"/api/rds/backup/do",rdsRebaseBackup:"/api/rds/backup/rebase",rdsBinlogList:"/api/rds/binlog/list",rdsBinlogDownloadUrl:"/api/rds/binlog/download_url",rdsWhitelist:"/api/rds/whitelist/get",rdsSetWhitelist:"/api/rds/whitelist/set",rdsReplicaBehindMaster:"/api/rds/instance/replica_behind_master",rdsCheckReplicaQuota:"/api/rds/instance/checkReplicaQuota",rdsCheckMasterQuota:"/api/rds/instance/checkMasterQuota",rdsInstanceDelete:"/api/rds/instance/delete",rdsDBFirewall:"/api/rds/dbfirewall/detail",getDetailByOrderId:"/api/order/detail",getRdsPurchaseValidation:"/api/account/purchase_validation",rdsSendAuthCode:"/api/rds/authcode/send",rdsInvalidateAuthCode:"/api/rds/authcode/invalidate",rdsSlowlogList:"/api/rds/slowlog/list",rdsSlowlogDownloadUrl:"/api/rds/slowlog/download_url",rdsIsWhiteAccount:"/api/rds/system/is_white_account",subnetList:"/api/network/v1/az/subnet",vpcList:"/api/network/v1/vpcs",rdsBinlogCheck:"/api/rds/binlog/check",rdsBackupListClone:"/api/rds/backup/list_for_clone",rdsVpcList:"/api/rds/instance/vpc_list",rdsTagAssign:"/api/rds/tag/assign",rdsGetSearchTagList:"/api/tag/list",rdsCancelAlterProductType:"/api/rds/order/v2/confirm?orderType=CANCEL_TO_POSTPAY",rdsGetPhpadminUrlToken:"/api/iam/authorization/generate",rdsUpdateReplicationType:"/api/rds/instance/update_replicationType",rdsSqlinjectList:"/api/rds/dbfirewall/sqlinject/list",rdsSqlinjectDetail:"/api/rds/dbfirewall/sqlinject/detail",rdsFWUpdateState:"/api/rds/dbfirewall/update_state",rdsSqlWhitelist:"/api/rds/dbfirewall/sqlwhite/list",rdsAddtoWhitelist:"/api/rds/dbfirewall/sqlwhite/create",rdsDelfromWhitelist:"/api/rds/dbfirewall/sqlwhite/delete",rdsZoneList:"/api/rds/instance/zone_list",rdsGetInstanceShortids:"/api/rds/instance/get_instance_shortids",rdsProxyManageList:"/api/rds/instance/list?action=proxyManage",rdsSwitchReplica:"/api/rds/instance/onOrOfflineReplica",rdsStsRoleActive:"/api/iam/sts/role/activate",rdsStsRoleQuery:"/api/iam/sts/role/query",rdsInstanceParam:"/api/rds/instance/param",rdsDccHostList:"/api/bcc/dcc/host/list",rdsOnDccCreate:"/api/rds/order/v2/confirm?orderType=NEW",rdsSslGet:"/api/rds/ssl/get",rdsSslSet:"/api/rds/ssl/set",rdsSslCaGet:"/api/rds/ssl/get/ca"});return t.registerAction([{type:"rds/Create",path:"/rds/create"},{type:"rds/Settimepoint",path:"/rds/settimepoint"},{type:"rds/Download",path:"/rds/download"},{type:"rds/Create",path:"/rds/create"},{type:"rds/UpdateConfiguration",path:"/rds/updateConfiguration"},{type:"rds/Monitor",path:"/rds/monitor"},{type:"rds/Detail",path:"/rds/detail"},{type:"rds/List",path:"/rds/list"},{type:"rds/RequireAuthCode",path:"/rds/requireauthcode"}]),e.extend(n,{instanceStatus:{creating:"创建中",available:"运行中",rebooting:"重启中",backuping:"备份中",renaming:"域名修改中",restoring:"备份恢复中",sigleAvaiable:"单机运行中",lock:"锁定中",readReplicating:"数据同步中",initing:"数据克隆中",lockExpiration:"已到期",lockDiskQuota:"磁盘超限",notExist:"资源已释放",migrating:"数据迁移中",modifying:"变配中",sslModifying:"SSL状态变更中",masterModifying:"主实例变配中",readReplicateModifying:"只读副本实例变配中",singleAvailable:"单机服务中",noAvaiable:"不可用",CLASS:{creating:"warning",available:"normal",rebooting:"warning",backuping:"warning",renaming:"warning",initing:"warning",restoring:"warning",lock:"warning",readReplicating:"warning",lockExpiration:"error",lockDiskQuota:"error",notExist:"error",migrating:"warning",modifying:"warning",masterModifying:"warning",sslModifying:"warning",readReplicateModifying:"warning",singleAvailable:"warning",sigleAvaiable:"warning",noAvaiable:"unavailable"}},oprationDisableStatus:["creating","rebooting","backuping","restoring","initing","renaming","lock","lockExpiration","notExist","migrating","modifying","readReplicating","masterModifying","sslModifying","readReplicateModifying"],eipStatus:{available:"已开通",closed:"未开通",closing:"处理中",creating:"处理中",overdue:"已欠费",binding:"处理中",unbinding:"处理中"},monitorMetric:{cpu:{name:"CPU占用率",unit:"百分比",metrics:[{name:"CPU占用率",value:"CPUUsagePercent"}]},disk:{name:"磁盘使用率",unit:"百分比",metrics:[{name:"磁盘使用率",value:"DiskUsagePercent"}]},memory:{name:"内存使用率",unit:"百分比",metrics:[{name:"内存使用率",value:"MemUsagePercent"}]},network:{name:"网卡流量",unit:"字节",filter:"eip",metrics:[{name:"网络输入流量",value:"NetworkInBytes"},{name:"网络输出流量",value:"NetworkOutBytes"},{name:"外网网络输入流量",value:"WebInBytes",filter:"eip",filterValue:!0},{name:"外网网络输出流量",value:"WebOutBytes",filter:"eip",filterValue:!0}]},request:{name:"请求数",unit:"次/秒",metrics:[{name:"查询请求次数",value:"ReadOpCountPerSecond"},{name:"更新请求次数",value:"WriteOpCountPerSecond"},{name:"全部SQL次数",value:"QueryCountPerSecond"}]},thread:{name:"连接数",unit:"个数",metrics:[{name:"客户端连接数",value:"ThreadConnectedCount"},{name:"活跃线程数",value:"ThreadRunningCount"}]},transaction:{name:"最大事务执行时间",unit:"秒",metrics:[{name:"最大事务执行时间",value:"TransactionMaxActiveSeconds"}]},mysqlSlowQueriesPt:{name:"慢查询",unit:"个",metrics:[{name:"慢查询",value:"MysqlSlowQueriesPt"}]},secondsBehindMaster:{name:"主从延迟",unit:"秒",metrics:[{name:"主从延迟",value:"SecondsBehindMaster"}]}},rdsproxyMonitorMetric:{qps:{name:"查询请求数",unit:"次/秒",metrics:[{name:"查询请求次数",value:"ReadOpCountPerSecond"}]},tps:{name:"更新请求数",unit:"次/秒",metrics:[{name:"更新请求次数",value:"WriteOpCountPerSecond"}]},thread:{name:"连接数",unit:"个数",metrics:[{name:"客户端连接数",value:"ThreadConnectedCount"}]}},RDS_LISTEN_INTERVAL:6e4,MEMORY_MAP:{.25:"256MB",.5:"512MB",1:"1GB",2:"2GB",4:"4GB",8:"8GB",12:"12GB",16:"16GB",24:"24GB",32:"32GB",48:"48GB",64:"64GB",128:"128GB",256:"256GB",480:"480GB"},NODE_MAP:{2:"2节点（2核4G）",4:"4节点（4核8G）",6:"6节点（6核12G）",8:"8节点（8核16G）",16:"16节点（16核32G）"},ENGINE_INFO:{MySQL:{name:"MySQL",isRealType:!0,seriesInfo:{"double":{name:"双机高可用版",value:"double",versions:[{name:"5.5",value:"5.5"},{name:"5.6",value:"5.6"},{name:"5.7",value:"5.7"}]}},version:[{name:"5.5",value:"5.5"},{name:"5.6",value:"5.6"},{name:"5.7",value:"5.7"}],memoryInfo:{.25:{maxLink:110},.5:{maxLink:170},1:{maxLink:300},2:{maxLink:560},4:{maxLink:1050},8:{maxLink:2e3},16:{maxLink:4e3},24:{maxLink:6e3},32:{maxLink:8e3},48:{maxLink:12e3},64:{maxLink:16e3},128:{maxLink:32e3},256:{maxLink:64e3},480:{maxLink:1e5}},enhancedPackage:["C2M8","C4M16","C8M32","C16M64","C1M8","C2M16","C4M32","C8M64","C6M8","C8M16","C12M24","C16M32","C20M48","C20M64"],enhancedMemory:[8192,16384,24576,32768,49152,65536],availablePackage:["C1M1","C1M2","C1M4","C2M8","C4M16","C8M32","C16M64","C32M128","C1M8","C2M16","C4M32","C8M64","C16M128","C32M256","C56M480","C2M4","C6M8","C8M16","C12M24","C16M32","C20M48","C20M64"],minStorage:5,maxStorage:1e3,hasReadOnly:!0,charset:["utf8","gbk","latin1","utf8mb4"],regions:["bj","gz","su","fsh","hk02","hkg","bd","hb-fsg","fwh"]},sqlserver:{name:"SQL Server",isRealType:!0,seriesInfo:{single:{name:"单机基础版",value:"single",versions:[{name:"2012",value:"2012"}]},"double":{name:"双机高可用版",value:"double",versions:[{name:"2008R2",value:"2008r2"},{name:"2012",value:"2012sp3"},{name:"2016",value:"2016sp1"}]}},version:[{name:"2008R2",value:"2008r2"},{name:"2012",value:"2012sp3"},{name:"2016",value:"2016sp1"}],availablePackage:["C1M2","C1M4","C2M8","C4M16","C8M32","C16M64","C32M128","C1M8","C2M16","C4M32","C8M64","C16M128","C32M256","C56M480","C2M4","C6M8","C6M12","C8M16","C12M24","C16M32","C20M48","C20M64"],minStorage:10,maxStorage:1e3,hasReadOnly:!1,charset:["Chinese_PRC_CI_AS","Chinese_PRC_CS_AS","SQL_Latin1_General_CP1_CI_AS","SQL_Latin1_General_CP1_CS_AS","Chinese_PRC_BIN"],regions:["bj","gz","su","hk02","hkg","bd","hb-fsg","fwh"]},rdsproxy:{name:"MySQL",isRealType:!1,version:[{name:"5.5",value:"5.5"},{name:"5.6",value:"5.6"},{name:"5.7",value:"5.7"}],minStorage:5,maxStorage:1e3,charset:["utf8","gbk","latin1"],regions:["bj","gz","su","hk02","hkg","bd","hb-fsg"]},postgresql:{name:"PostgreSQL",isRealType:!0,"double":{name:"双机高可用版",value:"double",versions:[{name:"9.4",value:"9.4"}]},version:[{name:"9.4",value:"9.4"}],availablePackage:["C1M1","C1M2","C1M4","C2M8","C4M16","C8M32","C16M64","C32M128","C1M8","C2M16","C4M32","C8M64","C16M128","C32M256","C56M480","C2M4","C6M8","C8M16","C12M24","C16M32","C20M48","C20M64"],minStorage:5,maxStorage:1e3,hasReadOnly:!1,charset:[],regions:["bj","gz","su","hk02","hkg","bd","hb-fsg","fwh"]}},PACKAGE_MAP:{C1M1:{type:"小微型",cpu:1,memory:1,maxStorage:200},C1M2:{type:"小微型",cpu:1,memory:2,maxStorage:500},C1M4:{type:"标准型",cpu:1,memory:4,maxStorage:1e3},C2M8:{type:"标准型",cpu:2,memory:8,maxStorage:1e3},C4M16:{type:"标准型",cpu:4,memory:16,maxStorage:3e3},C8M32:{type:"标准型",cpu:8,memory:32,maxStorage:3e3},C16M64:{type:"标准型",cpu:16,memory:64,maxStorage:3e3},C32M128:{type:"标准型",cpu:32,memory:128,maxStorage:3e3},C1M8:{type:"内存增强型",cpu:1,memory:8,maxStorage:1e3},C2M16:{type:"内存增强型",cpu:2,memory:16,maxStorage:3e3},C4M32:{type:"内存增强型",cpu:4,memory:32,maxStorage:3e3},C8M64:{type:"内存增强型",cpu:8,memory:64,maxStorage:3e3},C16M128:{type:"内存增强型",cpu:16,memory:128,maxStorage:3e3},C32M256:{type:"内存增强型",cpu:32,memory:256,maxStorage:3e3},C56M480:{type:"内存增强型",cpu:56,memory:480,maxStorage:3e3},C2M4:{type:"CPU增强型",cpu:2,memory:4,maxStorage:1e3},C6M8:{type:"CPU增强型",cpu:6,memory:8,maxStorage:1e3},C6M12:{type:"CPU增强型",cpu:6,memory:12,maxStorage:1e3},C8M16:{type:"CPU增强型",cpu:8,memory:16,maxStorage:3e3},C12M24:{type:"CPU增强型",cpu:12,memory:24,maxStorage:3e3},C16M32:{type:"CPU增强型",cpu:16,memory:32,maxStorage:3e3},C20M48:{type:"CPU增强型",cpu:20,memory:48,maxStorage:3e3},C20M64:{type:"CPU增强型",cpu:20,memory:64,maxStorage:3e3},"C1M0.25":{type:"上一代",cpu:1,memory:.25,maxStorage:1e3},"C1M0.5":{type:"上一代",cpu:1,memory:.5,maxStorage:1e3},C2M1:{type:"上一代",cpu:2,memory:1,maxStorage:1e3},C2M2:{type:"上一代",cpu:2,memory:2,maxStorage:1e3},C4M2:{type:"上一代",cpu:4,memory:2,maxStorage:1e3},C4M4:{type:"上一代",cpu:4,memory:4,maxStorage:1e3}},STAUTS_CLASS:{creating:"warning",available:"normal",updating:"warning",deleting:"error",deleted:"error"},invalidProxyStatus:["deleting","creating","lockExpiration"],reservedKeywords:["admin","aurora","replicator","xtrabak","mysql","test","eagleye","information_schema","guest","add","analyze","asc","between","blob","call","change","check","condition","continue","cross","current_timestamp","database","day_microsecond","dec","default","desc","distinct","double","each","enclosed","exit","fetch","float8","foreign","goto","having","hour_minute","ignore","infile","insensitive","int1","int4","interval","iterate","keys","leading","like","lines","localtimestamp","longblob","low_priority","mediumint","minute_microsecond","modifies","no_write_to_binlog","on","optionally","out","precision","purge","read","references","rename","require","revoke","schema","select","set","spatial","sqlexception","sql_big_result","ssl","table","tinyblob","to","true","unique","update","using","utc_timestamp","varchar","when","with","xor","all","and","asensitive","bigint","both","cascade","char","collate","connection","convert","current_date","current_user","databases","day_minute","decimal","delayed","describe","distinctrow","drop","else","escaped","explain","float","for","from","grant","high_priority","hour_second","in","inner","insert","int2","int8","into","join","kill","leave","limit","load","lock","longtext","match","mediumtext","minute_second","natural","null","optimize","or","outer","primary","raid0","reads","regexp","repeat","restrict","right","schemas","sensitive","show","specific","sqlstate","sql_calc_found_rows","starting","terminated","tinyint","trailing","undo","unlock","usage","utc_date","values","varcharacter","where","write","year_month","alter","as","before","binary","by","case","character","column","constraint","create","current_time","cursor","day_hour","day_second","declare","delete","deterministic","div","dual","elseif","exists","false","float4","force","fulltext","group","hour_microsecond","if","index","inout","int","int3","integer","is","key","label","left","linear","localtime","long","loop","mediumblob","middleint","mod","not","numeric","option","order","outfile","procedure","range","real","release","replace","return","rlike","second_microsecond","separator","smallint","sql","sqlwarning","sql_small_result","straight_join","then","tinytext","trigger","union","unsigned","use","utc_time","varbinary","varying","while","x509","zerofill","performance_schema"],FINANCIAL_REGION:["fsh","fwh"]}),n}),define("rds/Create",["require","bat-ria/mvc/FormAction","underscore","promise","moment","jquery","common/zone","common/constants","common/region","common/util/orderUtil","common/util/timeUtil","./config","./helper","./CreateModel","./CreateView","er/util"],function(require){function e(){c.apply(this,arguments),this.buyNumber=1,this.hasWarning=!1,this.billingStatus={postpay:{isChecking:!1,checked:!1,enable:!1,reason:""},prepay:{isChecking:!1,checked:!1,enable:!1,reason:""}},this.isCloneTimeAvilible=!1}function t(){var e=g.getCurrentRegion().id,t=this.view.get("engine").getValue(),n=l.map(v.ENGINE_INFO[t].availablePackage,function(e){var t=v.PACKAGE_MAP[e];return{name:t.type+" "+t.cpu+"核"+t.memory+"G",value:e}});if(this.view.get("packageSelect").setProperties({datasource:n}),"fwh"===e&&"MySQL"===t){var i=l.deepClone(v.ENGINE_INFO[t].version);this.view.get("engineVersion").setProperties({datasource:i,showNum:i.length,selectedIndex:1})}else this.view.get("engineVersion").setProperties({datasource:v.ENGINE_INFO[t].version,showNum:v.ENGINE_INFO[t].version.length,selectedIndex:"postgresql"!==t?1:0});this.setAvalibleConfig()}function n(){var e="clone"===this.model.get("type")?5:10;this.buyNumber=this.view.get("buyNumber").getRawValue(),this.fire("pickChange"),this.view.get("numberReduce").enable(),this.view.get("numberPlus").enable(),this.buyNumber===e&&this.view.get("numberPlus").disable(),1===this.buyNumber&&this.view.get("numberReduce").disable()}function i(){this.view.get("buyNumber").setValue(++this.buyNumber)}function a(){this.view.get("buyNumber").setValue(--this.buyNumber)}function r(e){var t=this.getFormData(),n=t.instance.engine,i=t.instance.engineVersion,a=this.view,r=this.view.get("logicalZone").getValue(),s=this.model.get("zonePackageLimit")[r].maxStorage;if("rdsproxy"!==this.model.get("type")){var o="",c=t.instance.allocatedMemoryInGB;if(o="MySQL"===n?"最大连接数："+v.ENGINE_INFO.MySQL.memoryInfo[c].maxLink:"postgresql"===n?"最大连接数：1000":"最大连接数：不限",a.get("memoryTip").setText(o),t.instance.allocatedStorageInGB<v.ENGINE_INFO[n].minStorage||t.instance.allocatedStorageInGB>s)return;if(!l.contains(l.pluck(v.ENGINE_INFO[n].version,"value"),t.instance.engineVersion)&&("2012"!==i||"sqlserver"!==n))return}else this.setNodeQps();var d=this.model.get("instance")&&!this.model.get("type");a.get("buyBucket").setValue(l.extend(t,{loading:!0,isReplica:d})),this.model.rdsGetPrice(t).then(function(e){a.get("buyBucket").setValue(l.extend(t,e,{loading:!1,isReplica:d}))})}function s(){var e=this,t=this.getFormData(),n=this.view.get("vpc").getValue(),i=l.find(this.model.get("vpcDatasource"),function(e){return e.value===n}),a=i?i.text:"",r=this.model.get("subnetMap"),s=t.instance.subnetId,o=[];l.each(s.split(","),function(e){var t=e.split(":");o.push(r[t[1]])});var c=o.join(" + ");e.model.rdsGetPrice(t).then(function(n){var i=function(e,t,n){var i="￥",a=e.instance.engine,r=e.instance.engineVersion;l.each(v.ENGINE_INFO[a].version,function(t){t.value===e.instance.engineVersion&&(r=t.name)});var s=v.ENGINE_INFO[a].name+"("+r+")";"postpay"===e.productType?i+=e.price/e.number+"/分钟/台":i+=e.price/e.number+"/台";var o=m.getLabel(e.instance.azone),c=["地域："+g.getCurrentRegion().label,"可用区："+o,"数据库版本："+s];c=e.instance.nodeAmount?c.concat(["资源规格："+v.NODE_MAP[e.instance.nodeAmount]]):c.concat(["CPU："+e.instance.cpuCount+"核","内存："+e.instance.allocatedMemoryInGB+"GB","存储磁盘："+e.instance.allocatedStorageInGB+"GB"]);c=c.concat(["所在网络："+t,"所在子网："+n]),e.instance.initialDataReference&&(c.unshift("原实例:"+e.instance.initialDataReference.instanceShortId),delete e.instance.initialDataReference.instanceShortId);var d="rdsproxy"===e.instance.engine?"RDS_PROXY":"RDS";return f.make({serviceType:"RDS",productType:e.productType,type:"NEW",price:e.price,items:[{serviceType:d,productType:e.productType,count:e.number,price:e.price,time:e.duration,timeUnit:"MONTH",unitPrice:e.price,unitPriceShow:i,chargeType:h.SERVICE_TYPE.RDS.chargeType[e.productType],configuration:c}]})}(l.extend(t,n),a,c);e.view.renderOrderConfirm(i,t)})}function o(e){this.model.productType=e.productType,this.model.get("instanceId")&&"clone"!==this.model.get("type")||this.setAvalibleConfig(),this.checkQuotaBalance(),this.checkEnablePurchase()}var c=require("bat-ria/mvc/FormAction"),l=require("underscore"),d=require("promise"),u=require("moment"),p=require("jquery"),m=require("common/zone"),h=require("common/constants"),g=require("common/region"),f=require("common/util/orderUtil"),b=require("common/util/timeUtil"),v=require("./config"),y=require("./helper");return e.prototype.initBehavior=function(){c.prototype.initBehavior.apply(this,arguments),this.view.get("numberReduce").disable(),this.view.on("numberChange",n,this),this.view.on("numberReduce",a,this),this.view.on("numberPlus",i,this),this.view.on("changeProductType",o,this),this.view.on("refresh",this.reload,this),this.on("pickChange",r,this),this.view.on("pickChange",r,this),this.view.on("submit",s,this),this.view.on("changeEngine",t,this),this.view.on("packageChange",this.packageChange,this),this.view.on("vpcChange",this.loadSubnet,this),this.view.on("zoneChange",this.zoneChange,this),this.view.on("cloneTypeChange",this.cloneTypeChange,this),this.view.on("checkCloneTime",this.checkCloneTime,this),this.view.on("cloneSetChange",this.checkEnablePurchase,this),this.view.on("seriesChange",this.seriesChange,this);var e=this;if("rdsproxy"!==this.model.get("type")?this.model.checkQuota().then(function(t){e.model.set("quotaCheck",t),e.checkQuotaBalance(),e.checkEnablePurchase()}):this.setNodeQps(),this.checkQuotaBalance(),this.subnetsInfo={isEmptyMainSubnet:!1,isEmptyBackupSubnet:!1},this.model.get("instanceId")){var l="rdsproxy"===this.model.get("type");if(this.view.get("aZoneTip").hide(),!l){var d=this.model.get("instance").engineVersion;this.view.get("engineVersion").datasource=[{name:d,value:d}],this.view.get("engineVersion").selectedIndex=0,this.view.get("engineVersion").repaint()}if("clone"!==this.model.get("type")){this.model.productType="postpay";this.view.get("productType").removeAt(0),this.view.get("numberReduce").disable(),this.view.get("buyNumber").disable(),this.view.get("numberPlus").disable(),this.view.get("numberTip").setText(l?"代理实例仅可购买一个":"只读实例一次只能购买一个")}else this.view.get("numberTip").setText("克隆实例一次最多可购买5个")}this.buyNumber=1,this.loadSubnet(),this.setAvalibleConfig(),"clone"===this.model.get("type")&&(this.cloneTypeChange("withoutRequest"),this.view.get("cloneTime").setProperties({rawValue:u(this.model.get("backupEndTime")).subtract(1,"second").toDate(),range:{begin:new Date(u(this.model.get("backupStartTime")).format("YYYY/MM/DD 00:00:00"))||new Date,end:new Date(u(this.model.get("backupEndTime")).format("YYYY/MM/DD 23:59:59"))||new Date}})),this.model.get("rdsEnable")||this.model.activeRds();var m=new Date(this.model.get("backupStartTime")).getTime(),h=new Date(this.model.get("backupEndTime")).getTime();p(".cloneTimeTips").css({display:"inline-block",color:"#999"}).text("（时间范围:"+u(m).format("YYYY-MM-DD HH:mm:ss")+" ~ "+u(h).format("YYYY-MM-DD HH:mm:ss")+"）")},e.prototype.setNodeQps=function(){var e=this.view.get("nodeAmount").getValue();p(".qps-num").text(5e3*e)},e.prototype.zoneChange=function(){this.loadSubnet(),this.setAvalibleConfig()},e.prototype.engineVersionChange=function(){this.setAvalibleConfig()},e.prototype.seriesChange=function(){var e=this.view.get("series").getValue(),t=this.view.get("engine").getValue(),n=this.view.get("engineVersion"),i=v.ENGINE_INFO[t].seriesInfo[e];n.setProperties({datasource:i.versions,selectedIndex:0}),r.call(this)},e.prototype.loadSubnet=function(){var e=this,t={},n=[],i=this.view.get("logicalZone").getValue().split(","),a=this.view.get("vpc").getValue(),r=this.view.get("subnet"),s=this.view.get("backupSubnet"),o=this.view.get("backupSubnetPanel");o.hide(),this.view.get("subnetLabel").setText(m.getLabel(i[0])+"子网"),n.push(this.model.getSubnetList(a,i[0]).then(function(e){e.length?r.setProperties({datasource:e,disabled:!1}):(t.isEmptyMainSubnet=!0,r.setProperties({datasource:[{name:"没有数据",value:""}],disabled:!0}))})),i.length>1&&(this.view.get("backupSubnetLabel").setText(m.getLabel(i[1])+"子网"),o.show(),n.push(this.model.getSubnetList(a,i[1]).then(function(e){e.length?s.setProperties({datasource:e,disabled:!1}):(t.isEmptyBackupSubnet=!0,s.setProperties({datasource:[{name:"没有数据",value:""}],disabled:!0}))}))),d.all(n).then(function(){e.subnetsInfo=t,e.checkEnablePurchase()})},e.prototype.checkEnablePurchase=function(){var e=this.view.get("backupSubnetLabelTip"),t=this.view.get("subnetLabelTip"),n=this.model.productType,i=!1;this.billingStatus[n].checked&&this.billingStatus[n].enable&&(i=!0),t.hide(),e.hide();var a=!0;if("clone"===this.model.get("type")){var r=this.view.get("cloneType").getValue(),s=this.view.get("cloneSet").getValue();a=!("snapshot"===r&&!s||"datetime"===r&&!this.isCloneTimeAvilible)}this.subnetsInfo.isEmptyMainSubnet||this.subnetsInfo.isEmptyBackupSubnet||this.hasWarning||!a||!i?(this.view.get("buyBucket").disable(),this.subnetsInfo.isEmptyMainSubnet?t.show():this.subnetsInfo.isEmptyBackupSubnet&&e.show()):this.view.get("buyBucket").enable()},e.prototype.getFormData=function(){var e=this.view,t={},n=e.get("logicalZone").getValue(),i=n.split(","),a=e.get("vpc").getValue(),r=e.get("subnet").getValue(),s=i[0]+":"+r;i.length>1&&(s+=","+i[1]+":"+e.get("backupSubnet").getValue());var o=this.model.get("instance");if("rdsproxy"===this.model.get("type")){var c=e.get("nodeAmount").getValue();t={instance:{engine:"rdsproxy",engineVersion:o.engineVersion,nodeAmount:c,azone:n,vpcId:a,subnetId:s},number:1,productType:"postpay"}}else{var d=e.get("engine").getValue(),u=e.get("engineVersion").getValue(),p=e.get("series")&&e.get("series").getValue();"single"===p&&(u="2012");var m=e.get("packageSelect").getValue(),h=v.PACKAGE_MAP[m].cpu,g=v.PACKAGE_MAP[m].memory,f=+e.get("allocatedStorageInGB").getValue(),y=+e.get("purchaseLength").getValue(),x=this.model.productType;t={instance:{engine:d,engineVersion:u,cpuCount:h,allocatedMemoryInGB:g,allocatedStorageInGB:f,azone:n,vpcId:a,subnetId:s},number:this.buyNumber,productType:x},p&&(l.extend(t.instance,{isEnhanced:"triple"===p}),"financial"===p&&(t.instance.instanceType="financial"))}if("clone"===this.model.get("type")){var w=this.model.get("instance");l.extend(t.instance,{initialDataReference:{instanceShortId:w.instanceShortId||w.instanceId,instanceId:this.model.get("instanceId"),referenceType:this.view.get("cloneType").getValue(),datetime:b.timeToUtc(this.view.get("cloneTime").getValue()),snapshotId:this.view.get("cloneSet").getValue()}})}return this.model.get("instanceId")&&"clone"!==this.model.get("type")&&l.extend(t.instance,{sourceInstanceId:this.model.get("instanceId"),isEnhanced:"enhanced"===o.applicationType}),"prepay"===x&&(l.extend(t,{duration:y}),this.view.get("autoRenew").getValue()&&l.extend(t,{autoRenewTimeUnit:this.view.get("autoRenewTimeUnit").getValue(),autoRenewTime:+this.view.get("autoRenewTime").getValue()})),t},e.prototype.packageChange=function(){this.checkStorageLimit(),r.call(this),this.hasPackageChanged=!0},e.prototype.checkStorageLimit=function(e){g.getCurrentRegion().id;var t=this.view.get("engine").getValue(),n=l.deepClone(v.ENGINE_INFO[t]),i=!!this.model.get("instance"),a=this.view.get("packageSelect");e=e||(a?a.getValue():"");var r=i?this.model.get("instance").allocatedStorageInGB:n.minStorage,s=v.PACKAGE_MAP[e].maxStorage,o=this.view.get("logicalZone").getValue(),c=this.model.get("zonePackageLimit")[o].maxStorage,d=this.model.get("isWhiteAccount").storageAndMemory?c:l.min([s,c]),u=this.view.get("allocatedStorageInGB").getRawValue();d=l.max([r,d]),y.isFinancialRegion()&&r<100&&(r=100),u=l.min([l.max([u,r]),d]),this.view.get("allocatedStorageInGB").setProperties({min:r,max:d}),this.view.get("allocatedStorageInGB").setValue(u)},e.prototype.setAvalibleConfig=function(){var e=g.getCurrentRegion().id,t=this.view.get("series");y.isFinancialRegion()&&"raft"===this.model.get("rdsType")&&t&&t.setProperties({datasource:[{name:"raft金融版",value:"financial"}],showNum:1,selectedIndex:0});var n=this.view.get("engine").getValue(),i=l.deepClone(v.ENGINE_INFO[n]);if(this.view.get("logicalZone").getValue().match(",")||"sqlserver"!==n||l.contains(["hk02","hkg"],e))y.isFinancialRegion()?"fwh"===e&&"raft"!==this.model.get("rdsType")&&t&&t.setProperties({datasource:[{name:"双机高可用版",value:"double"}],showNum:1,selectedIndex:0}):t&&t.setProperties({datasource:[{name:"双机高可用版",value:"double"}],showNum:1,selectedIndex:0});else{var a=t?t.getValue():"";t&&t.setProperties({datasource:[{name:"单机基础版",value:"single"},{name:"双机高可用版",value:"double"}],showNum:2,selectedIndex:"double"===a?1:0})}var s=this.view.get("packageSelect"),o=s?s.getValue():"",c=this.view.get("logicalZone").getValue(),d=this.model.get("zonePackageLimit"),u=l.deepClone(i.availablePackage);y.isFinancialRegion()&&"raft"===this.model.get("rdsType")&&(u=i.enhancedPackage),u=l.filter(u,function(e){var t=v.PACKAGE_MAP[e];return t.cpu<=d[c].maxCpuCount&&t.memory<=d[c].maxMemory});var p=l.map(u,function(e){var t=v.PACKAGE_MAP[e];return{name:t.type+" "+t.cpu+"核"+t.memory+"G",value:e}});this.hasPackageChanged=!1,s&&s.setProperties({datasource:p,value:o}),this.hasPackageChanged||r.call(this),o=s?s.getValue():"",this.checkStorageLimit(o)},e.prototype.cloneTypeChange=function(e){"datetime"===this.view.get("cloneType").getValue()?(this.view.get("cloneTimePanel").show(),this.view.get("cloneSetPanel").hide(),this.checkCloneTime()):(this.view.get("cloneTimePanel").hide(),this.view.get("cloneSetPanel").show(),this.checkEnablePurchase()),"withoutRequest"!==e&&r.call(this)},e.prototype.checkCloneTime=function(){if("datetime"===this.view.get("cloneType").getValue()){var e=this,t=this.view.get("cloneTime").getValue();this.getTimeAviliable&&clearTimeout(this.getTimeAviliable),this.getTimeAviliable=setTimeout(function(){e.model.rdsBinlogCheck({instanceId:e.model.get("instanceId"),date:b.timeToUtc(t)}).then(function(t){e.isCloneTimeAvilible=!0,e.checkEnablePurchase()},function(t){e.isCloneTimeAvilible=!1,e.checkEnablePurchase()})},1e3)}},e.prototype.checkQuotaBalance=function(){var e=this,t=this.view.get("warningPanel"),n=this.model.productType,i=!1,a="";if(this.model.get("disableCreate"))return this.view.get("buyBucket").disable(),t.setContent("售罄！请您移步其他地域购买资源。"),void t.show();if(this.billingStatus[n].checked||this.billingStatus[n].isChecking||(this.billingStatus[n].isChecking=!0,this.model.checkBilling(n).then(function(t){e.billingStatus[n].checked=!0,e.billingStatus[n].enable=t.status,e.billingStatus[n].reason=t.failReason,e.checkQuotaBalance(),e.checkEnablePurchase()}).ensure(function(){e.billingStatus[n].isChecking=!1})),!this.model.get("quotaCheck")){i=!0;a+="您创建的"+(this.model.get("instanceId")?"RDS只读实例":"RDS实例")+'已达到限额，如需增加配额请到<a href="'+h.domains.ticket+'">工单</a>申请'}this.billingStatus[n].checked&&!this.billingStatus[n].enable&&(i=!0,a=a?a+"<br>":"",a+=this.billingStatus[n].reason+' <a href="/billing/#/account/recharge">立即充值</a>'),i?(this.view.get("buyBucket").disable(),t.setContent(a),t.show()):(this.view.get("buyBucket").enable(),t.hide()),this.hasWarning=i},e.prototype.modelType=require("./CreateModel"),e.prototype.viewType=require("./CreateView"),require("er/util").inherits(e,c),e}),define("rds/create.tpl",[],function(){return'\x3c!-- target: TPL_rds_create --\x3e\r\n<div class="rds-create rds-main-wrap main-wrap-new">\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e\r\n            \x3c!-- if: ${type} === "rdsproxy" --\x3e购买RDS代理实例\r\n            \x3c!-- elif: ${type} === "clone" --\x3e购买RDS克隆实例\r\n            \x3c!-- elif: ${instanceId} --\x3e购买RDS只读实例\r\n            \x3c!-- else --\x3e购买RDS\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        <div class="create-content">\r\n            <div data-ui-type="ViewStep"\r\n                    data-ui-id="buyStep"\r\n                    data-ui-current-step="1">\r\n                <ul>\r\n                    <li bind-for="tab1">选购RDS</li>\r\n                    <li bind-for="tab2">确认订单</li>\r\n                    <li >支付成功</li>\r\n                </ul>\r\n            </div>\r\n\r\n            <div id="tab1" class="ui-tab-content">\r\n                <div data-ui-type="Tab" data-ui-id="productType"\r\n                 data-ui-active-index="0" class="bec-tab">\r\n                    <ul data-role="navigator" class="ui-tab-navigator">\r\n                        <li class="ui-tab-item">\r\n                            <span>预付费</span>\r\n                        </li>\r\n                        <li class="ui-tab-item">\r\n                            <span>后付费</span>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n                <p data-ui-type="ToastLabel"\r\n                    data-ui-id="warningPanel"\r\n                    data-ui-message-type="alert"\r\n                    data-ui-hidden="true"\r\n                    class="warning-panel">\r\n                </p>\r\n\r\n                <div class="create-main">\r\n                    <div class="detail-parts-table">\r\n                        <form class="pick-rds-form" data-ui-type="Form" data-ui-id="form">\r\n                            <div data-ui-id="buyBucket" data-ui-type="BuyBucket"></div>\r\n                            \x3c!-- if: ${instanceId} --\x3e\r\n                                <dl class="detail-part-1-col detail-create master-instance-config">\r\n                                    <dt><h4>\x3c!-- if: ${type} === "clone" --\x3e原\x3c!-- else --\x3e主\x3c!-- /if --\x3e实例配置</h4></dt>\r\n                                    <dd>\r\n                                        <div class="detail-cell">\r\n                                            <label>名称：</label>\r\n                                            <span title="${instance.instanceName}">\r\n                                                ${instance.instanceName}\r\n                                            </span>\r\n                                        </div>\r\n                                        <div class="detail-cell">\r\n                                            <label>ID：</label>\r\n                                            <span title="${instance.instanceShortId}">\r\n                                                ${instance.instanceShortId}\r\n                                            </span>\r\n                                        </div>\r\n                                    </dd>\r\n                                    <dd>\r\n                                        <div class="detail-cell">\r\n                                            <label>地域：</label>\r\n                                            <span title="${regionName}">${regionName}</span>\r\n                                        </div>\r\n                                        <div class="detail-cell">\r\n                                            <label>数据库类型：</label>\r\n                                            <span title="${instance.engine}">\r\n                                                ${instance.engine}\r\n                                                </span>\r\n                                        </div>\r\n                                    </dd>\r\n                                    <dd>\r\n                                        <div class="detail-cell">\r\n                                            <label>版本号：</label>\r\n                                            <span title="${instance.engineVersion}">\r\n                                                ${instance.engineVersion}\r\n                                                </span>\r\n                                        </div>\r\n                                        <div class="detail-cell">\r\n                                            <label>存储空间：</label>\r\n                                            <span title="${instance.allocatedStorageInGB}">\r\n                                                ${instance.allocatedStorageInGB}GB\r\n                                                </span>\r\n                                        </div>\r\n                                    </dd>\r\n                                    <dd>\r\n                                        <div class="detail-cell">\r\n                                            <label>CPU：</label>\r\n                                            <span title="${instance.cpuCount}">\r\n                                                ${instance.cpuCount} 核\r\n                                                </span>\r\n                                        </div>\r\n                                        <div class="detail-cell">\r\n                                            <label>内存：</label>\r\n                                            <span title="${instance.allocatedMemoryText}">\r\n                                                ${instance.allocatedMemoryText}\r\n                                                </span>\r\n                                        </div>\r\n\r\n                                    </dd>\r\n                                    <dd>\r\n                                        <div class="detail-cell">\r\n                                            <label>可用区：</label>\r\n                                            <span>\r\n                                                ${instance.azoneText}\r\n                                                </span>\r\n                                        </div>\r\n                                        <div class="detail-cell">\r\n                                            <label>所在网络：</label>\r\n                                            <span title="${instance.vpcText}">\r\n                                                ${instance.vpcText}\r\n                                                </span>\r\n                                        </div>\r\n                                    </dd>\r\n                                    <dd>\r\n                                        <div class="detail-cell">\r\n                                            <label>子网：</label>\r\n                                            <span title="${instance.subnetText}">\r\n                                                ${instance.subnetText}\r\n                                                </span>\r\n                                        </div>\r\n                                    </dd>\r\n                                </dl>\r\n                            \x3c!-- /if --\x3e\r\n                            <dl class="detail-part-1-col detail-create">\r\n                                <dt>\r\n                                    <h4>地域信息</h4>\r\n                                </dt>\r\n                                <dd>\x3c!-- import: TPL_common_partial_create_current_region --\x3e</dd>\r\n                                <dd>\r\n                                    <label>可用区：</label>\r\n                                    <div>\r\n                                        <span data-ui-type="Select"\r\n                                            data-ui-id="logicalZone"\r\n                                            data-ui-name="logicalZone"></span>\r\n                                            <span data-ui-type="Tip"\r\n                                                data-ui-id="aZoneTip"\r\n                                                data-ui-content="${tips.rdsAZoneTip}"\r\n                                                data-ui-skin="warning"\r\n                                                class="doc-link"></span>\r\n                                    </div>\r\n                                </dd>\r\n                            </dl>\r\n                            \x3c!-- if: ${type} === "clone" --\x3e\r\n                            <dl class="detail-part-1-col detail-create">\r\n                                <dt>\r\n                                    <h4>数据恢复</h4>\r\n                                </dt>\r\n                                <dd>\r\n                                    <label>还原方式：</label>\r\n                                    <div>\r\n                                        <span data-ui-type="RadioSelect"\r\n                                            data-ui-id="cloneType"\r\n                                            data-ui-name="cloneType"></span>\r\n                                    </div>\r\n                                </dd>\r\n                                <dd data-ui-type="Panel" data-ui-id="cloneTimePanel" class="form-row">\r\n                                    <label class="required-label">还原时间：</label>\r\n                                    <div>\r\n                                        <span data-ui-type="Calendar"\r\n                                            data-ui-id="cloneTime"\r\n                                            data-ui-name="cloneTime"></span>\r\n                                            <span class="cloneTimeTips"></span>\r\n                                    </div>\r\n                                </dd>\r\n                                <dd data-ui-type="Panel" data-ui-id="cloneSetPanel" class="form-row">\r\n                                    <label class="required-label">备份集：</label>\r\n                                    <div>\r\n                                        <span data-ui-type="Select"\r\n                                            data-ui-id="cloneSet"\r\n                                            data-ui-name="cloneSet"></span>\r\n                                    </div>\r\n                                </dd>\r\n                            </dl>\r\n                            \x3c!-- /if --\x3e\r\n                            <dl class="detail-part-1-col detail-create">\r\n                                <dt>\r\n                                    <h4>配置信息</h4>\r\n                                </dt>\r\n                                <dd>\r\n                                    <p class="tip-yellow inline-block">因可用区资源动态变化，可选规格为该可用区当前支持的规格</p>\r\n                                </dd>\r\n                                <dd>\r\n                                    <label>数据库类型：</label>\r\n                                    <div class="form-value">\r\n                                        <div data-ui-id="engine" data-ui-type="RadioSelect" class="ui-radioselect-custom"></div>\r\n                                    </div>\r\n                                </dd>\r\n                                \x3c!-- if: ${type} === "rdsproxy" --\x3e\r\n                                <dd>\r\n                                    <label>资源规格：</label>\r\n                                    <div class="form-value">\r\n                                        <span data-ui-type="Select"\r\n                                            data-ui-id="nodeAmount"\r\n                                            data-ui-name="nodeAmount"></span>\r\n                                            <div data-ui-type="Tip" data-ui-content="${tips.rdsproxyConfigTip}" class="config-tip ui-radioselect-custom" ></div>\r\n                                            <span class="tps-tips">参考QPS：<span class="qps-num">5000</span> </span>\r\n                                    </div>\r\n                                </dd>\r\n                                \x3c!-- else --\x3e\r\n                                \x3c!-- if: !${instanceId} || ${type} === \'clone\' --\x3e\r\n                                <dd>\r\n                                    <label>系列：</label>\r\n                                    <div class="form-value">\r\n                                        <div data-ui-id="series" data-ui-type="RadioSelect" class="ui-radioselect-custom"></div>\r\n                                    </div>\r\n                                </dd>\r\n                                \x3c!-- /if --\x3e\r\n                                <dd>\r\n                                    <label>版本：</label>\r\n                                    <div class="form-value">\r\n                                        <div data-ui-id="engineVersion" data-ui-type="RadioSelect" class="ui-radioselect-custom"></div>\r\n                                    </div>\r\n                                </dd>\r\n                                <dd>\r\n                                    <label>规格：</label>\r\n                                    <div class="form-value">\r\n                                        <span  class="package-select"\r\n                                            data-ui-type="Select"\r\n                                            data-ui-id="packageSelect"\r\n                                            data-ui-width="200"></span>\r\n                                        <span data-ui-type="Tip"\r\n                                            data-ui-id="packageTip"\r\n                                            data-ui-content="${tips.packageTip}"\r\n                                            data-ui-layer-width="320"\r\n                                            data-ui-skin="normal" class="package-tip"></span>\r\n                                        <esui-label class="row-tips"\r\n                                            data-ui-type="Label"\r\n                                            data-ui-id="memoryTip">最大连接数:1000</esui-label>\r\n\r\n                                    </div>\r\n                                </dd>\r\n                                <dd>\r\n                                    <label>存储磁盘：</label>\r\n                                    <div class="form-value">\r\n                                        <div data-ui-id="allocatedStorageInGB"\r\n                                             data-ui-name="storage"\r\n                                             data-ui-type="Dragger"\r\n                                             class="storage-dragger"></div>\r\n                                        <p class="storage-tip">\r\n                                            磁盘大小必须为5的倍数\r\n                                        </p>\r\n                                    </div>\r\n                                </dd>\r\n                                \x3c!-- /if --\x3e\r\n                                <dd>\r\n                                    <label>网络类型：</label>\r\n                                    <div>\r\n                                        <div class="network-section">\r\n                                            所在网络：<br>\r\n                                            <span data-ui-type="Select" data-ui-id="vpc" class="vpc-select"></span>\r\n                                        </div>\r\n                                        <div class="network-section">\r\n                                            <div data-ui-type="Label" data-ui-id="subnetLabel" ></div>\r\n                                            <span data-ui-type="Select" data-ui-id="subnet" data-ui-name="subnetUuid"></span>\r\n                                            <p data-ui-type="Label" data-ui-id="subnetLabelTip" data-ui-hidden=\'true\' class="subnet-invalid-tips">该自定义私有网络在该可用区没有子网，请先创建子网或选择其他VPC</p>\r\n                                        </div>\r\n                                        <div data-ui-type="Panel" data-ui-id="backupSubnetPanel" data-ui-hidden=true class="network-section">\r\n                                            <div data-ui-type="Label" data-ui-id="backupSubnetLabel" ></div>\r\n                                            <span data-ui-type="Select" data-ui-id="backupSubnet" data-ui-name="backupSubnetUuid"></span>\r\n                                            <p data-ui-type="Label" data-ui-id="backupSubnetLabelTip" data-ui-hidden=\'true\' class="subnet-invalid-tips">该自定义私有网络在该可用区没有子网，请先创建子网或选择其他VPC</p>\r\n                                        </div>\r\n                                        <span data-ui-type="Tip"\r\n                                            data-ui-id="subnetTip"\r\n                                            data-ui-content="${tips.rdsSubnetTip}"\r\n                                            data-ui-skin="warning" class="subnet-tip"></span>\r\n                                    </div>\r\n                                </dd>\r\n                            </dl>\r\n                            <dl class="detail-part-1-col detail-create">\r\n                                <dt>\r\n                                    <h4>购买信息</h4>\r\n                                </dt>\r\n                                <dd data-ui-type="Panel" data-ui-id="panelPurchaseLength" class="form-row">\r\n                                    <label>购买时长：</label>\r\n                                    <div class="form-value">\r\n                                        <div data-ui-id="purchaseLength" data-ui-name="purchaseLength"\r\n                                             data-ui-type="RadioSelect" class="ui-radioselect-pl"></div>\r\n                                    </div>\r\n                                </dd>\r\n                                <dd>\r\n                                    <label>购买台数：</label>\r\n                                    <div class="form-value">\r\n                                        <p class="number-select ui-group">\r\n                                            <span class="number-reduce"\r\n                                                data-ui-type="Button"\r\n                                                data-ui-id="numberReduce">-</span>\r\n                                            <span class="type-select number-input"\r\n                                                 data-ui-type="Select"\r\n                                                 data-ui-id="buyNumber"\r\n                                                 data-ui-selected-index="0"></span>\r\n                                            <span class="number-plus"\r\n                                                data-ui-type="Button"\r\n                                                data-ui-id="numberPlus">+</span>\r\n                                            <esui-label class="row-tips"\r\n                                                    data-ui-type="Label"\r\n                                                    data-ui-id="numberTip">一次最多购买10台</esui-label>\r\n                                        </p>\r\n                                    </div>\r\n                                </dd>\r\n                                <dd data-ui-id="renewPanel" data-ui-type="Panel">\r\n                                    <label>自动续费：</label>\r\n                                    <div>\r\n                                        <span data-ui-type="ToggleButton"\r\n                                              data-ui-id="autoRenew"\r\n                                              data-ui-name="autoRenew"></span>\r\n                                        <a  href="https://cloud.baidu.com/doc/Finance/Renew/24.5C.E8.87.AA.E5.8A.A8.E7.BB.AD.E8.B4.B9.html" target="_blank">什么是自动续费？</a><br>\r\n                                        <div data-ui-id="autoRenewPanel" data-ui-type="Panel" data-ui-hidden="true">\r\n                                            <div class="auto-renew-item">\r\n                                                <label>选择续费周期：</label>\r\n                                                <div class="ui-group ui-select-group">\r\n                                                    <div data-ui-type="Select" data-ui-id="autoRenewTimeUnit" data-ui-name="autoRenewTimeUnit"></div>\r\n                                                    <div data-ui-type="Select" data-ui-id="autoRenewTime" data-ui-name="autoRenewTime"></div>\r\n                                                </div>\r\n                                                <span data-ui="type:Label;id:expireTimeLabel;" class="renew-expire-time"></span>\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n                                </dd>\r\n                            </dl>\r\n                        </form>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n            <div id="tab2" class="ui-tab-content">\r\n                <div class="ui-tab-navigator">\r\n                    <h1>确认订单</h1>\r\n                </div>\r\n                <div data-ui="id:orderAction;type:ActionPanel"></div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/CreateModel",["require","bat-ria/mvc/FormModel","underscore","moment","common/region","common/zone","common/util","common/util/moneyUtil","common/enum","./tips","./config","./enums","./helper","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/FormModel"),n=require("underscore"),i=require("moment"),a=require("common/region"),r=require("common/zone"),s=require("common/util"),o=require("common/util/moneyUtil"),c=require("common/enum").AllRegion,l=require("./tips"),d=require("./config"),u=d.api,p=require("./enums"),m=p.TimeType,h=require("./helper");return e.prototype.datasource={instance:function(e){if(e.get("instanceId"))return u.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){e.instanceShortId=e.instanceShortId||e.instanceId,e.allocatedMemoryText=e.allocatedMemoryInGB<1?parseInt(1024*e.allocatedMemoryInGB,10)+"MB":e.allocatedMemoryInGB+"GB",e.azoneText=r.getLabel(e.azone),e.vpcText=s.getVpcName(e.vpcName)+(e.vpcCidr?"("+e.vpcCidr+")":"");var t=n.map(e.subnets,function(e){return s.getSubnetName(e.name)+(e.cidr?"("+e.cidr+")":"")});return e.subnetText=t.join("+")||"-",e})},quotaCheck:function(e){return!0},vpcDatasource:function(e){return u.rdsVpcList({},{"X-silence":!0}).then(function(e){var t=[];return n.each(e||[],function(e){var n=s.getVpcName(e.name)+(e.cidr?"("+e.cidr+")":"");t.push({value:e.vpcId,text:n,title:n})}),t})},subnetDatasource:function(e){return[{name:"加载中...",value:""}]},zoneDatasource:function(e){return u.rdsZoneList().then(function(t){var i=t.zones||[],a={};e.get("instanceId")&&!e.get("type")&&(i=n.filter(i,function(e){return 1===e.zoneNames.length}));var s=n.map(i,function(e){var t=e.zoneNames.join(","),n=r.getLabel(t);return a[t]=e,{value:t,name:n+(e.available?"":"(售罄)"),disabled:!e.available}});return e.set("zonePackageLimit",a),s})},backupSet:function(e){return e.get("instanceId")&&"clone"===e.get("type")?u.rdsBackupListClone({instanceId:e.get("instanceId")}).then(function(t){var a=n.filter(t.snapshots,function(e){return e.snapshotEndTime&&e.snapshotId&&"available"===e.snapshotStatus});t.period&&t.period.begin&&t.period.end&&(e.set("backupStartTime",i(t.period.begin).toDate()),e.set("backupEndTime",i(t.period.end).toDate()));var r=n.map(a,function(e){return{name:i(e.snapshotEndTime).format("YYYY-MM-DD HH:mm:ss"),value:e.snapshotId}});return n.union([{name:"请选择",value:""}],r)}):[]},isWhiteAccount:function(){return u.rdsIsWhiteAccount()},rdsEnable:function(){return!!s.isSubUser()||u.rdsStsRoleQuery({roleName:"BceServiceRole_console_rds"},{"x-silent":!0})},disableCreate:function(){return a.getCurrentRegion().id===c.HK02}},e.prototype.checkQuota=function(){return"clone"!==this.get("type")&&this.get("instanceId")?u.rdsCheckReplicaQuota({instanceId:this.get("instanceId")}):u.rdsCheckMasterQuota()},e.prototype.checkBilling=function(e){return u.getRdsPurchaseValidation({serviceType:"RDS",productType:e})},e.prototype.setDefaultEngineInfo=function(){var e=this,t=this.get("instance"),i=!!t,r=a.getCurrentRegion().id,s=[];n.each(d.ENGINE_INFO,function(e,t){n.contains(e.regions,r)&&(e.isRealType&&!i||e.hasReadOnly)&&s.push({name:e.name,value:t})}),"fwh"===r&&"raft"===this.get("rdsType")&&(s=s.slice(0,1)),this.set("engineList",s);var o=0,c="MySQL";this.get("engine")&&n.each(s,function(t,n){t.value===e.get("engine")&&(o=n,c=t.value)}),this.set("engineIndex",o);var l=[],u="2";if("rdsproxy"===this.get("type")){l=n.map(d.NODE_MAP,function(e,t){return{value:t,name:e}});u=function(e){var t="2";return e<=2?t="2":e<=8?t="4":e<=24?t="6":e<=64?t="8":e>64&&(t="16"),t}(t.allocatedMemoryInGB)}this.set("proxyNodes",l),this.set("defaultProxyNode",u);var p=n.deepClone(d.ENGINE_INFO[c].version);"raft"===this.get("rdsType")&&h.isFinancialRegion()&&(p=p.slice(1,2)),this.set("defaultEngineVersion",p);var m="MySQL"===c?h.isFinancialRegion()?0:1:0;"fwh"===r&&"raft"!==this.get("rdsType")&&(m=1),this.get("version")&&n.each(p,function(t,n){t.value===e.get("version")&&(m=n)}),this.set("engineVersionIndex",m);var g=[{name:"双机高可用版",value:"double"}],f=0;"sqlserver"===c&&"2012sp3"===p[m].value&&g.unshift({name:"单机基础版",value:"single"});var b=e.get("series")||"double";if(n.each(g,function(e,t){e.value===b&&(f=t)}),this.set("seriesIndex",f),this.set("defaultSeries",g),i&&"clone"!==this.get("type")){var v=n.find(this.get("vpcDatasource"),function(e){return e.value===t.vpcId});this.set("vpcDatasource",v?[v]:[])}var y=n.map(d.ENGINE_INFO[c].availablePackage,function(e){var t=d.PACKAGE_MAP[e];return{name:t.type+" "+t.cpu+"核"+t.memory+"G",value:e}});this.set("defaultPackages",y),this.set("defaultPackage","C1M1");var x=d.ENGINE_INFO[c].minStorage;h.isFinancialRegion()&&(x=100),i&&(x=n.max([x,this.get("instance").allocatedStorageInGB])),this.set("defaultStorageValue",+this.get("storage")||x),this.set("defaultStorage",{min:x,max:d.ENGINE_INFO[c].maxStorage})},e.prototype.prepare=function(){for(var e=this.get("instance"),t="clone"===this.get("type")?5:10,i=[],s=1;s<=t;s++)i.push({name:s,value:s});this.set("buyNumberDatasource",i),this.set("regionName",a.getCurrentRegion().label),this.set("tips",l),this.setDefaultEngineInfo();var c=this.get("tips").saleTip,u=[{name:"1个月",value:1},{name:"2",value:2},{name:"3",value:3},{name:"4",value:4},{name:"5",value:5},{name:"6",value:6},{name:"7",value:7},{name:"8",value:8},{name:"9",value:9},{name:"1年",value:12,hoverContent:c[12]},{name:"2年",value:24,hoverContent:c[24]},{name:"3年",value:36,hoverContent:c[36]}];this.set("purchaseLenDatasource",u);var h=p.recoveryType.toArray(),g=this.get("backupSet");g&&1===g.length&&(h[0].disable=!0),this.set("cloneType",h),this.set("disableVpc",this.get("instanceId")&&"clone"!==this.get("type"));var f=[{title:"地域：",content:function(e){return a.getCurrentRegion().label}},{title:"可用区：",content:function(e){return e.instance?r.getLabel(e.instance.azone):"-"}},{title:"购买配置：",content:function(e){if(!e.instance)return"-";if("rdsproxy"===e.instance.engine)return"MySQL、"+d.NODE_MAP[e.instance.nodeAmount];var t=e.instance||{},i=t.engine,a="";n.each(d.ENGINE_INFO[i].version,function(e){e.value===t.engineVersion&&(a=e.name)});var r="";return e.isReplica||(r="双机高可用版、","2012"===t.engineVersion&&(r="单机基础版、",a="2012"),t.isEnhanced&&(r="三节点增强版、")),"financial"===t.instanceType&&(r="raft金融版、"),d.ENGINE_INFO[i].name+"("+a+")、"+r+"内存"+d.MEMORY_MAP[t.allocatedMemoryInGB]+"、存储磁盘"+t.allocatedStorageInGB+"GB"}},{title:"购买配额：",content:function(e){var t="";if(e.duration&&(t="<br>未开通自动续费"),e.autoRenewTime){var n=e.autoRenewTimeUnit===m.MONTH?"个月":"年";t="<br>开通自动续费/"+e.autoRenewTime+n}return(e.duration?e.number+"个 X "+e.duration+"月":e.number+"个")+t}},{title:"配置费用：",content:function(e){if(e.loading)return'<span class="loading">努力加载中...请稍候</span>';var t="postpay"===e.productType,n=o.convertPrice(e.price);return'<span class="price">￥'+(t?n.getPriceOfMinute("/分钟"):n.getPriceOfMinute())+"</span>"}},{title:"公网流量费用：",content:function(e){return e.loading?'<span class="loading">努力加载中...请稍候</span>':'<span class="price">￥'+o.convertPrice(e.trafficInGB).getPriceOfMinute("/GB")+"</span>"}}];"clone"===this.get("type")&&(this.set("defaultZone",e.azone),this.set("defaultVpc",e.vpcId),f.unshift({title:"还原方式：",content:function(e){return e.instance?p.recoveryType.getTextFromValue(e.instance.initialDataReference.referenceType):"-"}})),this.set("buyBucketFields",f)},e.prototype.getSubnetList=function(e,t){var i=this;return u.subnetList({vpcId:e,az:t},{"X-silence":!0}).then(function(e){var t=[],a={};return n.each(e,function(e){var n=s.getSubnetName(e.name)+(e.cidr?"("+e.cidr+")":"");t.push({value:e.subnetId,text:n,title:n}),a[e.subnetId]=n}),n.extend(a,i.get("subnetMap")),i.set("subnetMap",a),t})},e.prototype.rdsBinlogCheck=function(e){return u.rdsBinlogCheck(e,{"X-silence":!0})},e.prototype.rdsGetPrice=function(e){var t=n.deepClone(e);return t.instance.initialDataReference&&delete t.instance.initialDataReference.instanceShortId,u.rdsGetPrice(t,{"X-silence":!0})},e.prototype.activeRds=function(){return u.rdsInstanceParam({},{"x-silent":!0}).then(function(e){return u.rdsStsRoleActive(e,{"x-silent":!0})})},e.prototype.productType="prepay",e.prototype.defaultArgs={},require("er/util").inherits(e,t),e}),define("rds/CreateView",["require","bat-ria/tpl!./create.tpl","bat-ria/mvc/FormView","inf-ria/app/brpc","underscore","./enums","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./create.tpl");var t=require("bat-ria/mvc/FormView"),n=require("inf-ria/app/brpc"),i=require("underscore"),a=require("./enums"),r=a.TimeType,s=a.Month,o=a.Year;return e.prototype.template="TPL_rds_create",e.prototype.uiProperties={tips:"@tips",engine:{datasource:"@engineList",selectedIndex:"@engineIndex"},engineVersion:{datasource:"@defaultEngineVersion",selectedIndex:"@engineVersionIndex"},packageSelect:{datasource:"@defaultPackages",value:"@defaultPackage",width:170,height:30},allocatedStorageInGB:{max:"@defaultStorage.max",min:"@defaultStorage.min",value:"@defaultStorageValue",step:5,length:349,unit:"GB"},buyNumber:{width:100,datasource:"@buyNumberDatasource"},purchaseLength:{datasource:"@purchaseLenDatasource",selectedIndex:0},buyBucket:{fields:"@buyBucketFields",value:{},offsetTop:20,confirmBtn:{text:"下一步",skin:"skin-primary-button"}},logicalZone:{datasource:"@zoneDatasource",value:"@defaultZone",width:120},vpc:{width:200,datasource:"@vpcDatasource",value:"@defaultVpc",disabled:"@disableVpc"},subnet:{width:200,datasource:"@subnetDatasource"},backupSubnet:{width:200,datasource:"@subnetDatasource"},cloneType:{datasource:"@cloneType",value:"snapshot"},cloneTime:{time:!0},cloneSet:{datasource:"@backupSet"},autoRenewTimeUnit:{datasource:r.toArray()},autoRenewTime:{datasource:s.toArray()},series:{datasource:"@defaultSeries",selectedIndex:"@seriesIndex"},nodeAmount:{datasource:"@proxyNodes",value:"@defaultProxyNode"}},e.prototype.uiEvents={"buyNumber:change":function(){this.fire("numberChange")},"numberReduce:click":function(){this.fire("numberReduce")},"numberPlus:click":function(){this.fire("numberPlus")},"packageSelect:change":function(){this.fire("packageChange")},"allocatedStorageInGB:change":function(){this.fire("pickChange")},"purchaseLength:change":function(){this.fire("pickChange")},"productType:activate":function(e){var t="预付费"===i.trim(e.tab.title)?"prepay":"postpay";"prepay"===t?(this.get("panelPurchaseLength").show(),this.get("renewPanel").show()):(this.get("panelPurchaseLength").hide(),this.get("renewPanel").hide()),this.fire("changeProductType",{productType:t})},"buyBucket:confirm":function(e){e.preventDefault(),this.fire("submit")},"buyBucket:reset":function(e){this.fire("refresh"),e.preventDefault()},"engine:change":function(){this.fire("changeEngine")},"engineVersion:change":function(e){this.fire("pickChange")},"orderAction:action@prevPage":function(){this.renderRdsConfig()},"logicalZone:change":function(){this.fire("zoneChange")},"autoRenew:change":function(e){e.target.isChecked()?(this.get("autoRenewPanel").show(),this.updateExpireTime()):this.get("autoRenewPanel").hide(),this.fire("pickChange")},"vpc:change":function(){this.fire("vpcChange")},"cloneType:change":function(){this.fire("cloneTypeChange")},"cloneTime:change":function(){this.fire("checkCloneTime")},"cloneSet:change":function(){this.fire("cloneSetChange")},"autoRenewTimeUnit:change":function(e){var t=e.target.getValue(),n=this.get("autoRenewTime");t===r.MONTH?n.updateDatasource(s.toArray()):n.updateDatasource(o.toArray()),this.updateExpireTime(),this.fire("pickChange")},"autoRenewTime:change":function(){this.updateExpireTime(),this.fire("pickChange")},"series:change":function(){this.fire("seriesChange")},"nodeAmount:change":function(){this.fire("pickChange")}},e.prototype.renderOrderConfirm=function(e,t){var i=this.get("orderAction"),a=this.get("buyStep"),r=this.get("productType"),s={order:e,config:t};n.invokeService("billing://order_confirm",i,s).then(function(){r.disable(),a.set("currentStep",2)})},e.prototype.updateExpireTime=function(){var e=this.get("autoRenewTimeUnit").getValue(),t="系统将于到期前7天进行扣费，扣费时长为"+this.get("autoRenewTime").getValue()+(e===r.YEAR?"年":"月");this.get("expireTimeLabel").setText(t)},e.prototype.renderRdsConfig=function(){var e=this.get("orderAction");this.get("buyStep").set("currentStep",1),this.get("productType").enable(),e.disposeAction()},require("er/util").inherits(e,t),e}),define("rds/database/config",["require","er/controller"],function(require){require("er/controller").registerAction([{type:"rds/database/Create",path:"/rds/database/create"},{type:"rds/database/List",path:"/rds/database/list"}]);return{}}),define("rds/database/Create",["require","bat-ria/mvc/FormAction","underscore","er/util","../config","../helper","./CreateModel","./CreateView"],function(require){function e(){n.apply(this,arguments)}function t(e){var t=this.view,n=t.get("table"),s=t.get("dbName"),c=s.getRawValue().toLowerCase(),l=i.trim(t.get("remark").getValue()),d=t.get("characterSetName").getValue(),u=[],p=0;if(s.validate())if(i.contains(o,c))s.showValidationMessage("invalid",c+"是系统关键字，不可用");else if(l.replace(/([^\x00-\xff])/g,"$1$1$1").length>256)t.get("remark").showValidationMessage("invalid","备注说明不符合规则：最多256个字符（一个汉字等于三个字符）");else{if(n)for(p=0;p<n.datasource.length;p++)delete n.datasource[p].name,n.datasource[p].authType&&u.push({accountName:n.datasource[p].accountName,authType:n.datasource[p].authType});var m={dbName:i.trim(s.getValue()),remark:l,characterSetName:d,accountPrivileges:u};r.rdsCreateDatabase({instanceId:this.model.get("instanceId"),database:m}).then(a.bind(function(){this.redirect("#/rds/database/list~instanceId="+this.model.get("instanceId")+"&rdsType="+this.model.get("rdsType"))},this)).fail(a.bind(function(e){this.view.showErrorMessage(e.field)},this))}}var n=require("bat-ria/mvc/FormAction"),i=require("underscore"),a=require("er/util"),r=require("../config").api,s=require("../helper"),o=["admin","aurora","replicator","xtrabak","root","mysql","test","eagleye","information_schema","guest","add","analyze","asc","between","blob","call","change","check","condition","continue","cross","current_timestamp","database","day_microsecond","dec","default","desc","distinct","double","each","enclosed","exit","fetch","float8","foreign","goto","having","hour_minute","ignore","infile","insensitive","int1","int4","interval","iterate","keys","leading","like","lines","localtimestamp","longblob","low_priority","mediumint","minute_microsecond","modifies","no_write_to_binlog","on","optionally","out","precision","purge","read","references","rename","require","revoke","schema","select","set","spatial","sqlexception","sql_big_result","ssl","table","tinyblob","to","true","unique","update","using","utc_timestamp","varchar","when","with","xor","all","and","asensitive","bigint","both","cascade","char","collate","connection","convert","current_date","current_user","databases","day_minute","decimal","delayed","describe","distinctrow","drop","else","escaped","explain","float","for","from","grant","high_priority","hour_second","in","inner","insert","int2","int8","into","join","kill","leave","limit","load","lock","longtext","match","mediumtext","minute_second","natural","null","optimize","or","outer","primary","raid0","reads","regexp","repeat","restrict","right","schemas","sensitive","show","specific","sqlstate","sql_calc_found_rows","starting","terminated","tinyint","trailing","undo","unlock","usage","utc_date","values","varcharacter","where","write","year_month","alter","as","before","binary","by","case","character","column","constraint","create","current_time","cursor","day_hour","day_second","declare","delete","deterministic","div","dual","elseif","exists","false","float4","force","fulltext","group","hour_microsecond","if","index","inout","int","int3","integer","is","key","label","left","linear","localtime","long","loop","mediumblob","middleint","mod","not","numeric","option","order","outfile","procedure","range","real","release","replace","return","rlike","second_microsecond","separator","smallint","sql","sqlwarning","sql_small_result","straight_join","then","tinytext","trigger","union","unsigned","use","utc_time","varbinary","varying","while","x509","zerofill","performance_schema"];return e.prototype.initBehavior=function(){n.prototype.initBehavior.apply(this,arguments),s.handleDetailPublicEvent(this),this.view.on("submit",t,this),this.view.on("cancel",function(){this.redirect("#/rds/database/list~instanceId="+this.model.get("instanceId")+"&rdsType="+this.model.get("rdsType"))},this)},e.prototype.modelType=require("./CreateModel"),e.prototype.viewType=require("./CreateView"),require("er/util").inherits(e,n),e}),define("rds/database/create.tpl",[],function(){return'\x3c!-- target: TPL_rds_database_create --\x3e\r\n<div class="rds-database-create rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: other_link_wrapper --\x3e\r\n            <a href="#/rds/database/list~instanceId=${instanceId}&rdsType=${rdsType}">数据库管理</a>\r\n            <span class="divider">/</span>\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e创建账号\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n        \x3c!-- <div class="form-container detail-content"> --\x3e\r\n            <div class="ui-tab-content">\r\n                <form class="create-database-form"\r\n                      data-ui-type="Form"\r\n                      data-ui-id="form">\r\n                    <div class="form-body">\r\n                        <div class="form-row">\r\n                            <label>数据库名称：<i>*</i></label>\r\n                            <div class="form-value">\r\n                                <p>\r\n                                    <input data-ui-type="TextBox"\r\n                                           data-ui-id="dbName"\r\n                                           data-ui-mode="text"\r\n                                           class="dbname-input" />\r\n                                    <label data-ui-type="Validity"\r\n                                           data-ui-id="dbNameValidity"\r\n                                           class="db-name-validity"></label>\r\n                                </p>\r\n                                <p class="tip">由大小写字母、数字、下划线组成、字母开头，字母或数字结尾，最长64个字符</p>\r\n                            </div>\r\n                        </div>\r\n                        <div class="form-row">\r\n                            <label>支持字符集：<i>*</i></label>\r\n                            <div class="form-value">\r\n                                <div data-ui-type="Select" data-ui-id="characterSetName" class="charset-select">\r\n                                </div>\r\n                                \x3c!-- if: ${instance.engine} === \'sqlserver\' --\x3e\r\n                                <span data-ui-type="Tip" data-ui-arrow="1" data-ui-id="charsetTip"\r\n                                    data-ui-content="_CI标记的字符集不分区大小写<br>_CS区分大小写<br>_BIN按二进制排序，同时区分大小写">\r\n                                </span>\r\n                                \x3c!-- /if --\x3e\r\n                            </div>\r\n                        </div>\r\n                        <div class="form-row">\r\n                            <label>账号授权：</label>\r\n                            \x3c!-- if:${instance.superUserFlag} === \'super\' --\x3e\r\n                            <div class="form-value">\r\n                                请使用高权账号通过命令行方式进行授权操作\r\n                            </div>\r\n                            \x3c!-- else --\x3e\r\n                            <div class="form-value">\r\n                                \x3c!-- if: ${account}.length > 0 --\x3e\r\n                                <div class="table-wrap">\r\n                                    <div data-ui-type="Table"\r\n                                         data-ui-id="table"\r\n                                         data-ui-select="@selectMode"\r\n                                         data-ui-extension-tip-type="TableTip"\r\n                                         data-ui-extension-tableradio-type="TableRadio"\r\n                                         class="account-table">\r\n                                    </div>\r\n                                </div>\r\n                                \x3c!-- else --\x3e\r\n                                <p>暂无账号，去<a href="#/rds/account/create~instanceId=${instanceId}&rdsType=${rdsType}">创建账号</a></p>\r\n                                \x3c!-- /if --\x3e\r\n                            </div>\r\n                            \x3c!-- /if --\x3e\r\n                        </div>\r\n                        <div class="form-row">\r\n                            <label>备注说明：</label>\r\n                            <div class="form-value">\r\n                                <p>\r\n                                    <textarea  data-ui-type="TextBox"\r\n                                               data-ui-id="remark"\r\n                                               data-ui-child-name="password"\r\n                                               data-ui-name="remark"></textarea>\r\n                                <p>\r\n                                <p class="tip">最多256个字符（一个汉字等于三个字符）</p>\r\n                                <p>\r\n                                    <label data-ui-type="Validity"\r\n                                           data-ui-id="remarkValidity"\r\n                                           class="remark-validity"></label>\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                        <div class="form-row">\r\n                            <div class="form-value">\r\n                                <button data-ui-id="submit-button" data-ui-type="Button" data-ui-skin="ok">确认</button>\r\n                                <a data-ui-id="cancel-button" data-ui-type="Button" data-ui-skin="cancel">取消</a>\r\n                            </div>\r\n\r\n                        </div>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/database/CreateModel",["require","bat-ria/mvc/FormModel","underscore","../config","../helper","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/FormModel"),n=require("underscore"),i=require("../config"),a=i.api,r=require("../helper");return e.prototype.datasource={instance:function(e){return a.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return r.handlePublicData(e),e})},isWhiteAccount:function(){return a.rdsIsWhiteAccount()},tab:function(){return{database:"ui-tab-item-active"}},account:function(e){return a.rdsAccountList({instanceId:e.get("instanceId"),order:"desc",orderBy:"accountName",pageNo:1}).then(function(e){for(var t=e.result,n=0;n<t.length;n++)delete t[n].databasePrivileges,delete t[n].remark,delete t[n].password,t[n].name=t[n].accountName;return t})}},e.prototype.prepare=function(){var e=this.get("instance").engine,t=n.map(i.ENGINE_INFO[e].charset,function(e){return{name:e,value:e}});this.set("charset",t)},e.prototype.defaultArgs={},require("er/util").inherits(e,t),e}),define("rds/database/CreateView",["require","bat-ria/tpl!./create.tpl","bat-ria/mvc/FormView","underscore","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./create.tpl");var t=require("bat-ria/mvc/FormView"),n=require("underscore");e.prototype.template="TPL_rds_database_create";var i=[{title:"账户名称",content:"accountName"},{title:"权限设置",content:function(e){return'<label><input type="radio" name="'+n.escape(e.accountName)+'" value="readOnly" />只读</label><label><input type="radio" name="'+n.escape(e.accountName)+'" value="readWrite" />读写</label>'}}];e.prototype.uiProperties={dbName:{width:210,required:"required",requiredErrorMessage:"数据库名称为必填",pattern:/^[A-Za-z][A-Za-z\d_]{0,62}[A-Za-z\d]$/,patternErrorMessage:"数据库名称不符合规则",validityLabel:"dbNameValidity"},characterSetName:{width:230,datasource:"@charset"},table:{datasource:"@account",fields:i,width:400,select:"multi",defaultRadioValue:"*readOnly"},remark:{width:580,height:100}},e.prototype.uiEvents={"cancel-button:click":function(){this.fire("cancel")}};var a={dbName:"dbName",remark:"remark"};return e.prototype.showErrorMessage=function(e){for(var t in e)e.hasOwnProperty(t)&&this.get(a[t]).showValidationMessage("invalid",e[t])},require("er/util").inherits(e,t),e}),define("rds/database/List",["require","inf-ria/mvc/ListAction","er/util","underscore","inf-ria/helper","common/util/dialog","../config","../helper","./ListModel","./ListView","er/URL","../util"],function(require){function e(){o.apply(this,arguments)}function t(){d.redirectToModule("dts","/dts/migration/list")}function n(){this.asyncListPage()}function i(){this.redirect(require("er/URL").withQuery("/rds/database/create",{instanceId:this.model.get("instance").instanceId,rdsType:this.model.get("rdsType")}))}function a(e){var t=e.value,n=e.target.model.get("tableData"),i=this.model.get("instanceId"),a=n[e.rowIndex].dbName,r=n[e.rowIndex].remark;t!==r&&p.rdsUpdateDatabaseDesc({instanceId:i,dbName:a,remark:t}).then(c.bind(function(){this.view.get("table").setCellText('<span class="database-remark">'+require("../util").encodeHTML(t)+'</span><span class="ui-table-cell-editentry" data-row="'+e.rowIndex+'" data-col="'+e.columnIndex+'"></span>',e.rowIndex,e.columnIndex),n[e.rowIndex].remark=t},this)).fail(function(t){e.target.get("table").showEditError(t.field.remark)})}function r(e){var t=this.model.get("instanceId"),n=this.view.get("table").datasource[e.itemIndex].dbName;u.waitActionDialog(this.view,{title:"删除前确认",width:600,needFoot:!0,url:"/rds/requireauthcode",actionOptions:{requester:p.rdsDeleteDatabase,toastMessage:"删除成功",extraData:{instanceId:t,dbName:n},tip:"数据库删除后数据不可恢复，确定删除吗？",parentAction:this}}).then(function(e){var t=e.target;t.on("cancel",s),t.on("close",s)})}function s(){var e=this.getAction().model;e&&e.get("authCodeSent")&&p.rdsInvalidateAuthCode()}var o=require("inf-ria/mvc/ListAction"),c=require("er/util"),l=require("underscore"),d=require("inf-ria/helper"),u=require("common/util/dialog"),p=require("../config").api,m=require("../helper");return e.prototype.initBehavior=function(){o.prototype.initBehavior.apply(this,arguments);var e=this,s=e.view;m.handleDetailPublicEvent(this),s.on("refreshDatabaseList",n,this),s.on("saveEdit",a,this),s.on("deleteDatabase",r,this),s.on("createDatabase",i,this),s.on("goToDts",t,this),s.get("migrationProgress")&&(s.get("migrationProgress").hide(),e.model.rdsMigrationTask({instanceId:e.model.get("instanceId")}).then(function(t){l.isUndefined(t)||l.isUndefined(t.migrationId)?s.get("migrationProgress").hide():(e.model.set("migrationTaskCache",t),s.get("migrationProgress").show())}))},e.prototype.modelType=require("./ListModel"),e.prototype.viewType=require("./ListView"),require("er/util").inherits(e,o),e}),define("rds/database/list.tpl",[],function(){return'\x3c!-- target: TPL_rds_database_list --\x3e\r\n<div class="rds-database-list rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e数据库管理\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                <div class="table-full-wrap">\r\n                \x3c!-- if: ${instance.engine} === \'postgresql\' --\x3e\r\n                    <div class="ui-row">\r\n                        <p class="tip-yellow">\r\n                            请前往<a href="#/rds/account/list~instanceId=${instanceId}">帐号管理</a>页面创建管理员帐号，再由管理员账号通过客户端对数据库账号、数据库进行管理\r\n                        </p>\r\n                    </div>\r\n                \x3c!-- else --\x3e\r\n                    <div class="ui-row positon-relative">\r\n\r\n\r\n                        \x3c!--if: ${instance.readOnly} --\x3e\r\n                        <a href="#/rds/database/list~instanceId=${instance.sourceInstanceId}"\r\n                            class="ui-ctrl ui-button">返回主实例数据库管理</a>\r\n                        \x3c!--else--\x3e\r\n                        <button data-ui-type="Button" data-ui-id="createDatabase"\r\n                                data-ui-skin="create">创建数据库</button>\r\n                        \x3c!--/if--\x3e\r\n                        <button data-ui-type="Button" data-ui-id="refreshDatabaseList" data-ui-skin="refresh"\r\n                            class="refresh-button"></button>\r\n\r\n                        \x3c!-- if: ${instance.instanceType} !== \'financial\' --\x3e\r\n                            \x3c!-- if: ${oprationEnable} && ${instance.instanceStatus} !== \'backuping\' --\x3e\r\n                                \x3c!-- if: ${instance.engine} === \'sqlserver\' || ${region} === \'hk02\' --\x3e\r\n                        <ul id="migration" class="migration-menu">\r\n                            <li class="migration-menu-item migration-menu-nav ui-ctrl ui-button">自建数据迁移</li>\r\n                            <li >\r\n                                <label data-ui="id:createMigration;type:Label" class="migration-menu-item">\r\n                                    新建数据库迁移\r\n                                </label>\r\n                            </li>\r\n                            <li >\r\n                                <label data-ui="id:showMigrationLog;type:Label" class="migration-menu-item">\r\n                                    数据库迁移记录\r\n                                </label>\r\n                            </li>\r\n                        </ul>\r\n                                \x3c!-- else --\x3e\r\n                                    \x3c!-- if: !${isSubUser} --\x3e\r\n                        <div data-ui-id="goToDts" data-ui-type="Button" class="float-right go-dts">自建数据迁移</div>\r\n                                    \x3c!-- /if --\x3e\r\n                                \x3c!-- /if --\x3e\r\n                            \x3c!-- else --\x3e\r\n                        <button data-ui-type="Button" data-ui-disabled="true" class="float-right go-dts">自建数据迁移</button>\r\n                            \x3c!-- /if --\x3e\r\n                        \x3c!-- /if --\x3e\r\n\r\n\r\n                        \x3c!-- <button data-ui-id="migrationProgress" data-ui-type="Button" class="migration-progress">迁移进度</button> --\x3e\r\n                    </div>\r\n                    \x3c!-- import: listEditableTableWithCommand --\x3e\r\n\r\n                \x3c!-- /if --\x3e\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n</div>\r\n'}),define("rds/database/ListModel",["require","inf-ria/mvc/ListModel","underscore","common/region","common/util","../config","../helper","../tips","../util","er/util"],function(require){function e(){t.apply(this,arguments),this.listRequester=s.rdsDatabaseList}var t=require("inf-ria/mvc/ListModel"),n=require("underscore"),i=require("common/region"),a=require("common/util"),r=require("../config"),s=r.api,o=require("../helper"),c={creating:"创建中",available:"运行中",deleting:"删除中",CLASS:{creating:"warning",available:"normal",deleting:"error"}};return e.prototype.datasource=[{tips:function(){return require("../tips")},instance:function(e){return s.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(t){return o.handlePublicData(t),n.contains(r.oprationDisableStatus,t.instanceStatus)||t.readOnly||e.set("oprationEnable",!0),t})},isWhiteAccount:function(){return s.rdsIsWhiteAccount()},tab:function(){return{database:"ui-tab-item-active"}},isSubUser:function(){return a.isSubUser()},region:function(){return i.getCurrentRegion().id}},{sourceInstance:function(e){var t=e.get("instance").sourceInstanceId;return t?s.rdsInstanceDetail({instanceId:t}):null}}],e.prototype.defaultArgs={order:"desc",orderBy:"name"},e.prototype.prepare=function(){var e=this.get("instance"),t=n.without(r.oprationDisableStatus,"migrating","backuping"),i=!(n.contains(t,e.instanceStatus)||e.readOnly),a=this.get("sourceInstance")?"super"===this.get("sourceInstance").superUserFlag:"super"===this.get("instance").superUserFlag,s=[{field:"dbName",width:200,title:"数据库名称",content:function(e){var t=n.escape(e.dbName);return'<span title="'+t+'">'+t+"</span>"}},{title:"数据库状态",width:50,content:function(e){var t=n.escape(e.dbStatus);return'<span class="status '+c.CLASS[t]+'">'+(c[t]||t)+"</span>"}},{title:"字符集",width:80,content:function(e){var t=n.escape(e.characterSetName);return'<span title="'+t+'">'+t+"</span>"}},{title:"绑定账号",width:160,content:function(e){for(var t="",i="",a=0;a<e.accountPrivileges.length;a++)i="readOnly"===n.escape(e.accountPrivileges[a].authType)?"只读":"读写",t+=n.escape(e.accountPrivileges[a].accountName)+"&nbsp;"+i+"<br />";return t}},{title:"描述",width:200,content:function(e,t,n){var a=i?'<span class="ui-table-cell-editentry"data-row="'+t+'" data-col="'+n+'"></span>':"";return'<span class="database-remark">'+require("../util").encodeHTML(e.remark)+"</span>"+a},editable:i,editContent:function(e){return e.remark},editRules:{custom:function(e){return e.replace(/([^\x00-\xff])/g,"$1$1$1").length<=256},customErrorMessage:"备注说明不符合规则：最多256个字符（一个汉字等于三个字符）"}},{title:"操作",width:50,content:function(e,t){var n=i?"oprations":"oprations oprations-disabled";return"deleting"!==e.dbStatus?'<span class="'+n+'"><a data-command="deleteDatabase" data-command-args="'+t+'">删除</a></span>':""}}];a&&s.splice(3,1),this.set("tableFields",s);var l=this.get("tableData"),d=this.get("instance").instanceStatus;n.each(l,function(e,t){e.instanceStatus=d}),o.getDelayInfo(this)},e.prototype.rdsMigrationTask=function(e){return s.rdsMigrationTask(e)},require("er/util").inherits(e,t),e}),define("rds/database/ListView",["require","bat-ria/tpl!./list.tpl","inf-ria/mvc/ListView","underscore","../config","jquery","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./list.tpl");var t=require("inf-ria/mvc/ListView"),n=require("underscore"),i=require("../config"),a=!0,r=require("jquery");return e.prototype.template="TPL_rds_database_list",e.prototype.uiProperties={table:{fields:"@tableFields",editable:1,noDataHtml:"没有数据"}},e.prototype.uiEvents={"table:saveedit":function(e){this.fire("saveEdit",e)},"table:command":function(e){a&&this.fire(e.name,{itemIndex:+e.args})},"refreshDatabaseList:click":function(){this.fire("refreshDatabaseList")},"createDatabase:click":function(){this.fire("createDatabase")},"createMigration:click":function(){this.createMigration()},"showMigrationLog:click":function(){this.showMigrationLog()},"migrationProgress:click":function(){this.createMigration()},"goToDts:click":function(){this.fire("goToDts")}},e.prototype.enterDocument=function(){var e=this.model.get("instance"),s=n.without(i.oprationDisableStatus,"migrating","backuping"),o=n.contains(s,e.instanceStatus)||e.readOnly;a=!o,r("#migration").hover(function(e){r(".migration-menu-item").css("display","block"),r("#migration .triangle-down").css({background:"url(https://bce.bdstatic.com/console/img/triangle.png) no-repeat -67px -0px"})},function(e){r(".migration-menu-item:not(.migration-menu-nav)").css("display","none")}),t.prototype.enterDocument.call(this,arguments);var c=this.get("createDatabase");o&&c&&c.disable()},e.prototype.showMigrationLog=function(){this.waitActionDialog({title:"自建数据库迁移记录",width:1e3,needFoot:!1,url:"/rds/migration/list",actionOptions:{instanceId:this.model.get("instanceId")}}).then(function(e){e.target.resize()})},e.prototype.createMigration=function(){var e=this.model.get("migrationTaskCache"),t=this;this.waitActionDialog({title:"自建数据库迁移记录",width:500,needFoot:!1,url:"/rds/migration/create",actionOptions:{instanceId:this.model.get("instanceId"),migrationTask:e,engine:this.model.get("instance").engine,parentView:this}}).then(function(e){var n=e.target;n.resize(),e.target.getAction().on("closeDialog",function(e){n.dispose(),e.message&&t.waitAlert(e.message),t.fire("refreshDatabaseList")})})},require("er/util").inherits(e,t),e}),define("rds/dcc/config",["exports","module","er/controller","babel-runtime/helpers/interop-require-default"],function(exports,module,e,t){t["default"](e)["default"].registerAction([{type:"rds/dcc/create/Action",path:"/rds/dcc/create"}]);module.exports={}}),define("rds/dcc/create/Action",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/class-call-check","babel-runtime/core-js/promise","bat-ria/mvc/FormAction","babel-runtime/helpers/interop-require-default","underscore","jquery","esui/main","common/constants","common/region","common/util/orderUtil","common/zone","../../config","./Model","./View"],function(exports,module,e,t,n,i,a,r,s,o,c,l,d,u,p,m,h){var g=a["default"](i),f=a["default"](r),b=a["default"](s),v=(a["default"](o),a["default"](c),a["default"](l)),y=(a["default"](d),a["default"](u)),x=a["default"](p),w=a["default"](m),T=a["default"](h),I=function(i){function a(e){t["default"](this,a),i.call(this,e),this.modelType=w["default"],this.viewType=T["default"]}return e["default"](a,i),a.prototype.initBehavior=function(){i.prototype.initBehavior.call(this),this.view.on("vpcChange",this.loadSubnet,this),this.view.on("zoneChange",this.loadSubnet,this),this.view.on("createRdsOnDcc",this.createRdsOnDcc,this),this.view.on("changeEngine",this.changeEngine,this),this.view.on("packageChange",this.packageChange,this),this.view.on("vpcChange",this.loadSubnet,this),this.view.on("zoneChange",this.zoneChange,this),this.view.on("mainDccChange",this.mainDccChange,this),this.view.on("storageChange",this.storageChange,this),this.subnetsInfo={isEmptyMainSubnet:!1,isEmptyBackupSubnet:!1},this.loadSubnet(),this.setAvalibleConfig(),this.setAvalibleDcc();var e=this.model.get("dccList"),t=[],n=[],a=[];if(e.length>=2){f["default"].each(e,function(e){t.push(e.cpuLeft),n.push(e.memoryLeft),a.push(e.diskSizeLeft)});var r=t.sort(function(e,t){return t-e})[1],s=n.sort(function(e,t){return t-e})[1],o=a.sort(function(e,t){return t-e})[1];b["default"](".cpu-count").text(r),b["default"](".mem-count").text(s),b["default"](".storage-count").text(o)}this.setStorageTip()},a.prototype.storageChange=function(){this.setAvalibleDcc(),this.setStorageTip()},a.prototype.setStorageTip=function(){var e=this.view.get("allocatedStorageInGB").getValue();b["default"](".available-store-tip").text(+e-50+"GB")},a.prototype.mainDccChange=function(){this.setAvalibleDcc()},a.prototype.setAvalibleDcc=function(){var e=this.view.get("logicalZone").getValue().split(","),t=this.view.get("packageSelect").getValue(),n=x["default"].PACKAGE_MAP[t],i=n.cpu,a=n.memory,r=this.view.get("allocatedStorageInGB").getValue(),s=this.view.get("mainDcc"),o=this.view.get("backupDcc"),c=this.model.get("dccList"),l=f["default"].filter(c,function(t){return t.cpuLeft>=i&&t.diskSizeLeft>=r&&t.memoryLeft>=a&&f["default"].contains(e,t.logicalZone)}),d=f["default"].map(l,function(e){return{name:e.hostId,value:e.id}}),u=s.getValue(),p=o.getValue();s.setProperties({datasource:d,value:u});var m=s.getValue(),h=m===p?"":p,g="";f["default"].each(c,function(e){e.id===m&&(g=e.logicalZone)});var v=f["default"].filter(d,function(t){if(t.value===m)return!1;if(1===e.length)return!0;var n=!1;return f["default"].each(c,function(e){t.value===e.id&&(n=e.logicalZone!==g)}),n});o.setProperties({datasource:v,value:h});var y=s.getValue(),w=o.getValue(),T=b["default"](".main-dcc-left-tip"),I=b["default"](".backup-dcc-left-tip");y?f["default"].each(c,function(e){if(e.id===y){var t="创建后资源剩余： CPU"+(e.cpuLeft-i)+"核、内存"+(e.memoryLeft-a)+"GB、磁盘"+(e.diskSizeLeft-r);T.text(t).show()}}):T.html('<span class="color-red">当前无可用DCC实例，请重新选择配置或者<a href="/bcc/#/dcc/host/create" target="_blank">创建新DCC实例</a></span>'),w?f["default"].each(c,function(e){if(e.id===w){var t="创建后资源剩余： CPU"+(e.cpuLeft-i)+"核、内存"+(e.memoryLeft-a)+"GB、磁盘"+(e.diskSizeLeft-r);I.text(t).show()}}):I.html('<span class="color-red">当前无可用DCC实例，请重新选择配置或者<a href="/bcc/#/dcc/host/create" target="_blank">创建新DCC实例</a></span>'),this.checkEnablePurchase()},a.prototype.zoneChange=function(){this.loadSubnet(),this.setAvalibleConfig(),this.setAvalibleDcc()},a.prototype.setAvalibleConfig=function(){v["default"].getCurrentRegion().id;var e=this.view.get("engine").getValue(),t=(this.view.get("engineVersion").getValue(),f["default"].deepClone(x["default"].ENGINE_INFO[e])),n=(this.view.get("logicalZone").getValue(),this.view.get("packageSelect").getValue()),i=(this.view.get("logicalZone").getValue(),this.model.get("zonePackageLimit"),f["default"].deepClone(t.availablePackage)),a=f["default"].map(i,function(e){var t=x["default"].PACKAGE_MAP[e];return{name:t.type+" "+t.cpu+"核"+t.memory+"G",value:e}});this.view.get("packageSelect").setProperties({datasource:a,value:n}),this.checkStorageLimit(n),this.setLinkCount()},a.prototype.getFormData=function(){var e=this.view,t={},n=e.get("logicalZone").getValue(),i=n.split(","),a=e.get("vpc").getValue(),r=e.get("subnet").getValue(),s=e.get("mainDcc").getValue(),o=e.get("backupDcc").getValue(),c=this.model.get("dccList"),l="",d="";f["default"].each(c,function(e){e.id===s?l=e.logicalZone:e.id===o&&(d=e.logicalZone)});var u=i[0]+":"+r;i.length>1&&(u+=","+i[1]+":"+e.get("backupSubnet").getValue());var p=e.get("engine").getValue(),m=e.get("engineVersion").getValue(),h=e.get("packageSelect").getValue();return t={instance:{engine:p,engineVersion:m,cpuCount:x["default"].PACKAGE_MAP[h].cpu,allocatedMemoryInGB:x["default"].PACKAGE_MAP[h].memory,allocatedStorageInGB:+e.get("allocatedStorageInGB").getValue(),azone:n,vpcId:a,subnetId:u,dccHosts:[{machineInstanceId:s,instanceRole:"Master",azone:l},{machineInstanceId:o,instanceRole:"Backup",azone:d}],machineType:"dcc"},number:1,productType:"postpay"},{items:[{config:t,paymentMethod:[]}],paymentMethod:[]}},a.prototype.createRdsOnDcc=function(){var e=this,t=this.getFormData();this.model.createRdsOnDcc(t).then(function(){e.view.showToast("创建成功"),e.redirect("#/rds/list~rdsType=dcc")})},a.prototype.packageChange=function(){this.checkStorageLimit(),this.setAvalibleDcc(),this.setLinkCount()},a.prototype.setLinkCount=function(){var e="",t=this.view.get("engine").getValue(),n=this.view.get("packageSelect").getValue(),i=x["default"].PACKAGE_MAP[n].memory;e="MySQL"===t?"最大连接数："+x["default"].ENGINE_INFO.MySQL.memoryInfo[i].maxLink:"postgresql"===t?"最大连接数：1000":"最大连接数：不限",this.view.get("memoryTip").setText(e)},a.prototype.changeEngine=function(){var e=this.view.get("engine").getValue(),t=f["default"].map(x["default"].ENGINE_INFO[e].availablePackage,function(e){var t=x["default"].PACKAGE_MAP[e];return{name:t.type+" "+t.cpu+"核"+t.memory+"G",value:e}});this.view.get("packageSelect").setProperties({datasource:t}),this.view.get("engineVersion").setProperties({datasource:x["default"].ENGINE_INFO[e].version,showNum:x["default"].ENGINE_INFO[e].version.length,selectedIndex:"postgresql"!==e?1:0}),this.setAvalibleConfig()},a.prototype.checkStorageLimit=function(e){v["default"].getCurrentRegion().id;var t=this.view.get("engine").getValue();f["default"].deepClone(x["default"].ENGINE_INFO[t]);e=e||this.view.get("packageSelect").getValue();var n=x["default"].PACKAGE_MAP[e].maxStorage,i=this.view.get("allocatedStorageInGB").getRawValue();i=f["default"].min([f["default"].max([i,55]),n]),this.view.get("allocatedStorageInGB").setProperties({min:55,max:n}),this.view.get("allocatedStorageInGB").setValue(i)},a.prototype.checkEnablePurchase=function(){var e=this.view.get("mainDcc").getValue(),t=this.view.get("backupDcc").getValue();this.subnetsInfo.isEmptyMainSubnet||this.subnetsInfo.isEmptyBackupSubnet||!e||!t?this.view.get("createRdsBtn").disable():this.view.get("createRdsBtn").enable()},a.prototype.loadSubnet=function(){var e=this,t={},i=[],a=this.view.get("logicalZone").getValue().split(","),r=this.view.get("vpc").getValue(),s=this.view.get("subnet"),o=this.view.get("backupSubnet"),c=this.view.get("backupSubnetPanel");c.hide(),this.view.get("subnetLabel").setText(y["default"].getLabel(a[0])+"子网"),i.push(this.model.getSubnetList(r,a[0]).then(function(e){e.length?s.setProperties({datasource:e,disabled:!1}):(t.isEmptyMainSubnet=!0,s.setProperties({datasource:[{name:"没有数据",value:""}],disabled:!0}))})),a.length>1&&(this.view.get("backupSubnetLabel").setText(y["default"].getLabel(a[1])+"子网"),c.show(),i.push(this.model.getSubnetList(r,a[1]).then(function(e){e.length?o.setProperties({datasource:e,disabled:!1}):(t.isEmptyBackupSubnet=!0,o.setProperties({datasource:[{name:"没有数据",value:""}],disabled:!0}))}))),n["default"].all(i).then(function(){e.subnetsInfo=t,e.checkEnablePurchase()})},a}(g["default"]);module.exports=I}),define("rds/dcc/create/Model",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","bat-ria/mvc/FormModel","babel-runtime/helpers/interop-require-default","underscore","common/region","common/zone","common/billing/common","common/util","../../config","../../tips","../../enums"],function(exports,module,e,t,n,i,a,r,s,o,c,l,d,u,p){var m=a["default"](i),h=a["default"](r),g=a["default"](s),f=a["default"](o),b=(a["default"](c),a["default"](l)),v=a["default"](d),y=a["default"](u),x={"X-silence":!0},w=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.getSubnetList=function(e,t){var n=this;return d.api.subnetList({vpcId:e,az:t},x).then(function(e){var t=[],i={};return h["default"].each(e,function(e){var n=b["default"].getSubnetName(e.name)+(e.cidr?"("+e.cidr+")":"");t.push({value:e.subnetId,text:n,title:n}),i[e.subnetId]=n}),h["default"].extend(i,n.get("subnetMap")),n.set("subnetMap",i),t})},a.prototype.createRdsOnDcc=function(e){return d.api.rdsOnDccCreate(e)},a.prototype.prepare=function(){g["default"].getCurrentRegion().id;var e=v["default"].ENGINE_INFO.MySQL.version;this.set("defaultEngineVersion",e)},t["default"](a,[{key:"datasource",get:function(){return{vpcDatasource:function(e){return d.api.rdsVpcList({},{"X-silence":!0}).then(function(e){var t=[];return h["default"].each(e||[],function(e){var n=b["default"].getVpcName(e.name)+(e.cidr?"("+e.cidr+")":"");t.push({value:e.vpcId,text:n,title:n})}),t})},subnetDatasource:function(e){return[{name:"加载中...",value:""}]},zoneDatasource:function(e){return d.api.rdsZoneList().then(function(e){var t=e.zones||[];return h["default"].map(t,function(e){var t=e.zoneNames.join(",");return{value:t,name:f["default"].getLabel(t)}})})},dccList:function(){return d.api.rdsDccHostList({filters:[],order:"desc",orderBy:"createTime",pageNo:1,pageSize:1e3}).then(function(e){return h["default"].filter(e.result,function(e){return"calculation"===e.flavorType})})},tips:function(){return y["default"]}}}}]),a}(m["default"]);module.exports=w}),define("rds/dcc/create/tpl",[],function(){return'\x3c!-- target: TPL_rds_dcc_create --\x3e\n<div class="rds-dcc-create rds-dcc-main-wrap main-wrap-new">\n    \x3c!-- import: TPL_inf_ria_page_breadcrumb --\x3e\n        \x3c!-- block: back_link --\x3e#/rds/list~rdsType=dcc\x3c!-- /block --\x3e\n        \x3c!-- block: text_content_wrapper --\x3e\n            ${i18n.创建专属RDS}\n        \x3c!-- /block --\x3e\n    \x3c!-- /import --\x3e\n\n    <div class="content-wrap">\n        <div class="create-content create-content-wrapper">\n            <div id="instance-pick">\n                <div class="create-main">\n                    <div class="create-parts detail-parts-table create-config without-buybucket">\n                        <form data-ui-type="Form" data-ui-id="form">\n                            <dl class="detail-create detail-part-1-col">\n                                <dt class="create-title">\n                                    <h4><span>${i18n.基本信息}</span></h4>\n                                </dt>\n                                <dd>\x3c!-- import: TPL_common_partial_create_current_region --\x3e</dd>\n                                <dd>\n                                    <label>可用区：</label>\n                                    <div>\n                                        <span data-ui-type="Select"\n                                            data-ui-id="logicalZone"\n                                            data-ui-name="azone"></span>\n                                    </div>\n                                </dd>\n                            </dl>\n                            <dl class="detail-create detail-part-1-col">\n                                <dt>\n                                    <h4>配置信息</h4>\n                                </dt>\n                                \x3c!-- if: ${dccList.length} >= 2 --\x3e\n                                <dd>\n                                    <span class="tip-yellow">\n                                        温馨提示：DCC当前可支持创建RDS最大资源为CPU：\n                                        <span class="cpu-count">-</span>核、内存：\n                                        <span class="mem-count">-</span>GB、磁盘：\n                                        <span class="storage-count">-</span>GB\n                                    </span>\n                                </dd>\n                                \x3c!-- /if --\x3e\n\n                                <dd>\n                                    <label>数据库类型：</label>\n                                    <div class="form-value">\n                                        <div data-ui-id="engine" data-ui-type="RadioSelect" class="ui-radioselect-custom"></div>\n                                    </div>\n                                </dd>\n                                <dd>\n                                    <label>系列：</label>\n                                    <div class="form-value">\n                                        <div data-ui-id="series" data-ui-type="RadioSelect" class="ui-radioselect-custom"></div>\n                                    </div>\n                                </dd>\n                                <dd>\n                                    <label>版本：</label>\n                                    <div class="form-value">\n                                        <div data-ui-id="engineVersion" data-ui-type="RadioSelect" class="ui-radioselect-custom"></div>\n                                    </div>\n                                </dd>\n                                <dd>\n                                    <label>规格：</label>\n                                    <div class="form-value">\n                                        <span  class="package-select"\n                                            data-ui-type="Select"\n                                            data-ui-id="packageSelect"\n                                            data-ui-width="200"></span>\n                                        <span data-ui-type="Tip"\n                                            data-ui-id="packageTip"\n                                            data-ui-content="${tips.packageTip}"\n                                            data-ui-layer-width="320"\n                                            data-ui-skin="normal" class="package-tip"></span>\n                                        <esui-label class="row-tips inline-block"\n                                            data-ui-type="Label"\n                                            data-ui-id="memoryTip">最大连接数:1000</esui-label>\n\n                                    </div>\n                                </dd>\n                                <dd>\n                                    <label>存储磁盘：</label>\n                                    <div class="form-value">\n                                        <div data-ui-id="allocatedStorageInGB"\n                                             data-ui-name="storage"\n                                             data-ui-type="Dragger"\n                                             class="storage-dragger"></div>\n                                        <p class="tips">\n                                            磁盘大小必须为5的倍数；Linux系统占用20GB，binlog+全日志占用30GB，可用数据空间<span class="available-store-tip"></span>\n                                        </p>\n                                    </div>\n                                </dd>\n                                <dd>\n                                    <label>网络类型：</label>\n                                    <div>\n                                        <div class="network-section">\n                                            所在网络：<br>\n                                            <span data-ui-type="Select" data-ui-id="vpc" class="vpc-select"></span>\n                                        </div>\n                                        <div class="network-section">\n                                            <div data-ui-type="Label" data-ui-id="subnetLabel" ></div>\n                                            <span data-ui-type="Select" data-ui-id="subnet" data-ui-name="subnetUuid"></span>\n                                            <p data-ui-type="Label" data-ui-id="subnetLabelTip" data-ui-hidden=\'true\' class="subnet-invalid-tips">该自定义私有网络在该可用区没有子网，请先创建子网或选择其他VPC</p>\n                                        </div>\n                                        <div data-ui-type="Panel" data-ui-id="backupSubnetPanel" data-ui-hidden=true class="network-section">\n                                            <div data-ui-type="Label" data-ui-id="backupSubnetLabel" ></div>\n                                            <span data-ui-type="Select" data-ui-id="backupSubnet" data-ui-name="backupSubnetUuid"></span>\n                                            <p data-ui-type="Label" data-ui-id="backupSubnetLabelTip" data-ui-hidden=\'true\' class="subnet-invalid-tips">该自定义私有网络在该可用区没有子网，请先创建子网或选择其他VPC</p>\n                                        </div>\n                                        <span data-ui-type="Tip"\n                                            data-ui-id="subnetTip"\n                                            data-ui-content="${tips.rdsSubnetTip}"\n                                            data-ui-skin="warning" class="subnet-tip"></span>\n                                    </div>\n                                </dd>\n                            </dl>\n                            <dl class="detail-create detail-part-1-col">\n                                <dt>\n                                    <h4>专属服务器选取</h4>\n                                </dt>\n\n                                <dd>\n                                    <label>主库服务器：</label>\n                                    <div>\n                                        <span data-ui-type="Select" data-ui-id="mainDcc"></span>\n                                        <span class="tips main-dcc-left-tip"></span>\n                                    </div>\n                                </dd>\n                                <dd>\n                                    <label>备库服务器：</label>\n                                    <div>\n                                        <span data-ui-type="Select" data-ui-id="backupDcc"></span>\n                                        <span class="tips backup-dcc-left-tip"></span>\n                                    </div>\n                                </dd>\n                            </dl>\n                            <dl class="detail-create detail-part-1-col">\n                                <dt><h4>购买信息</h4></dt>\n                                <dd>\n                                    <label>购买数量：</label>\n                                    <div class="form-value">\n                                        1个\n                                    </div>\n                                </dd>\n                            </dl>\n                            <dl class="detail-create detail-part-1-col">\n                                <dd>\n                                    <label></label>\n                                    <div class="form-value">\n                                        <button data-ui-type="Button" data-ui-id="createRdsBtn" class="create-rds-btn" data-ui-skin="primary">立即创建</button>\n                                    </div>\n                                </dd>\n                            </dl>\n                        </form>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n'}),define("rds/dcc/create/ui",["exports","underscore","babel-runtime/helpers/interop-require-default","jquery","common/region","common/util/moneyUtil","common/zone"],function(exports,e,t,n,i,a,r){exports.__esModule=!0,exports.getUIProperties=function(){return this.model.get("defaultFormData"),{engine:{datasource:[{name:"MySQL",value:"MySQL"}]},series:{datasource:[{name:"双机高可用版",value:"double"}]},engineVersion:{datasource:"@defaultEngineVersion",selectedIndex:1},allocatedStorageInGB:{max:200,min:55,step:5,length:349,unit:"GB"},logicalZone:{datasource:"@zoneDatasource"},vpc:{width:200,datasource:"@vpcDatasource"},subnet:{width:200,datasource:"@subnetDatasource"},backupSubnet:{width:200,datasource:"@subnetDatasource"},mainDcc:{width:200,datasource:[{name:"请选择一台DCC",value:""}]},backupDcc:{width:200,datasource:[{name:"请选择一台DCC",value:""}]}}},exports.getUIEvents=function(){return this.model.get("tips"),{"packageSelect:change":function(){this.fire("packageChange")},"allocatedStorageInGB:change":function(){this.fire("storageChange")},"engine:change":function(){this.fire("changeEngine")},"engineVersion:change":function(e){this.fire("pickChange")},"logicalZone:change":function(){this.fire("zoneChange")},"vpc:change":function(){this.fire("vpcChange")},"mainDcc:change":function(){this.fire("mainDccChange")},"backupDcc:change":function(){this.fire("backupDccChange")},"createRdsBtn:click":function(){this.fire("createRdsOnDcc")}}};t["default"](e),t["default"](n),t["default"](i),t["default"](a),t["default"](r)}),define("rds/dcc/create/View",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/class-call-check","bat-ria/tpl!./tpl","jquery","babel-runtime/helpers/interop-require-default","underscore","bat-ria/mvc/FormView","inf-ria/app/brpc","../../config","../../enums","./ui"],function(exports,module,e,t,n,i,a,r,s,o,c,l,d){a["default"](i),a["default"](r);var u=a["default"](s),p=(a["default"](o),function(n){function i(){t["default"](this,i),n.call(this),this.template="TPL_rds_dcc_create"}return e["default"](i,n),i.prototype.getUIProperties=function(){return d.getUIProperties.apply(this)},i.prototype.getUIEvents=function(){return d.getUIEvents.apply(this)},i.prototype.getProductType=function(){return 0===this.get("productType").activeIndex?l.ProductType.PREPAY:l.ProductType.POSTPAY},i.prototype.getFormData=function(){return n.prototype.getFormData.call(this)},i}(u["default"]));module.exports=p}),define("rds/Detail",["require","bat-ria/mvc/BaseAction","jquery","er/util","er/URL","common/billing/common","./config","./helper","./DetailModel","./DetailView","../common/util/dialog"],function(require){function e(){l.apply(this,arguments)}function t(){var e=this.model.get("instance"),t="";"sqlserver"===e.engine&&"2012"===e.engineVersion?t+='<p class="tip-yellow">为确保业务的正常运行，请使用外网IP或者域名连接RDS！内网IP直连会在RDS故障恢复时造成数据丢失！</p>':"MySQL"!==e.engine&&(t+='<p class="tip-yellow">为确保业务的正常运行，请使用外网IP或者域名连接RDS！内网IP直连RDS主备切换后会造成数据丢失！</p>');var n=e.endpoint.inetIp&&"available"===e.eipStatus?e.endpoint.inetIp:"无，请先开通公网访问";"financial"===e.instanceType?t+='<p class="ips"><span>内网IP：</span><span>'+e.endpoint.vnetIp+"</span></p>":t+='<p class="ips"><span>内网IP：</span><span>'+e.endpoint.vnetIp+'</span></p><p class="ips"><span>外网IP：</span><span>'+n+'</span></p><p class="light-tip">您也可以通过ping域名地址自行获取RDS实例IP地址：</p><p class="light-tip">ping '+(e.endpoint&&e.endpoint.address||"demo.mysql.rds.bj.baidubce.com")+"</p>",this.view.waitAlert({title:"获取IP",skin:"rds-ip",encode:!1,content:t,width:500})}function n(){var e=this;this.view.waitConfirm({title:"公网开通",content:"公网开通生效与DNS解析生效时间有关，大约5~10分钟，请您确认操作后耐心等待！",width:450}).then(function(){return e.model.updateAccess({instanceId:e.model.get("instanceId"),publiclyAccessible:!0})}).then(function(){e.view.get("instanceAccessLabel").setText("处理中"),e.view.get("activeAccess").hide()})}function i(){this.model.updateAccess({instanceId:this.model.get("instanceId"),publiclyAccessible:!1}).then(u.bind(function(){this.view.get("instanceAccessLabel").setText("处理中"),this.view.get("stopAccess").hide()},this))}function a(){var e=this.model.get("instanceId");require("../common/util/dialog").waitActionDialog(this.view,{title:"释放前确认",width:600,needFoot:!0,url:"/rds/requireauthcode",actionOptions:{requester:h.rdsInstanceDelete,toastMessage:"释放成功",extraData:{instanceId:e},tip:"实例释放后不可恢复，确定释放吗？",parentAction:this}}).then(function(e){var t=e.target;t.on("cancel",r),t.on("close",r)})}function r(){var e=this.getAction().model;e&&e.get("authCodeSent")&&h.rdsInvalidateAuthCode()}function s(){var e=this.model.get("instance").instanceId,t=this;this.view.waitActionDialog({title:"设置备份周期",width:800,needFoot:!0,url:"/rds/settimepoint",defaultFoot:'<div class="ok-button ui-dialog-ok-btn"data-ui="type:Button;id:btnFootOk;childName:btnOk;">确定</div><div data-ui="type:Button;id:btnFootCancel;childName:btnCancel;">取消</div>',actionOptions:{instanceId:e,backupPolicy:this.model.get("backupPolicy")}}).then(function(e){var n=e.target.getAction(),i=e.target.getChild("foot").getChild("btnOk"),a=e.target.getChild("foot").getChild("btnCancel"),r=e.target;i.on("click",function(){n.submit(function(){t.view.showToast("修改成功"),t.reload()})}),a.on("click",function(){r.dispose()}),r.resize()})}function o(){var e=this.view.get("nameInput"),t=e.getValue();e.validate()&&h.rdsUpdateInstanceName({instanceId:this.model.get("instanceId"),instanceName:t}).then(u.bind(function(){this.model.get("instance").instanceName=t,this.view.get("instanceNameLabel").setText(t),d(".name-container").show(),d(".edit-name-container").hide()},this)).fail(u.bind(function(t){e.showValidationMessage("invalid",t.field.instanceName)},this))}function c(e){var t=this.model.get("instance");this.model.get("enableBatchRecharge")?m.recharge("RDS",[t.instanceId]):this.redirect(p.withQuery("/rds/recharge",{instanceId:t.instanceId,serviceType:"readReplica"===t.instanceType?"RDS_REPLICA":"RDS"}))}var l=require("bat-ria/mvc/BaseAction"),d=require("jquery"),u=require("er/util"),p=require("er/URL"),m=require("common/billing/common"),h=require("./config").api,g=require("./helper");return e.prototype.syncModelToViewIterator=function(e){var t=e.newValue;switch(e.name){case"relatedInstance":this.view.updateInstanceDetail(t)}},e.prototype.initBehavior=function(){l.prototype.initBehavior.apply(this,arguments);var e=this,r=this.model;g.handleDetailPublicEvent(this),this.view.on("updatebackupPolicy",s,this),this.view.on("updateName",function(){d(".name-container").hide(),d(".edit-name-container").show(),this.view.get("nameInput").setValue(r.get("instance").instanceName),this.view.get("nameInput").validate()},this),this.view.on("updateNameOk",o,this),this.view.on("updateNameCancel",function(){d(".name-container").show(),d(".edit-name-container").hide()},this),this.view.on("updateDomain",function(){d(".domain-container").hide(),d(".edit-domain-container").show(),this.view.get("domainInput").setValue(r.get("instance").endpoint.address.split(".")[0]),this.view.get("domainInput").validate()},this),this.view.on("updateDomainOk",function(){var e=this;this.view.get("domainInput").validate()&&e.view.waitConfirm({title:document.title,content:"域名变更可能会影响相关服务，确定保存吗？",width:500}).then(function(){(function(){var e=this.view.get("domainInput"),t=e.getValue()+this.model.get("instance").domainSuffix;h.rdsUpdateInstanceDomain({instanceId:this.model.get("instanceId"),domain:t}).then(u.bind(function(){this.model.get("instance").endpoint.address=t,this.view.get("instanceDomainLabel").setText(t),this.view.get("copyDomain").clipboardText=t,d(".domain-container").show(),d(".edit-domain-container").hide()},this)).fail(u.bind(function(t){e.showValidationMessage("invalid",t.field.domain)},this))}).call(e)})},this),this.view.on("updateDomainCancel",function(){d(".domain-container").show(),d(".edit-domain-container").hide()},this),this.view.on("activeAccess",n,this),this.view.on("stopAccess",i,this),this.view.on("recharge",c,this),this.view.on("goPhpAdmin",g.goPhpAdmin,this),this.view.on("deleteInstance",a,this),this.view.on("getIp",t,this),this.view.on("alterProductType",this.alterProductType,this),this.view.on("deactiveSemiSync",this.deactiveSemiSync,this),this.view.on("activeSemiSync",this.activeSemiSync,this),d("#goto-cluster-link").on("click",function(){e.redirect(p.withQuery("/rds/cluster/setting",{instanceId:r.get("instanceId")}))})},e.prototype.activeSemiSync=function(){var e=this;this.view.waitConfirm({title:"开启半同步",content:"开启半同步大约需要10~30s，请您确认操作后耐心等待！",width:450}).then(function(){return e.model.rdsUpdateReplicationType({instanceId:e.model.get("instanceId"),replicationType:"semi_sync"})}).then(function(){e.reload()})},e.prototype.deactiveSemiSync=function(){var e=this;this.view.waitConfirm({title:"关闭半同步",content:"关闭半同步大约需要10~30s，请您确认操作后耐心等待！",width:450}).then(function(){return e.model.rdsUpdateReplicationType({instanceId:e.model.get("instanceId"),replicationType:"async"})}).then(function(){e.reload()})},e.prototype.modelType=require("./DetailModel"),e.prototype.viewType=require("./DetailView"),e.prototype.alterProductType=function(){var e=this,t=this.model.get("instance");if("to_postpay"===t.orderStatus)this.view.waitConfirm({title:"取消计费变更",content:"确认取消计费变更？<br/>您已开通计费变更-预付费转后付费功能。<br/>实例将会在到期后自动转换为后付费的计费方式。",width:420,needFoot:!0,encode:!1}).then(function(){return e.model.cancelAlterProductType({instanceIds:[t.instanceId]})}).done(function(){e.view.showToast("计费变更已取消")}).ensure(function(){e.refresh()});else{var n="prepay"===t.productType?"TO_POSTPAY":"TO_PREPAY";m.alterProductType("RDS",[t.instanceId],n)}},e.prototype.redirectAfterDelete=function(){this.redirect("/rds/list")},require("er/util").inherits(e,l),e}),define("rds/detail.tpl",[],function(){return'\x3c!-- target: TPL_rds_detail --\x3e\r\n<div class="rds-detail rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e基本信息\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                <div class="detail-parts-table">\r\n                    <div class="row-12">\r\n                        <div class="col-6">\r\n                            <dl class="detail-part-1-col">\r\n                                <dt>\r\n                                    <h4>基本信息</h4>\r\n                                </dt>\r\n                                <dd>\r\n                                    <div class="detail-row row-12">\r\n                                        <div class="detail-row col-6">\r\n                                            <label class="fixed">\x3c!-- if: ${rdsType} === \'dcc\' --\x3e专属实例\x3c!-- /if --\x3eID： </label>\r\n                                            <span class="instance-id" title="${instance.instanceId}">${instance.instanceShortId}</span>\r\n                                        </div>\r\n                                        <div class="detail-row col-6">\r\n                                            <label>\x3c!-- if: ${rdsType} === \'dcc\' --\x3e专属实例\x3c!-- /if --\x3e名称：</label>\r\n                                            <span class="container name-container">\r\n                                                <esui-label data-ui-type="Label" data-ui-id="instanceNameLabel" class="instance-name"\r\n                                                     data-ui-title="${instance.instanceName}"> ${instance.instanceName}</esui-label>\r\n                                                \x3c!-- if: ${oprationEnable} --\x3e\r\n                                                <button data-ui-id="updateName" data-ui-type="Button" data-ui-skin="stringfy">变更</button>\r\n                                                \x3c!-- /if --\x3e\r\n                                            </span>\r\n                                            <span class="edit-container edit-name-container">\r\n                                                <span class="edit-container-inner">\r\n                                                    <input data-ui-type="TextBox"\r\n                                                           data-ui-id="nameInput"\r\n                                                           data-ui-child-name="name-input"\r\n                                                           data-ui-name="name-input"\r\n                                                           data-ui-mode="text"\r\n                                                           class="name-input"\r\n                                                           value="${instance.instanceName}" />\r\n                                                    <button data-ui-id="updateNameOk" data-ui-type="Button" data-ui-skin="ok">确定</button>\r\n                                                    <button data-ui-id="updateNameCancel" data-ui-type="Button" data-ui-skin="cancel">取消</button>\r\n                                                    <label data-ui-type="Validity"\r\n                                                           data-ui-id="instanceNameValidity"\r\n                                                           class="instance-name-validity"></label>\r\n                                                </span>\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div class="detail-row row-12">\r\n                                        <div class="detail-row col-12">\r\n                                            <label>区域可用区：</label>\r\n                                            <span>${instance.azText}</span>\r\n                                        </div>\r\n                                        \x3c!-- if: ${instance.engine} === \'MySQL\' && ${instance.instanceType} !== \'rdsproxy\' --\x3e\r\n                                        <div class="detail-row col-12">\r\n                                            <label>数据同步方式：</label>\r\n                                            <span>\r\n                                                ${instance.replicationTypeText}\r\n                                                \x3c!-- if: ${enableUpdateReplication} --\x3e\r\n                                                    \x3c!-- if: ${instance.replicationType} === \'semi_sync\' --\x3e\r\n                                                    <span data-ui-type="Label" class="link-like" data-ui-id="deactiveSemiSync">关闭半同步</span>\r\n                                                    \x3c!-- elif: ${instance.replicationType} === \'async\' --\x3e\r\n                                                    <span data-ui-type="Label" class="link-like" data-ui-id="activeSemiSync">开启半同步</span>\r\n                                                    \x3c!-- else --\x3e\r\n                                                    \x3c!-- /if --\x3e\r\n                                                \x3c!-- /if --\x3e\r\n                                                <a href="https://cloud.baidu.com/doc/RDS/GettingStarted.html#.05.68.0A.BA.0E.78.39.46.1B.6B.29.76.08.DF.06.C1" target="_blank">\r\n                                                    <i title="点击查看数据同步方式文档" class="iconfont icon-information"></i>\r\n                                                </a>\r\n                                            </span>\r\n                                        </div>\r\n                                        \x3c!-- /if --\x3e\r\n\r\n                                    </div>\r\n                                </dd>\r\n                            </dl>\r\n\r\n                            <dl class="detail-part-1-col">\r\n                                <dt>\r\n                                    <h4>网络连接</h4>\r\n                                </dt>\r\n                                <dd>\r\n                                    <div class="detail-row">\r\n                                        <label>域名：</label>\r\n                                        <span class="container domain-container">\r\n                                            <span data-ui-type="Label" data-ui-id="instanceDomainLabel"\r\n                                                class="instance-domain">${instance.endpoint.address}</span>\r\n                                            <span data-ui-type="Tip"\r\n                                                 data-ui-content="${tips.domain}"\r\n                                                 data-ui-skin="warning"\r\n                                                 class="doc-tip"></span>\r\n                                            \x3c!-- if: ${oprationEnable} --\x3e\r\n                                            <button data-ui-id="updateDomain" data-ui-type="Button" data-ui-skin="stringfy">变更</button>\r\n                                            \x3c!-- /if --\x3e\r\n                                            \x3c!-- if: ${instance.endpoint.address} --\x3e\r\n                                            <button data-ui-type="Clipboard" class="ui-button skin-stringfy skin-stringfy-button" data-ui-clipboard-text="@instance.endpoint.address" data-ui-id="copyDomain">复制</button>\r\n                                            \x3c!-- /if --\x3e\r\n                                            <button data-ui-type="Button" data-ui-id="getIpBtn" data-ui-skin="stringfy">获取IP</button>\r\n                                        </span>\r\n                                        <span class="edit-container edit-domain-container">\r\n                                            <span class="edit-container-inner">\r\n                                                <input data-ui-type="TextBox"\r\n                                                       data-ui-id="domainInput"\r\n                                                       data-ui-child-name="domain-input"\r\n                                                       data-ui-name="domain-input"\r\n                                                       data-ui-mode="text"\r\n                                                       class="domain-input"\r\n                                                       value="${instance.endpoint.address}" />\r\n                                                <esui-label data-ui-type="Label"\r\n                                                            data-ui-id="domainSuffix"\r\n                                                            class="instance-domain-suffix">${instance.domainSuffix}</esui-label><br>\r\n                                                <button data-ui-id="updateDomainOk" data-ui-type="Button" data-ui-skin="ok">确定</button>\r\n                                                <button data-ui-id="updateDomainCancel" data-ui-type="Button" data-ui-skin="cancel">取消</button><br />\r\n                                                <span>域名命名规范：1.由小写字母、数字或"-"组成；2.以小写字母开头；3.长度在3-30之间。</span><br />\r\n                                                <label data-ui-type="Validity"\r\n                                                       data-ui-id="domainValidity"\r\n                                                       class="domain-validity"></label>\r\n                                            </span>\r\n                                        </span>\r\n                                    </div>\r\n                                    <div class="row-12">\r\n                                        <div class="detail-row col-6">\r\n                                            <label class="fixed">端口：</label>\r\n                                            <span class="instance-port">${instance.endpoint.port}</span>\r\n                                        </div>\r\n                                        <div class="detail-row col-6">\r\n                                            <label>公网访问：</label>\r\n                                            <span class="container access-container">\r\n                                                <esui-label data-ui-type="Label"\r\n                                                            data-ui-id="instanceAccessLabel"\r\n                                                            class="instance-access">${instance.publiclyAccessibleText}</esui-label>\r\n                                                \x3c!-- if: ${instance.eipStatus} === \'closed\' &&  ${oprationEnable} --\x3e\r\n                                                <button data-ui-id="activeAccess" data-ui-type="Button" data-ui-skin="stringfy">开通</button>\r\n                                                \x3c!-- elif: ${instance.eipStatus} === \'available\' && ${oprationEnable} --\x3e\r\n                                                <button data-ui-id="stopAccess" data-ui-type="Button" data-ui-skin="stringfy">关闭</button>\r\n                                                \x3c!-- /if --\x3e\r\n                                            </span>\r\n                                        </div>\r\n                                    </div>\r\n                                </dd>\r\n                                <dd></dd>\r\n                            </dl>\r\n                            \x3c!-- if: ${instance.instanceType} !== \'rdsproxy\' --\x3e\r\n                            <dl class="detail-part-1-col">\r\n                                <dt>\r\n                                    <h4>使用统计</h4>\r\n                                </dt>\r\n                                <dd>\r\n                                    <div class="detail-row">\r\n                                        <label>存储空间：</label>\r\n                                        <span class="storage-wrap"><span class="storage-used" style="width:${instance.usedStorageInGBPercentage}"></span></span>\r\n                                        ${instance.usedStorageInGBPercentage}\r\n\r\n                                        <span class="with-margin">(已用${instance.usedStorageInGB}GB/总${instance.allocatedStorageInGB}GB)</span>\r\n                                        <span data-ui-type="Tip"\r\n                                            data-ui-content="${usedSpaceTip}"\r\n                                            class="doc-tip"></span>\r\n                                    </div>\r\n                                </dd>\r\n                                <dd></dd>\r\n                            </dl>\r\n                            \x3c!-- /if --\x3e\r\n\r\n\r\n                            <dl class="detail-part-1-col">\r\n                                <dt>\r\n                                    <h4>支付信息</h4>\r\n                                    \x3c!-- if:((${instance.instanceType} === \'master\' || ${instance.instanceType} === \'financial\') && ${instance.instanceStatus} === \'available\' && ${rdsType} !== \'dcc\') --\x3e\r\n                                    <button data-ui-type="Button" data-ui-id="alterProductType" class="changeOption">${alterText}</button>\r\n                                    \x3c!-- /if --\x3e\r\n                                </dt>\r\n                                <dd>\r\n                                    <div class="detail-row row-12">\r\n                                        <div class="detail-row col-6">\r\n                                            <label>支付方式：</label>\r\n                                            <span>${productTypeStr}</span>\r\n                                            \x3c!-- if: ${instance.productType} === \'postpay\' && ${instance.instanceStatus} === \'available\'\r\n                                            || ${instance.instanceStatus} === \'lockExpiration\' --\x3e\r\n                                            <button data-ui-type="Button" data-ui-skin="stringfy" data-ui-id="deleteInstance"\r\n                                                 class="ui-ctrl ui-button delete-instance" >释放实例</button>\r\n                                            \x3c!-- /if --\x3e\r\n                                        </div>\r\n                                        <div class="detail-row col-6">\r\n                                            <label>创建时间：</label>\r\n                                            <span>${instance.instanceCreateTime}</span>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    \x3c!-- if: ${instance.productType} === \'prepay\' --\x3e\r\n                                    <div class="detail-row">\r\n                                        <label>到期时间：</label>\r\n                                        <span>${instance.instanceExpireTime}</span>\r\n                                        \x3c!-- if: ${instance.instanceStatus} !== \'modifying\'\r\n                                            && ${instance.instanceStatus} !== \'creating\'\r\n                                            && ${instance.orderStatus} !== \'to_postpay\'  --\x3e\r\n                                        <button data-ui-type="Button" data-ui-skin="stringfy" data-ui-id="recharge"\r\n                                             class="ui-ctrl ui-button " >续费</button>\r\n                                        \x3c!--/if--\x3e\r\n                                    </div>\r\n                                    \x3c!-- /if --\x3e\r\n                                </dd>\r\n                            </dl>\r\n\r\n\r\n                        </div>\r\n\r\n                        <div class="col-6">\r\n                            <dl class="detail-part-1-col">\r\n                                <dt>\r\n                                    <h4>配置信息</h4>\r\n                                    \x3c!-- if: ${instance.instanceType} === \'financial\' || ${rdsType} === \'dcc\' --\x3e\r\n                                    \x3c!-- elif: ${instance.orderStatus} !== \'to_postpay\'\r\n                                        && ${instance.instanceStatus} === \'available\'\r\n                                        || ${instance.instanceStatus} === \'lockDiskQuota\' --\x3e\r\n                                    <a class="ui-ctrl ui-button changeOption" title="预付费：支持内存/磁盘升配；后付费：支持内存升配/降配；升级过程不影响实例的正常服务，具体时长与数据量有关，为生效新配置实例将会重启"\r\n                                        href="#/rds/updateConfiguration~instanceId=${instance.instanceId}">变更配置</a>\r\n                                    \x3c!-- /if --\x3e\r\n                                </dt>\r\n\r\n\r\n                                <dd>\r\n                                    \x3c!-- if: ${instance.instanceType} !== \'rdsproxy\' --\x3e\r\n                                    <div class="detail-row row-12">\r\n                                        <div class="detail-row col-6">\r\n                                            <label class="fixed">内存：</label>\r\n                                            <span class="instance-memory">${instance.allocatedMemoryText}</span>\r\n                                        </div>\r\n                                        <div class="detail-row col-6">\r\n                                            <label class="fixed">CPU：</label>\r\n                                            <span class="instance-memory">${instance.cpuCount}核</span>\r\n                                        </div>\r\n                                    </div>\r\n                                     <div class="detail-row row-12">\r\n                                        \x3c!-- if: ${rdsType} === \'dcc\' --\x3e\r\n                                        <div class="detail-row col-6">\r\n                                            <label>数据盘/总磁盘：</label>\r\n                                            <span>${instance.allocatedStorageInGB}GB/${instance.totalStorageInGB}GB</span>\r\n                                        </div>\r\n                                        \x3c!-- else --\x3e\r\n                                        <div class="detail-row col-6">\r\n                                            <label>本地磁盘：</label>\r\n                                            <span class="instance-size">${instance.allocatedStorageInGB}GB</span>\r\n                                        </div>\r\n                                        \x3c!-- /if --\x3e\r\n                                        <div class="detail-row col-6">\r\n                                            <label class="fixed">最大连接数：</label>\r\n                                            <span class="instance-memory">${instance.maxLink}</span>\r\n                                        </div>\r\n                                    </div>\r\n                                    \x3c!-- /if --\x3e\r\n\r\n                                    <div class="detail-row row-12">\r\n                                        <div class="detail-row col-6">\r\n                                            <label class="fixed">数据库版本：</label>\r\n                                            <span class="instance-database">${instance.engineName}\x3c!-- if: ${instance.instanceType} !== \'rdsproxy\' --\x3e(${instance.engineVersionName})\x3c!-- /if --\x3e</span>\r\n                                        </div>\r\n                                        \x3c!-- if: ${instance.instanceType} === \'master\' || ${instance.instanceType} === \'financial\' --\x3e\r\n                                        <div class="detail-row col-6">\r\n                                            <label>系列：</label>\r\n                                            <span class="instance-version">${instance.seriesText}</span>\r\n                                        </div>\r\n                                        \x3c!-- elif: ${instance.instanceType} === \'rdsproxy\' && !${isOldInstance} --\x3e\r\n                                        <div class="detail-row col-6">\r\n                                            <label>资源规格：</label>\r\n                                            <span class="instance-version">${instance.nodeAmountText}</span>\r\n                                        </div>\r\n                                        \x3c!-- /if --\x3e\r\n                                    </div>\r\n\r\n                                    <div class="detail-row">\r\n                                        <label>所在网络：</label>\r\n                                        <span><a href="/network/#/vpc/instance/list" target="_blank">${instance.vpcText}</a></span>\r\n                                    </div>\r\n\r\n                                    <div class="detail-row">\r\n                                        <label>子网：</label>\r\n                                        <span>${instance.subnetText|raw}</span>\r\n                                    </div>\r\n                                    \x3c!-- if: ${instance.dccHostsText} --\x3e\r\n                                    <div class="detail-row">\r\n                                        <label>专属服务器：</label>\r\n                                        <span>\r\n                                            ${instance.dccHostsText|raw}\r\n                                        </span>\r\n                                    </div>\r\n                                    \x3c!-- /if --\x3e\r\n                                </dd>\r\n                            </dl>\r\n                            \x3c!-- if: ${instance.instanceType} === \'rdsproxy\' --\x3e\r\n                            <dl class="detail-part-1-col">\r\n                                <dt>\r\n                                    <h4>\r\n                                        拓扑关系\r\n                                        <span data-ui-type="Tip"\r\n                                            data-ui-content="${tips.rdsTopologyTips}"\r\n                                            class="topology-tip"></span>\r\n                                    </h4>\r\n                                </dt>\r\n                                <dd>\r\n                                    <div class="topology-wrap">\r\n                                        <div class="switch-legend">\r\n                                            <p class="switch-on"><i class="iconfont icon-ok"></i> 流量已开启</p>\r\n                                            <p><i class="iconfont icon-ok"></i> 流量未开启</p>\r\n                                        </div>\r\n                                        <div class="tp-instance tp-proxy" title="当前实例">代理实例</div>\r\n                                        <a id="${instance.sourceInstanceId}" class="tp-instance tp-master" title="${instance.sourceInstanceId}" href="#/rds/detail~instanceId=${instance.sourceInstanceId}">主实例</a>\r\n                                        <div class="tp-readonly-wrap">\r\n                                            \x3c!-- for: ${rdsReplica} as ${item}, ${index} --\x3e\r\n                                            \x3c!-- if: ${item} --\x3e\r\n                                            <a id="${item}" class="tp-instance tp-readonly" href="#/rds/detail~instanceId=${item}" title="${item}">\r\n                                                只读实例${index}\r\n                                                <i class="iconfont icon-ok"></i>\r\n                                            </a>\r\n                                            \x3c!-- else --\x3e\r\n                                            <div class="tp-instance tp-readonly unactivated">\r\n                                                只读实例\r\n                                            </div>\r\n                                            \x3c!-- /if --\x3e\r\n                                            \x3c!-- /for --\x3e\r\n                                        </div>\r\n                                    </div>\r\n                                </dd>\r\n                            </dl>\r\n                            \x3c!-- /if --\x3e\r\n                        </div>\r\n\r\n                    </div>\r\n\r\n\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/DetailModel",["require","bat-ria/mvc/BaseModel","moment","underscore","common/region","common/flags","common/util","common/zone","./config","./helper","./enums","./tips","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("moment"),i=require("underscore"),a=require("common/region"),r=require("common/flags"),s=require("common/util"),o=require("common/zone"),c=require("./config"),l=c.api,d=require("./helper"),u=require("./enums"),p={"X-silence":!0},m={strong_sync:"强同步",semi_sync:"半同步",async:"异步",modifying:"处理中",raft:"强同步（raft协议）"};return e.prototype.datasource={tips:function(){return require("./tips")},instance:function(e){return l.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(t){d.handlePublicData(t),i.contains(c.oprationDisableStatus,t.instanceStatus)||e.set("oprationEnable",!0),t.instanceCreateTime=n(t.instanceCreateTime).format("YYYY-MM-DD HH:mm:ss"),t.instanceExpireTime=n(t.instanceExpireTime).format("YYYY-MM-DD HH:mm:ss"),t.publiclyAccessibleText=c.eipStatus[t.eipStatus]||t.eipStatus;var r=Math.round(t.usedStorageInGB/t.allocatedStorageInGB*1e4)/100;if(t.usedStorageInGBPercentage=r+"%",t.usedStorageInGB=t.usedStorageInGB.toFixed(2),t.allocatedMemoryText=t.allocatedMemoryInGB<1?parseInt(1024*t.allocatedMemoryInGB,10)+"MB":t.allocatedMemoryInGB+"GB",t.domainSuffix="."+t.endpoint.address.split(".").slice(1).join("."),"MySQL"===t.engine){t.cpu=t.cpuCount+"核",t.maxLink=c.ENGINE_INFO.MySQL.memoryInfo[t.allocatedMemoryInGB].maxLink+"个","enhanced"===t.applicationType&&(t.replicationType="strong_sync"),t.replicationTypeText=m[t.replicationType];var l=i.contains(["available","backuping","renaming"],t.instanceStatus)&&"master"===t.instanceType;e.set("enableUpdateReplication",l)}else"postgresql"===t.engine?t.maxLink="1000个":t.maxLink="不限";return t.seriesText="双机高可用版","sqlserver"===t.engine&&"2012"===t.engineVersion&&(t.seriesText="单机基础版"),"enhanced"===t.applicationType&&(t.seriesText="三节点增强版"),"financial"===t.instanceType&&(t.seriesText="raft金融版"),t.vpcText=s.getVpcName(t.vpcName)+(t.vpcCidr?"("+t.vpcCidr+")":""),t.azText=a.getCurrentRegion().label+" "+o.getLabel(t.azone),t.subnetText=i.map(t.subnets,function(e){return'<a target="_blank" href="/network/#/vpc/subnet/list~vpcId='+t.vpcId+'">'+e.name+"("+e.cidr+")</a>"}).join(" + "),"dcc"===e.get("rdsType")&&(t.dccHostsText='<span class="inline-block dcc-hosts-text">'+i.map(t.dccHosts,function(e){var t=i.escape(e.machineInstanceName),n=u.DCCInstanceRole.getTextFromValue(e.instanceRole);return e.available?'<a href="/bcc/#/dcc/host/detail~id='+e.machineInstanceId+'">'+t+"("+n+")</a>":"<span>"+t+"("+n+")</span>"}).join("<br>")+"</span>"),"financial"===t.instanceType&&e.set("rdsType","raft"),t})},isWhiteAccount:function(){return l.rdsIsWhiteAccount()},tab:function(){return{detail:"ui-tab-item-active"}},enableBatchRecharge:function(){return r.enable_batch_recharge&&r.enable_batch_recharge.rds}},e.prototype.cancelAlterProductType=function(e){return l.rdsCancelAlterProductType(e)},e.prototype.prepare=function(){var e=this,t=this.get("instance");d.getDelayInfo(this);var n=[],a=this.get("tips"),r=a.mysqlUsedSpaceTip;"sqlserver"===t.engine?r=a.sqlserverUsedSpaceTip:"postgresql"===t.engine&&(r=a.pgUsedSpaceTip),this.set("usedSpaceTip",r),"rdsproxy"===t.instanceType&&(n=t.topology.readReplica,l.rdsInstanceDetail({instanceId:t.sourceInstanceId},p).then(function(t){e.set("relatedInstance",t)}),i.each(n,function(t){l.rdsInstanceDetail({instanceId:t},p).then(function(t){e.set("relatedInstance",t)})}),this.set("isOldInstance",1===t.oldInstance),t.nodeAmountText=c.NODE_MAP[t.nodeAmount]),n.length=5,this.set("rdsReplica",n);var s="prepay"===this.get("instance").productType?"预付费":"后付费";if(this.set("productTypeStr",s),t.instanceType,"available"===t.instanceStatus){var o="to_postpay"===t.orderStatus?"取消计费变更":"计费变更";this.set("alterText",o)}},e.prototype.rdsUpdateReplicationType=function(e){return l.rdsUpdateReplicationType(e)},e.prototype.updateAccess=function(e){return l.rdsUpdateInternetAccess(e)},require("er/util").inherits(e,t),e}),define("rds/DetailView",["require","bat-ria/tpl!./detail.tpl","bat-ria/mvc/BaseView","jquery","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./detail.tpl");var t=require("bat-ria/mvc/BaseView"),n=require("jquery");return e.prototype.template="TPL_rds_detail",e.prototype.uiProperties={nameInput:{width:160,required:"required",requiredErrorMessage:"实例名称为必填",pattern:/^[a-zA-Z](\w|-|\.|\/){0,63}$/,patternErrorMessage:"实例名称不符合规则：支持大小写字母、数字以及-_ /.等特殊字符，必须以字母开头，长度1-64",validityLabel:"instanceNameValidity"},domainInput:{width:80,required:"required",requiredErrorMessage:"域名为必填",pattern:/^[a-z][a-z-0-9]{2,29}$/,patternErrorMessage:'域名不符合规则：小写字母、数字或"-"组成，第一个字母必须是字母，长度3-30',validityLabel:"domainValidity"}},e.prototype.updateInstanceDetail=function(e){var t=e.instanceShortId||e.instanceId,i=1===e.onlineStatus?"switch-on":"",a="readReplica"===e.instanceType?1===e.onlineStatus?"，流量开关：开":"，流量开关：关":"";n("#"+e.instanceId).attr("title","实例ID："+t+"，实例名称："+e.instanceName+"，内存："+e.allocatedMemoryInGB+"GB，存储磁盘："+e.allocatedStorageInGB+"G，已用"+e.usedStorageInGB.toFixed(2)+"GB"+a).addClass(i)},e.prototype.uiEvents={"updatebackupPolicy:click":function(){this.fire("updatebackupPolicy")},"updateName:click":function(){this.fire("updateName")},"updateNameOk:click":function(){this.fire("updateNameOk")},"updateNameCancel:click":function(){this.fire("updateNameCancel")},"updateDomain:click":function(){this.fire("updateDomain")},"updateDomainOk:click":function(){this.fire("updateDomainOk")},"updateDomainCancel:click":function(){this.fire("updateDomainCancel")},"recharge:click":function(){this.fire("recharge")},"deleteInstance:click":function(){this.fire("deleteInstance")},"copyDomain:aftercopy":function(e){this.showToast("已复制域名到剪贴板")},"activeAccess:click":function(){this.fire("activeAccess")},"stopAccess:click":function(){this.fire("stopAccess")},"getIpBtn:click":function(){this.fire("getIp")},"alterProductType:click":function(){this.fire("alterProductType")},"phpAdminBtn:click":function(){this.fire("goPhpAdmin")},"deactiveSemiSync:click":function(){this.fire("deactiveSemiSync")},"activeSemiSync:click":function(){this.fire("activeSemiSync")}},require("er/util").inherits(e,t),e}),define("rds/Download",["require","bat-ria/mvc/BaseAction","er/util","moment","./DownloadModel","./DownloadView"],function(require){function e(){var e={};e[this.model.get("idKey")]=this.model.get("backupId"),e.instanceId=this.model.get("instanceId"),e.downloadValidTime=30,this.model.get("urlApi")(e).then(i.bind(function(e){var t=a(e.downloadExpires).format("YYYY-MM-DD HH:mm:ss");this.model.set("url",e.url),this.view.get("urlLabel").setText(e.url),this.view.get("copyUrl").clipboardText=e.url,this.view.get("downloadExpiresLabel").setText(t)},this))}function t(){n.apply(this,arguments)}var n=require("bat-ria/mvc/BaseAction"),i=require("er/util"),a=require("moment");return t.prototype.download=function(){window.open(this.model.get("url"))},t.prototype.initBehavior=function(){this.view.on("getNewUrl",e,this)},t.prototype.modelType=require("./DownloadModel"),t.prototype.viewType=require("./DownloadView"),require("er/util").inherits(t,n),t}),define("rds/download.tpl",[],function(){return'\x3c!-- target: TPL_rds_download --\x3e\r\n<div class="rds-download">\r\n    <h3>链接地址：</h3>\r\n    <div class="url-wrap">\r\n        <esui-label data-ui-type="Label" class="url-label" data-ui-id="urlLabel">${url}</esui-label>\r\n        <button data-ui-type="Clipboard"\r\n            data-ui-clipboard-text="@url"\r\n            data-ui-id="copyUrl"\r\n            class="ui-button skin-primary-button">复制链接</button>\r\n    </div>\r\n    <div>\r\n        <span>设置链接有效时间：</span>\r\n        <input data-ui-type="TextBox" data-ui-id="timeInput"\r\n                     data-ui-child-name="time-input"\r\n                     data-ui-name="time-input"\r\n                     data-ui-mode="text"\r\n                     class="time-input"\r\n                     value="30"\r\n                     title="暂不支持修改"\r\n                     disabled="true" />\r\n        <span>分钟</span>\r\n        <label data-ui-type="Validity"\r\n                data-ui-id="timeInputValidity"\r\n                class="time-input-validity"></label>\r\n    </div>\r\n    <div class="downloadExpires">\r\n        失效时间：<esui-label data-ui-type="Label" class="expires-label" data-ui-id="downloadExpiresLabel">${downloadExpires}</esui-label>\r\n    </div>\r\n</div>\r\n\x3c!-- target: TPL_rds_download_child --\x3e\r\n\x3c!-- import: TPL_rds_download --\x3e'}),define("rds/DownloadModel",["require","bat-ria/mvc/BaseModel","moment","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("moment");return e.prototype.datasource={instanceId:function(e){return e.get("instanceId")},idKey:function(e){return e.get("idKey")},backupId:function(e){return e.get("backupId")},urlApi:function(e){return e.get("urlApi")},url:function(e){return e.get("downloadUrl")},downloadExpires:function(e){return n(e.get("downloadExpires")).format("YYYY-MM-DD HH:mm:ss")}},require("er/util").inherits(e,t),e}),define("rds/DownloadView",["require","bat-ria/tpl!./download.tpl","bat-ria/mvc/BaseView","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./download.tpl");var t=require("bat-ria/mvc/BaseView");return e.prototype.template="TPL_rds_download",e.prototype.uiProperties={timeInput:{width:30,required:"required",requiredErrorMessage:"时间为必填",pattern:/(^1440$)|(^14[0-3]\d$)|(^1[0-3]\d{2}$)|(^\d{1,3}$)/g,patternErrorMessage:"时间必须为小于1440的整数",validityLabel:"timeInputValidity"}},e.prototype.uiEvents={"timeInput:input":function(e){this.get("timeInput").validate()&&this.fire("getNewUrl")},"copyUrl:aftercopy":function(e){this.showToast("已复制到剪贴板")}},require("er/util").inherits(e,t),e}),define("rds/enums",["exports","inf-ria/EnumX","babel-runtime/helpers/interop-require-default","inf-i18n"],function(exports,e,t,n){exports.__esModule=!0;var i=t["default"](e),a=t["default"](n),r=new i["default"]({alias:"SUPER",text:a["default"]("主实例super账号"),value:"super"},{alias:"ONLY_MASTER",text:a["default"]("主实例账号"),value:"onlyMaster"},{alias:"RDS_PROXY",text:a["default"]("代理实例账号"),value:"rdsproxy"});exports.ACCOUNT_TYPE=r;var s=new i["default"]({alias:"CREATING",text:a["default"]("创建中"),value:"creating"},{alias:"AVAILABLE",text:a["default"]("运行中"),value:"available"},{alias:"UPDATING",text:a["default"]("更新中"),value:"updating"},{alias:"DELETING",text:a["default"]("删除中"),value:"deleting"},{alias:"DELETED",text:a["default"]("已删除"),value:"deleted"});exports.ACCOUNT_STATUS=s;var o=new i["default"]({alias:"MONTH",text:"按月",value:"month"},{alias:"YEAR",text:"按年",value:"year"});exports.TimeType=o;var c=new i["default"]({alias:"DATETIME",text:a["default"]("按时间点"),value:"datetime"},{alias:"SNAPSHOT",text:a["default"]("按备份集"),value:"snapshot"});exports.recoveryType=c;var l=new i["default"]({alias:"MYSQL",text:"MySQL",value:"MySQL"},{alias:"SQLSERVER",text:"SQL Server",value:"sqlserver"},{alias:"POSTGRESQL",text:"PostgreSQL",value:"postgresql"});exports.EngineType=l;var d=new i["default"]({alias:"PREPAY",text:"预付费",value:"prepay"},{alias:"POSTPAY",text:"后付费",value:"postpay"});exports.ProductType=d;var u=new i["default"]({value:"creating",text:"创建中",alias:"creating"},{value:"available",text:"运行中",alias:"available"},{value:"rebooting",text:"重启中",alias:"rebooting"},{value:"lockExpiration",text:"已到期",alias:"lockExpiration"});exports.InstanceStatus=u;var p=new i["default"]({alias:"OME",text:"1个月",value:1},{alias:"TWO",text:"2个月",value:2},{alias:"THREE",text:"3个月",value:3},{alias:"FPUR",text:"4个月",value:4},{alias:"FIVE",text:"5个月",value:5},{alias:"SIX",text:"6个月",value:6},{alias:"SEVEN",text:"7个月",value:7},{alias:"EIGHT",text:"8个月",value:8},{alias:"NINE",text:"9个月",value:9});exports.Month=p;var m=new i["default"]({alias:"ONE",text:"1年",value:1},{alias:"TWO",text:"2年",value:2},{alias:"THREE",text:"3年",value:3});exports.Year=m;var h=new i["default"]({alias:"MASTER",text:"主",value:"Master"},{alias:"BACKUP",text:"备",value:"Backup"},{alias:"SLAVE",text:"只读",value:"Slave"});exports.DCCInstanceRole=h}),define("rds/helper",["exports","module","underscore","babel-runtime/helpers/interop-require-default","jquery","saber-cookie","er/locator","common/region","common/enum","./config"],function(exports,module,e,t,n,i,a,r,s,o){var c=t["default"](e),l=t["default"](n),d=t["default"](i),u=(t["default"](a),t["default"](r)),p=t["default"](o),m={"X-silence":!0};module.exports={handlePublicData:function(e){e.readOnly="readReplica"===e.instanceType,e.isRdsproxy="rdsproxy"===e.instanceType,e.instanceShortId=e.instanceShortId||e.instanceId,e.engineVersionName=e.engineVersion,e.engineName=e.engine,p["default"].ENGINE_INFO[e.engine]&&(e.engineName=p["default"].ENGINE_INFO[e.engine].name,c["default"].each(p["default"].ENGINE_INFO[e.engine].version,function(t){t.value===e.engineVersion&&(e.engineVersionName=t.name)})),e.instanceStatusText=p["default"].instanceStatus[e.instanceStatus]||e.instanceStatus,e.instanceStatusClass=p["default"].instanceStatus.CLASS[e.instanceStatus]},goPhpAdmin:function(){var e=this.model.get("instanceId"),t=this.model.get("instance").phpAdminUrl,n=d["default"].get("bce-user-info");n&&(n=n.replace(/"/g,""));var i={method:"GET",uri:"/phpmyadmin/index.php",params:{instanceId:e},headers:{host:t},expirationPeriodInSeconds:600};l["default"].ajax({type:"POST",url:"/api/iam/authorization/generate",contentType:"application/json; charset=utf-8",headers:{csrftoken:n},data:JSON.stringify(i),async:!1}).done(function(n){var i="http://"+t+"/phpmyadmin/index.php?instanceId="+e+"&authorization="+encodeURIComponent(n.result.authorization);window.open(i)})},handleDetailPublicEvent:function(e){var t=this;c["default"].indexOf(p["default"].FINANCIAL_REGION,u["default"].getCurrentRegion().id)<0?l["default"](".raft-instance").hide():"fsh"===u["default"].getCurrentRegion().id&&l["default"](".instance").hide();var n=e.view.get("rebootInstance"),i=e.model.get("instance"),a=e.model.get("isWhiteAccount")||{};l["default"]("#php-admin-button").on("click",function(n){n.preventDefault(),t.goPhpAdmin.call(e)}),c["default"].contains(p["default"].invalidProxyStatus,i.instanceStatus)&&this.disableRdsproxyCreate(),"available"!==i.instanceStatus&&this.disableReadonlyCreate(),i.topology.rdsproxy&&i.topology.rdsproxy.length&&this.disableRdsproxyCreate("您已创建有代理实例，无法再进行创建"),"5.5"!==i.engineVersion||a.mysqlReplica||this.disableRdsproxyCreate("mysql5.5 不支持创建代理实例"),"5.5"!==i.engineVersion||a.mysqlReplica||this.disableReadonlyCreate("mysql5.5 不支持创建只读实例"),"available"!==i.instanceStatus&&"lockDiskQuota"!==i.instanceStatus?n&&n.disable():n&&n.on("click",this.rebootHandler,e);var r="售罄！请您移步其他地域购买资源。";u["default"].getCurrentRegion().id===s.AllRegion.HK02&&(this.disableRdsproxyCreate(r),this.disableReadonlyCreate(r)),e.model.on("setDelay",function(t){e.view.get("delayTime")&&e.view.get("delayTime").setText("延时"+t.delay+"秒")})},rebootHandler:function(){var e=this;this.view.waitConfirm({title:document.title,content:"重启过程中相关服务会中断，确定重启？",width:500}).then(function(){return p["default"].api.rdsRebootInstance({instanceId:e.model.get("instanceId")})}).then(function(){e.reload()})},disableRdsproxyCreate:function(e){l["default"](".create-rdsproxy").addClass("state-disabled").attr("title",e).click(function(e){return e.preventDefault()})},disableReadonlyCreate:function(e){l["default"](".create-readonly").addClass("state-disabled").attr("title",e).click(function(e){return e.preventDefault()})},getDelayInfo:function(e){var t=e.get("instanceId");e.get("instance").readOnly&&p["default"].api.rdsReplicaBehindMaster({instanceId:t},m).then(function(t){e.fire("setDelay",{delay:t.secondsBehindMaster})})},isFinancialRegion:function(){var e=u["default"].getCurrentRegion().id;return!(c["default"].indexOf(p["default"].FINANCIAL_REGION,e)<0)}}}),define("rds/List",["require","inf-ria/mvc/ListAction","underscore","jquery","er/URL","er/util","er/locator","esui/lib","inf-ria/app/brpc","common/util/dialog","common/util","common/billing/common","common/region","./config","./helper","./ListModel","./ListView"],function(require){function e(){c.apply(this,arguments);var e=this;this.on("listDataLoaded",function(){s(e.view.get("table"))})}function t(){var e=this.model.get("rdsType"),t={};"dcc"!==e?(e&&(t={rdsType:this.model.get("rdsType")}),this.redirect(u.withQuery("/rds/create",t))):this.redirect("/rds/dcc/create")}function n(e){var t=e.value,n=e.target.model.get("tableData"),i=n[e.rowIndex].instanceId,a=n[e.rowIndex].name;t!==a&&x.rdsUpdateInstanceName({instanceId:i,instanceName:t}).then(p.bind(function(){var i=this.view.get("table").getBodyCellId(e.rowIndex,e.columnIndex);d("#"+i+" .instance-name").text(t),this.view.get("table").datasource[e.rowIndex].instanceName=t,n[e.rowIndex].name=t},this)).fail(p.bind(function(t){e.target.get("table").showEditError(t.field.instanceName)},this))}function i(e){var t=this.view.get("table").datasource[e.itemIndex],n=t.instanceId,i=t.instanceName;g.waitActionDialog(this.view,{title:"释放前确认",width:600,needFoot:!0,url:"/rds/requireauthcode",actionOptions:{requester:x.rdsInstanceDelete,toastMessage:"释放成功",extraData:{instanceId:n},tip:"实例("+i+")释放后不可恢复，确定释放吗？",parentAction:this}}).then(function(e){var t=e.target;t.on("cancel",a),t.on("close",a)})}function a(){var e=this.getAction().model;e&&e.get("authCodeSent")&&x.rdsInvalidateAuthCode()}function r(e){var t=null;if(this.model.get("enableBatchRecharge")){var n=[];"undefined"!=typeof e.itemIndex?n=[(t=this.view.get("table").datasource[e.itemIndex]).instanceId]:e.instanceIds&&(n=e.instanceIds),b.recharge("RDS",n)}else t=this.view.get("table").datasource[e.itemIndex],this.redirect(u.withQuery("/rds/recharge",{instanceId:t.instanceId,serviceType:"readReplica"===t.instanceType?"RDS_REPLICA":"RDS"}))}function s(e){l.each(e.datasource,function(t,n){var i=e.getRow(n),a=m.g(e.getBodyCellId(n,1)),r=m.getChildren(a)[0].children[0].children[0];m.hasClass(r,"read-only")?m.addClass(i,"read-only-wrap"):m.hasClass(r,"rds-proxy")&&m.addClass(i,"rds-proxy-wrap")})}function o(){var e=this,t=this.view.get("engineType").getValue(),n=l.extend({engine:t},this.model.getDefaultArgs(),this.context.url.getQuery());this.model.filterTable(n).then(function(t){e.view.get("table").setDatasource(t.result),s(e.view.get("table"))})}var c=require("inf-ria/mvc/ListAction"),l=require("underscore"),d=require("jquery"),u=require("er/URL"),p=require("er/util"),m=(require("er/locator"),require("esui/lib")),h=require("inf-ria/app/brpc"),g=require("common/util/dialog"),f=require("common/util"),b=require("common/billing/common"),v=require("common/region"),y=require("./config"),x=require("./config").api,w=require("./helper");return e.prototype.initBehavior=function(){c.prototype.initBehavior.apply(this,arguments),w.isFinancialRegion()?"fsh"===v.getCurrentRegion().id&&(d(".instance").hide(),"raft"!==this.context.url.getQuery().rdsType&&this.redirect(u.withQuery("/rds/list",{rdsType:"raft"}))):d(".raft-instance").hide();var e=this;this.view.on("saveEdit",n,this),this.view.on("recharge",r,this),this.view.on("deleteInstance",i,this),this.view.on("createInstance",t,this),this.view.on("filterTable",o,this),this.view.on("cloneInstance",this.cloneInstance,this),this.view.on("refresh",this.refresh,this),this.view.on("filterList",this.filterList,this),this.view.on("editTag",this.editTag,this),this.view.on("batchDelete",this.batchDelete,this),this.view.on("alterProductType",this.alterProductType,this),this.setIntervalListenStatus(),this.on("beforeleave",function(){clearInterval(this.timer)}),this.model.get("enableBatchRecharge")&&this.view.initTableSelectItem("instanceId",""),f.isSubUser()||this.model.getRdsEnable().then(function(t){t||e.model.activeRds()})},e.prototype.filterList=function(e){this.model.setFilters(e.condition),this.view.submitSearch(e)},e.prototype.editTag=function(){var e=this,t=this.model.get("selectedObjects");l.each(t,function(e){e.resoureId=e.instanceId});var n={serviceType:"RDS",instances:t,submitRequester:x.rdsTagAssign};h.invokeService("tag://edit",n).then(function(){e.reload()})},e.prototype.syncModelToViewIterator=function(e){switch(e.name){case"rdsTags":this.view.updateKeywordType()}},e.prototype.setIntervalListenStatus=function(){this.timer=setInterval(p.bind(function(){this.refresh({force:!1})},this),y.RDS_LISTEN_INTERVAL)},e.prototype.refresh=function(e){var t=this.model.get("rdsType"),n={};if(t&&(n.rdsType=t),e&&e.force)return this.redirect(u.withQuery("/rds/list",n),{force:!0});this.asyncListPage()},e.prototype.cloneInstance=function(e){var t=this.view.get("table").datasource[e.itemIndex].instanceId;this.redirect(u.withQuery("/rds/create",{instanceId:t,type:"clone"}))},e.prototype.batchDelete=function(e){var t=this.model.get("selectedObjects"),n=l.map(t,function(e){return e.instanceId}).join(",");g.waitActionDialog(this.view,{title:"释放前确认",width:600,needFoot:!0,url:"/rds/requireauthcode",actionOptions:{requester:x.rdsInstanceDelete,toastMessage:"释放成功",extraData:{instanceId:n},extraShowData:t,tip:"实例释放后不可恢复，确定释放吗？",parentAction:this}}).then(function(e){var t=e.target;t.on("cancel",a),t.on("close",a)})},e.prototype.alterProductType=function(e){var t=this,n=this.model.get("alterType"),i=l.map(e.instanceIds,function(e){return e.split(";")[0]});"cancel"===n?this.view.waitConfirm({title:"取消计费变更",content:"确认取消计费变更？<br/>您已开通计费变更-预付费转后付费功能。<br/>实例将会在到期后自动转换为后付费的计费方式。",width:420,needFoot:!0,encode:!1}).then(function(){return t.model.cancelAlterProductType({instanceIds:i})}).done(function(){t.view.showToast("计费变更已取消")}).ensure(function(){t.refresh()}):b.alterProductType("RDS",e.instanceIds,n)},e.prototype.modelType=require("./ListModel"),e.prototype.viewType=require("./ListView"),require("er/util").inherits(e,c),e}),define("rds/list.tpl",[],function(){return'\r\n\x3c!-- target: TPL_rds_list --\x3e\r\n<div class="rds-list rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        <p class="breadcrumb">\r\n            <span>产品服务</span>\r\n            <span class="divider">/</span>\r\n            <span class="active">关系型数据库RDS-实例列表</span>\r\n        </p>\r\n\r\n        <div class="list-content rds-for-${rdsType}">\r\n            <h2>\x3c!-- if: ${rdsType} === \'dcc\' --\x3e 专属实例列表 \x3c!-- else --\x3e  关系型数据库RDS列表 \x3c!-- /if --\x3e\r\n                \x3c!-- if: !${rdsType} --\x3e\r\n                <div class="time-fliter">\r\n                    \x3c!--if: ${showMode} === \'WILLEXPIRED\'--\x3e\r\n                        <a href="#/rds/list~showMode=ALL\x3c!-- if: ${rdsType} === \'raft\' --\x3e&rdsType=raft\x3c!-- /if --\x3e">全部</a>\r\n                        <span class="divider">|</span>\r\n                        <a href="#/rds/list~showMode=WILLEXPIRED\x3c!-- if: ${rdsType} === \'raft\' --\x3e&rdsType=raft\x3c!-- /if --\x3e" class="activate">7天内到期</a>\r\n                    \x3c!--else--\x3e\r\n                        <a href="#/rds/list~showMode=ALL\x3c!-- if: ${rdsType} === \'raft\' --\x3e&rdsType=raft\x3c!-- /if --\x3e"  class="activate">全部</a>\r\n                        <span class="divider">|</span>\r\n                        <a href="#/rds/list~showMode=WILLEXPIRED\x3c!-- if: ${rdsType} === \'raft\' --\x3e&rdsType=raft\x3c!-- /if --\x3e">7天内到期</a>\r\n                    \x3c!--/if--\x3e\r\n                </div>\r\n                \x3c!-- /if --\x3e\r\n            </h2>\r\n            <div class="table-full-wrap">\r\n                <div class="operation-wrap" data-follow-thead="table">\r\n                    <div class="buttons-wrap">\r\n                        <div data-ui-id="createInstance"\r\n                            data-ui-type="Button"\r\n                            \x3c!-- if: ${disableCreate} --\x3e\r\n                            data-ui-extension-popover-type="PopoverEx"\r\n                            data-ui-popover="${i18n.售罄！请您移步其他地域购买资源。}"\r\n                            \x3c!-- /if --\x3e\r\n                            data-ui-skin="create">创建实例</div>\r\n                        \x3c!-- if: ${enableBatchRecharge}--\x3e\r\n                        <button data-ui-type="Button"\r\n                            data-ui-id="recharge"\r\n                            class="recharge-btn"\r\n                            title="批量续费">续费</button>\r\n                        \x3c!-- /if --\x3e\r\n                        <button data-ui-type="Button"\r\n                            data-ui-id="alterProductType"\r\n                            class="alter-btn"\r\n                            title="计费变更">计费变更/取消</button>\r\n                        <button data-ui-type="Button" data-ui-id="batchDeleteBtn"\r\n                            data-ui-disabled="true">释放</button>\r\n                        <button data-ui-type="Button" data-ui-id="editTag"\r\n                            class="tag-btn"\r\n                            data-ui-disabled="true">编辑标签</button>\r\n                    </div>\r\n                    <div class="buttons-quick-wrap">\r\n                        <span class="ui-group ui-search-group">\r\n                            <span data-ui-type="SelectEx" data-ui-id="keywordType"\r\n                                  data-ui-value="@keywordType" data-ui-has-child-list="true"></span>\r\n                            <input class="search-box" data-ui-type="TextBox"\r\n                                   data-ui-id="keyword" data-ui-value="@keyword"\r\n                                   data-ui-extension-textbox-type="TextBoxSelect" />\r\n                            <button data-ui-type="Button" data-ui-id="searchBtn"></button>\r\n                        </span>\r\n                        <button type="button"\r\n                            data-ui-type="Button" data-ui-id="refreshList" title="${i18n.刷新表格数据，取消筛选条件}">\r\n                            <i class="iconfont icon-refresh"></i>\r\n                        </button>\r\n                        <button data-ui="type:Button;id:downloadList;" class="download-btn" title="${i18n.下载当前列表展现的实例信息，编码格式为utf-8}">\r\n                            <i class="iconfont icon-download"></i>\r\n                        </button>\r\n                    </div>\r\n                    \x3c!-- <div data-ui-id="engineType" data-ui-type="RadioSelect" class="engine-type"></div> --\x3e\r\n                </div>\r\n                <div data-ui-type="Table" data-ui-id="table"\r\n                     data-ui-datasource="@tableData"\r\n                     data-ui-order-by="@orderBy" data-ui-order="@order"\r\n                     data-ui-select="@selectMode" data-ui-extension-tip-type="TableTip"\r\n                     data-ui-extension-command-type="Command"\r\n                     data-ui-extension-tableedit-type="TableEdit"\r\n                     data-ui-extension-tableex-type="TableEx"\r\n                     data-ui-extension-customfields-type="TableCustomFields"\r\n                     data-ui-extension-tablefilter-type="TableFilter">\r\n                </div>\r\n                <div class="ui-row clearfix">\r\n                    \x3c!-- import: listPager --\x3e\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/ListModel",["require","inf-ria/mvc/ListModel","underscore","moment","er/URL","common/zone","common/region","common/constants","common/flags","common/enum","./enums","./config","./tips","./helper","er/util"],function(require){function e(){t.apply(this,arguments),this.listRequester=m.rdsInstanceList}var t=require("inf-ria/mvc/ListModel"),n=require("underscore"),i=require("moment"),a=require("er/URL"),r=require("common/zone"),s=require("common/region"),o=require("common/constants"),c=require("common/flags"),l=require("common/enum").AllRegion,d=require("./enums"),u=require("./config"),p=require("./tips"),m=u.api,h=require("./helper"),g={"X-silence":!0};return e.prototype.datasource={enableBatchRecharge:function(e){return c.enable_batch_recharge&&c.enable_batch_recharge.rds},disableCreate:function(){return s.getCurrentRegion().id===l.HK02}},e.prototype.getRdsEnable=function(){return m.rdsStsRoleQuery({roleName:"BceServiceRole_console_rds"},{"x-silent":!0})},e.prototype.activeRds=function(){return m.rdsInstanceParam({},{"x-silent":!0}).then(function(e){return m.rdsStsRoleActive(e,{"x-silent":!0})})},e.prototype.prepare=function(){this.getRdsTags();var e=[{name:"全部",value:""}];n.each(u.ENGINE_INFO,function(t,n){e.push({name:t.name,value:n})}),this.set("engineType",e),this.set("tableSelect",this.get("enableBatchRecharge")?"multi":"");var t=this.get("filters");if("string"==typeof t){try{t=JSON.parse(t)}catch(m){}this.set("filters",t,{silent:!0});var a={};n.each(t,function(e){a[e.join("")]=!0}),this.set("filterMapper",a,{silent:!0})}this.set("keywordTypeDatasource",[{name:"主实例名称",value:"instanceName"},{name:"主实例ID",value:"instanceId"}]);var c=[{field:"instanceName",minWidth:134,width:100,sortable:!0,title:"实例名称/ID",content:function(e,t,i){var a=!n.contains(u.oprationDisableStatus,e.instanceStatus)?'<span class="ui-table-cell-editentry"data-row="'+t+'" data-col="'+i+'"></span>':"",r="";"readReplica"===e.instanceType?r="read-only":"rdsproxy"===e.instanceType?r="rds-proxy":(e.hasSlave||e.hasProxy)&&(r="master");var s='<span class="'+r+'">';return"notExist"===e.instanceStatus||"creating"===e.instanceStatus?s+='<span class="rds-type-icon instance-name">'+n.escape(e.instanceName)+'</span><br><span class="instance-id">'+(n.escape(e.instanceShortId)||n.escape(e.instanceId))+"</span></span>":("financial"===e.instanceType?s+='<a href="#/rds/detail~rdsType=raft&instanceId=':e.dccHosts?s+='<a href="#/rds/detail~rdsType=dcc&instanceId=':s+='<a href="#/rds/detail~instanceId=',s+=n.escape(e.instanceId)+'" class="rds-type-icon instance-name">'+n.escape(e.instanceName)+"</a>"+a+'<br><span class="instance-id" >'+(n.escape(e.instanceShortId)||n.escape(e.instanceId))+"</span></span>"),s},editable:function(e){return!n.contains(u.oprationDisableStatus,e.instanceStatus)},editContent:function(e){return e.instanceName},editRules:{required:"required",requiredErrorMessage:"实例名称必填",pattern:/^[a-zA-Z](\w|-|\.|\/){0,63}$/,patternErrorMessage:"实例名称不符合规则：支持大小写字母、数字以及-_ /.等特殊字符，必须以字母开头，长度1-64"}},{title:"可用区",minWidth:100,content:function(e){return s.getCurrentRegion().label+"<br>"+r.getLabel(e.azone)||"-"}},{field:"status",title:"状态",filter:{datasource:[{name:"全部",value:""}].concat(d.InstanceStatus.toArray())},minWidth:100,content:function(e){var t=n.escape(e.instanceStatus),i='<span class="status '+u.instanceStatus.CLASS[t]+'">'+(u.instanceStatus[t]||t)+"</span>";return"modifying"===e.instanceStatus&&(i+=' <span data-ui-type="Tip" data-ui-content="升级过程中，数据拷贝不影响实例的正常服务，所需时长与数据量有关，请您耐心等待。数据拷贝完毕后，实例将会重启，届时服务将中断10-20s"></span>'),i}},{field:"productType",title:"支付方式",filter:{datasource:[{name:"全部",value:""}].concat(d.ProductType.toArray())},minWidth:100,content:function(e){if("prepay"===e.productType){var t="to_postpay"===e.orderStatus,n='<span style="float:left;margin-right:2px;"><span style="'+(t?"color:#F4B329;":"")+'">预付费</span>',i=e.expireDate;return n+=t?"(待变更)<br>":"<br>",n+=0===i?"今天到期":i>0?i+"天后到期":"已过期"+-i+"天",n+="</span>",t&&(n+='<span data-ui-type="Tip" data-ui-skin="warning" data-ui-content="'+p.rdsPrepayToPostpayTip+'"></span>'),n+"</span>"}return"后付费"}},{field:"engine",title:"数据库类型",filter:{datasource:[{name:"全部",value:""}].concat(d.EngineType.toArray())},minWidth:120,content:function(e){if("rdsproxy"===e.instanceType)return"MySQL";if(!e.engine)return"-";if(!u.ENGINE_INFO[e.engine])return e.engine+"("+e.engineVersion+")";var t=u.ENGINE_INFO[e.engine].name,i=e.engineVersion;n.each(u.ENGINE_INFO[e.engine].version,function(t){t.value===e.engineVersion&&(i=t.name)});var a=t+"("+i+")";return e.applicationType&&"enhanced"===e.applicationType&&(a="三节点增强版<br>"+a),"financial"===e.instanceType&&(a+="<br>raft金融版"),a}},{field:"tag",title:"标签",minWidth:70,sortable:!0,content:function(e){if(!e.tags||e.tags.length<1)return"-";var t="",i="";return n.each(e.tags,function(e,n){i+="{"+e.tagKey+" : "+e.tagValue+"} ",n<2&&(t+=e.tagKey+" : "+e.tagValue+"<br/>")}),e.tags.length>2&&(t+="..."),'<div title="'+i+'">'+t+"</div>"}},{field:"instanceCreateTime",title:"创建时间",minWidth:120,sortable:!0,content:function(e){return i(e.instanceCreateTime).format(o.TIME_FORMAT)}},{title:"操作",minWidth:120,content:function(e,t){var n='<span class="oprations">';return"prepay"===e.productType?(n+="notExist"===e.instanceStatus||"modifying"===e.instanceStatus||"creating"===e.instanceStatus||"to_postpay"===e.orderStatus?'<span class="disabled">续费</span>':'<a data-command="recharge" data-command-args="'+t+'">续费</a>',("lockExpiration"===e.instanceStatus||"available"===e.instanceStatus&&new Date(e.instanceExpireTime)<=new Date)&&(n+='<a data-command="deleteInstance" data-command-args="'+t+'">释放实例</a>')):n+="available"===e.instanceStatus||"lockExpiration"===e.instanceStatus?'<a data-command="deleteInstance" data-command-args="'+t+'">释放实例</a>':'<span class="disabled">释放实例</span>',"MySQL"!==e.engine||e.sourceInstanceId||e.dccHosts||"financial"===e.instanceType||(n+="creating"!==e.instanceStatus?'<a data-command="cloneInstance" data-command-args="'+t+'">克隆实例</a>':'<span class="disabled">克隆实例</span>'),n+="</span>"}}];if("dcc"===this.get("rdsType")){c.splice(1,1),c.splice(2,1);var l={field:"dcc",title:"专属服务器",width:40,minWidth:75,content:function(e){return e.dccHosts?n.map(e.dccHosts,function(e){if(e){var t=n.escape(e.machineInstanceName),i=d.DCCInstanceRole.getTextFromValue(e.instanceRole);return e.available?'<a href="/bcc/#/dcc/host/detail~id='+e.machineInstanceId+'">'+t+"("+i+")</a>":"<span>"+t+"("+i+")</span>"}return"-"}).join("<br>"):"-"}};c.splice(3,0,l,{field:"dccUsed",title:"资源占用",width:40,minWidth:75,content:function(e){return"cpu："+e.cpuCount+"<br>内存："+e.allocatedMemoryInGB+"GB<br>容量："+e.totalStorageInGB+"GB"}})}this.set("tableFields",c)},e.prototype.getRdsTags=function(){var e=this;return m.rdsGetSearchTagList({serviceType:["RDS"],region:[s.getCurrentRegion().id]},g).then(function(t){var i=n.groupBy(t,"tagKey");n.each(i,function(e,t){i[t]=n.map(e,function(e){return{name:e.tagValue||"空值",value:e.tagValue}}),i[t]=[{name:"所有值",value:"@@@"}].concat(i[t])}),e.set("rdsTags",i)})},e.prototype.filterTable=function(e){return m.rdsInstanceList(e)},e.prototype.getDownloadUrl=function(){var e=this.getQuery();return e.filters&&(e.filters=JSON.stringify(e.filters)),delete e.pageNo,delete e.pageSize,delete e.instanceType,"/api/rds/instance/download?"+a.serialize(e)},e.prototype.setFilters=function(e){this.set("filters",e)},e.prototype.filterQuery=function(e){"dcc"===this.get("rdsType")&&(e.machineType="dcc");s.getCurrentRegion().id;var t=[],i=e.keyword,a=e.keywordType;if(e.filters){var r=e.filters;delete e.filters;try{r=JSON.parse(r)}catch(o){}n.each(r,function(e){t.push({keywordType:e[0],keyword:e[1]})})}return a.match(/^tag\/([\u4e00-\u9fa5\w\-\/\.]{0,64})$/)&&(a="tag","空值"===i&&(i=""),"所有值"===i&&(i="@@@")),(e.keyword||"tag"===a)&&t.push({keywordType:a,subKeywordType:e.subKeywordType||"",keyword:i||""}),"raft"===e.rdsType&&h.isFinancialRegion()&&t.push({keyword:"financial",keywordType:"instanceType"}),delete e.rdsType,e.filters=t,e},e.prototype.defaultArgs={order:"desc",orderBy:"",pageSize:10,pageNo:1,keywordType:"instanceName"},e.prototype.cancelAlterProductType=function(e){return m.rdsCancelAlterProductType(e)},require("er/util").inherits(e,t),e}),define("rds/ListView",["require","bat-ria/tpl!./list.tpl","inf-ria/mvc/ListView","underscore","common/util/tableUtil","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./list.tpl");var t=require("inf-ria/mvc/ListView"),n=require("underscore"),i=require("common/util/tableUtil");return e.prototype.template="TPL_rds_list",e.prototype.getUIProperties=function(){var e=this.model.get("tableFields");return{table:i.tableProperty(e,{followHead:!0,followHeadOffsetH:50,noFollowHeadCache:!0,extTableEx:["status"],select:"multi",selectMode:"box",editable:1,noDataHtml:"<p>暂无实例</p>"}),keywordType:{datasource:"@keywordTypeDatasource"},pager:{pageSizes:[10,20,50,100]},createInstance:{disabled:"@disableCreate",placement:{center:"top"}}}},e.prototype.checkEditTag=function(e){var t=this.get("editTag"),i=!1;n.each(e,function(e){"creating"===e.instanceStatus&&(i=!0)}),i?t.disable():t.enable()},e.prototype.checkBatchDelete=function(e){var t=this.get("batchDeleteBtn"),i=!1;n.each(e,function(e){"lockExpiration"===e.instanceStatus||"available"===e.instanceStatus&&"prepay"!==e.productType||"available"===e.instanceStatus&&"prepay"===e.productType&&new Date(e.instanceExpireTime)<new Date||(i=!0)}),i?t.disable():t.enable()},e.prototype.checkRecharge=function(e){var t=this.get("recharge"),i=!1;n.each(e,function(e){"prepay"===e.productType&&"notExist"!==e.instanceStatus&&"modifying"!==e.instanceStatus&&"creating"!==e.instanceStatus&&"to_postpay"!==e.orderStatus||(i=!0)}),i?t.disable():t.enable()},e.prototype.updateKeywordType=function(){var e=this.model.get("keywordTypeDatasource"),t=this.model.get("rdsTags"),i=this.model.get("keywordType"),a=n.map(n.keys(t),function(e){return{name:e,value:e}});e.push({name:"标签",value:"tag",children:a}),this.get("keywordType").setProperties({datasource:e,hasChildList:!0,joinStr:"/",value:i})},e.prototype.checkIfHasInvildState=function(e){if(!n.every(e,function(e){return"available"===e.instanceStatus}))return!0;if(n.every(e,function(e){return"to_postpay"===e.orderStatus}))return this.model.set("alterType","cancel"),!1;if(n.every(e,function(e){return"prepay"===e.productType&&"to_postpay"!==e.orderStatus}))return this.model.set("alterType","TO_POSTPAY"),!1;return!n.every(e,function(e){return"postpay"===e.productType})||(this.model.set("alterType","TO_PREPAY"),!1)},e.prototype.checkAlterProductType=function(e){var t=this.get("alterProductType");this.checkIfHasInvildState(e)?t.disable():t.enable()},e.prototype.enterDocument=function(){this.setTableFilterValue(),t.prototype.enterDocument.apply(this,arguments)},e.prototype.uiEvents={"table:select":function(e){var t=this.get("alterProductType"),i=this.get("recharge"),a=this.get("editTag"),r=this.get("batchDeleteBtn"),s=this.get("table").getSelectedItems(),o=n.filter(s,function(e){return"master"===e.instanceType||"financial"});if(0===o.length)return r.disable(),i.disable(),t.disable(),void a.disable();this.model.set("selectedObjects",o),this.checkRecharge(o),this.checkAlterProductType(o),this.checkEditTag(o),this.checkBatchDelete(o)},"table:saveedit":function(e){this.fire("saveEdit",e)},"table:command":function(e){this.fire(e.name,{itemIndex:+e.args})},"createInstance:click":function(){this.fire("createInstance")},"recharge:click":function(e){var t=this.get("table").getSelectedItems(),i=n.filter(t,function(e){return"master"===e.instanceType||"financial"}),a=n.map(i,function(e){return e.instanceId+";"+(e.instanceShortId||e.instanceId)});this.fire("recharge",{instanceIds:a})},"alterProductType:click":function(e){var t=this.get("table").getSelectedItems(),i=n.filter(t,function(e){return"master"===e.instanceType||"financial"}),a=n.map(i,function(e){return e.instanceId+";"+(e.instanceShortId||e.instanceId)});this.fire("alterProductType",{instanceIds:a})},"downloadList:click":function(){window.open(this.model.getDownloadUrl())},"refreshList:click":function(){this.fire("refresh",{force:!0})},"searchBtn:click":function(e){this.submitSearch(e)},"table:filter":function(e){var t=this.get("table").fields[e.fieldIndex],i=this.model.get("filters")||[],a=n.reject(i,function(e){return e[0]===t.field});a.push([t.field,e.value]),this.fire("filterList",{condition:a})},"editTag:click":function(){this.fire("editTag")},"batchDeleteBtn:click":function(){this.fire("batchDelete")},"keywordType:change":function(e){var t=this.model.get("rdsTags"),i=this.get("keyword"),a=[];if(t){var r=e.target.getSelectedItem(),s=r[0].name||r[0].text;if(r.length>1){var o=r[1].value;s="",o&&(s="标签值",a=t[o])}i.setProperties({placeholder:s?n.sprintf("请输入%s进行搜索",s):"搜索无标签实例"})}i.setProperties({datasource:a})}},e.prototype.setTableFilterValue=function(){var e=this.model.get("filters"),t=this.model.get("tableFields");e&&e.length>0?n.each(t,function(t){t.filter&&n.each(e,function(e){e[0]===t.field&&(t.filter.value=e[1])})}):n.each(t,function(e){e.filter&&(e.filter.value=null)})},e.prototype.getSearchArgs=function(){var e=t.prototype.getSearchArgs.apply(this,arguments),n=this.get("keywordType");if(n){var i=n.getSelectedItem();e.keywordType=n.getValue(),e.subKeywordType=i[1]&&i[1].value}var a=this.model.get("filters");a&&a.length>0&&(e.filters=JSON.stringify(a));var r=this.model.get("rdsType");return r&&(e.rdsType=r),e},e.prototype.initTableSelectItem=i.initTableSelectItem,require("er/util").inherits(e,t),e}),define("rds/log/config",["exports","module","er/controller","babel-runtime/helpers/interop-require-default"],function(exports,module,e,t){t["default"](e)["default"].registerAction([{type:"rds/log/Slowlog",path:"/rds/log/slowlog"}]);module.exports={}}),define("rds/log/Slowlog",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","bat-ria/mvc/ListAction","babel-runtime/helpers/interop-require-default","moment","../config","../helper","./SlowlogModel","./SlowlogView"],function(exports,module,e,t,n,i,a,r,s,o,c,l){var d=a["default"](i),u=a["default"](r),p=a["default"](o),m=a["default"](c),h=a["default"](l),g=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.initBehavior=function(){i.prototype.initBehavior.call(this),p["default"].handleDetailPublicEvent(this),this.view.get("calendar").setValue(u["default"](this.model.defaultArgs.date).format("YYYY-MM-DD")),this.view.on("download",this.showDownloadDialog,this),this.view.on("dateSelect",this.updataLogList,this)},a.prototype.showDownloadDialog=function(e){var t=this,n=this.view.get("table").datasource[e.itemIndex],i=this.model.get("instance").instanceId;this.model.getSlowlogDownloadUrl({instanceId:i,slowlogId:n.slowlogId,downloadValidTime:30}).then(function(e){return t.view.waitActionDialog({title:"下载",width:800,needFoot:!0,url:"/rds/download",defaultFoot:'<div class="ok-button ui-dialog-ok-btn"data-ui="type:Button;id:btnFootOk;childName:btnOk;">直接下载</div><div data-ui="type:Button;id:btnFootCancel;childName:btnCancel;">取消</div>',actionOptions:{idKey:"slowlogId",instanceId:i,backupId:n.slowlogId,urlApi:s.api.rdsSlowlogDownloadUrl,downloadUrl:e.url,downloadExpires:e.downloadExpires}})}).then(function(e){var t=e.target,n=t.getAction(),i=t.getChild("foot").getChild("btnOk"),a=t.getChild("foot").getChild("btnCancel");t.main.className+=" download-dialog",i.on("click",function(){n.download()}),a.on("click",function(){t.dispose()})})},a.prototype.updataLogList=function(){var e=this.view.get("calendar").getValue(),t=u["default"].utc(e+" 00:00:00+08:00").format("YYYY-MM-DDTHH:mm:ss")+"Z";this.model.defaultArgs.date=t,this.reload()},t["default"](a,[{key:"modelType",get:function(){return m["default"]}},{key:"viewType",get:function(){return h["default"]}}]),a}(d["default"]);module.exports=g}),define("rds/log/slowlog.tpl",[],function(){return'\x3c!-- target: TPL_rds_log_slowlog --\x3e\r\n<div class="rds-log-slowlog rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e日志管理\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                <div class="ui-smart-tab">\r\n                    <ul class="ui-tab-navigator">\r\n                        \x3c!-- if: !${instance.readOnly} && ${instance.engine} === \'MySQL\'--\x3e\r\n                        <li class="ui-tab-item">\r\n                            <a href="#/rds/binlog/list~instanceId=${instance.instanceId}&rdsType=${rdsType}">BINLOG</a>\r\n                        </li>\r\n                        \x3c!-- /if --\x3e\r\n                        <li class="ui-tab-item ui-tab-item-active">\r\n                            <a href="#/rds/log/slowlog~instanceId=${instance.instanceId}&rdsType=${rdsType}">SLOWLOG</a>\r\n                        </li>\r\n                    </ul>\r\n                </div>\r\n                <div class="tip-grey">\r\n                    \x3c!-- if: ${instance.applicationType} !== \'enhanced\' && ${instance.instanceType} !== \'raft\' --\x3e\r\n                    ${tips.floatTip.slowlog}\r\n                    \x3c!-- else --\x3e\r\n                    ${tips.floatTip.enhancedSlowlog}\r\n                    \x3c!-- /if --\x3e\r\n                </div>\r\n                <div class="table-full-wrap">\r\n                    <div class="ui-row">\r\n                        <span>选择时间日期：</span>\r\n                        <span data-ui-type="Calendar" data-ui-id="calendar"></span>\r\n                    </div>\r\n                    \x3c!-- import: listTableWithCommand --\x3e\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/log/SlowlogModel",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","bat-ria/mvc/ListModel","babel-runtime/helpers/interop-require-default","common/util/timeUtil","../tips","../config","../helper"],function(exports,module,e,t,n,i,a,r,s,o,c){var l=a["default"](i),d=a["default"](r),u=a["default"](s),p=a["default"](c),m=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.prepare=function(){p["default"].getDelayInfo(this)},a.prototype.getSlowlogDownloadUrl=function(e){return o.api.rdsSlowlogDownloadUrl(e)},t["default"](a,[{key:"listRequester",get:function(){return o.api.rdsSlowlogList}},{key:"datasource",get:function(){var e={log:"ui-tab-item-active"};return{instance:function(e){return o.api.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return p["default"].handlePublicData(e),e})},isWhiteAccount:function(){return o.api.rdsIsWhiteAccount()},tab:function(){return e},tips:function(){return u["default"]}}}},{key:"defaultArgs",get:function(){var e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),{order:"desc",orderBy:"id",date:d["default"].timeToUtc(e)}}}]),a}(l["default"]);module.exports=m}),define("rds/log/SlowlogView",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","bat-ria/tpl!./slowlog.tpl","bat-ria/mvc/ListView","babel-runtime/helpers/interop-require-default","humanize","moment","common/util/tableUtil","common/constants"],function(exports,module,e,t,n,i,a,r,s,o,c,l){var d=r["default"](a),u=r["default"](s),p=r["default"](o),m=r["default"](c),h=r["default"](l),g=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),t["default"](a,[{key:"template",get:function(){return"TPL_rds_log_slowlog"}},{key:"uiProperties",get:function(){var e=[{title:"序列号",content:"slowlogId"},{title:"文件大小",content:function(e){return u["default"].filesize(e.slowlogSizeInBytes)}},{title:"Slowlog文件记录的开始时间",content:function(e){return p["default"](e.slowlogStartTime).format(h["default"].TIME_FORMAT)}},{title:"Slowlog文件记录的结束时间",content:function(e){return p["default"](e.slowlogEndTime).format(h["default"].TIME_FORMAT)}},{title:"操作",content:function(e,t){return'<span class="oprations"><a data-command="download" data-command-args="'+t+'">下载</a></span>'}}];return{table:m["default"].tableProperty(e,{select:""}),calendar:{range:{begin:new Date(2014,5,1),end:new Date}}}}},{key:"uiEvents",get:function(){return{"table:command":function(e){this.fire(e.name,{itemIndex:+e.args})},"calendar:change":function(){this.get("calendar").layer.hide(),this.fire("dateSelect")}}}}]),a}(d["default"]);module.exports=g}),define("rds/migration/config",["require","er/controller"],function(require){require("er/controller").registerAction([{type:"rds/migration/Create",path:"/rds/migration/create"},{type:"rds/migration/List",path:"/rds/migration/list"}]);var e={none:0,canCancelMigration:1,canStopSync:2};return{version:"2o14-11-03",permisson:e,status:[{key:"CHECKING",text:"预检查中",per:"10",permisson:e.none},{key:"CHECKED",text:"预检查完成",per:"20",permisson:e.none},{key:"DUMPING",text:"数据导出中",per:"40",permisson:e.canCancelMigration},{key:"IMPORTING",text:"数据导入中",per:"60",permisson:e.none},{key:"REPLICATING",text:"数据同步中",per:"80",permisson:e.canStopSync},{key:"SUCCESS",text:"数据导入完成",per:"100",permisson:e.none},{key:"CANCEL",text:"数据导入取消",permisson:e.none},{key:"FAILED",text:"数据导入失败",permisson:e.none}],method:[{key:"FULLIMPORT",text:"全量导入"},{key:"FULLINCREASEIMPORT",text:"全量+增量导入"}],type:[{key:"MYSQL",text:"自建mysql数据库导入"},{key:"SQLSERVER",text:"自建SQL Server数据库导入"}],checkStatus:[{key:""}]}}),define("rds/migration/Create",["require","bat-ria/mvc/FormAction","etpl","underscore","./config","./CreateModel","./CreateView","er/util"],function(require){function e(){o.apply(this,arguments)}function t(e){var t=this.view,n=this,i=t.get("address"),a=t.get("dbUser"),r=t.get("dbPort"),s=t.get("dbPass"),o={instanceId:n.model.store.instanceId,remoteIp:i.getRawValue(),remotePort:r.getRawValue(),remoteUser:a.getRawValue(),remotePassword:s.getRawValue()};i.validate()&&a.validate()&&r.validate()&&s.validate()&&this.model.connectDb(o).then(function(e){n.model.set("connectCache",o),n.model.set("DbCache",e),n.fire("renderDbListView")})}function n(e){var t=this,n=this.view,i=this.view.templateRender("TPL_rds_migration_db_list",{engine:this.model.get("engine")}),a=n.get("contentPanel"),r=this.model.get("DbCache");a.setContent(i),n.initDbListTable(r),n.get("startMigration").onclick=function(){n.fire("startMigration")},n.get("cancelMigration").onclick=function(){t.fire("closeDialog")}}function i(){var e=this,t=e.view.getMigrationCheckParams();e.model.migrationCommit(t).then(function(t){e.model.set("migrationId",t.migrationId),e.view.fire("checkError")})}function a(){var e=this,t=e.model,n=e.view;if(t){var i={instanceId:t.store.instanceId,migrationId:t.get("migrationId")};t.rdsMigrationCheck(i).then(function(a){!0===a.checkStatus||"true"===a.checkStatus||"checked"===a.migrationStatus?t.rdsMigrationStart(i).then(function(){e.fire("renderProcessView")}):(t.set("checkCache",a),e.fire("renderCheckView"),"checked"!==a.migrationStatus&&(u=setTimeout(function(){n.fire("checkError")},3e3)))})}}function r(e){var n=this,i=this.view,a=c.getRenderer("TPL_rds_migration_check")(),r=i.get("contentPanel"),s=this.model.get("checkCache");r.setContent(a),i.initCheckTable(s.checkList),i.get("reCheck").onclick=function(){u&&(clearTimeout(u),u=null),function(){var e=this,n=this.view,i=c.getRenderer("TPL_rds_migration_connect")({});n.get("contentPanel").setContent(i),n.get("connect").onclick=function(){t.call(e)};var a=this.model.get("connectCache");n.get("address").setValue(a.remoteIp),n.get("dbUser").setValue(a.remoteUser),n.get("dbPort").setValue(a.remotePort)}.call(n)},i.get("cancelCheck").onclick=function(){n.fire("closeDialog")}}function s(e){var t=this,n=t.model;if(n){var i=t.view,a=c.getRenderer("TPL_rds_migration_process"),r=i.get("contentPanel"),s={instanceId:n.store.instanceId,migrationId:n.get("migrationId")};n.rdsMigrationCheck(s).then(function(e){if("SUCCESS"===e.migrationStatus.key)(function(e){var t=this,n=this.view,i=c.getRenderer("TPL_rds_migration_message")({message:e||"",instanceId:this.model.get("instanceId")});n.get("contentPanel").setContent(i),n.get("closeDialogLink").onclick=function(){t.fire("closeDialog")}}).call(t,"您已完成自建数据库迁移");else if("CANCEL"===e.migrationStatus.key)t.fire("closeDialog",{message:"取消迁移"});else if("FAILED"===e.migrationStatus.key)t.fire("closeDialog",{message:"迁移失败"});else{var o=-1,u=l.filter(l.deepClone(d.status),function(t){return t.key===e.migrationStatus.key?(t.state="进行中",o=1,t.isCurrent=!0):t.state=o<0?"已完成":"未完成",!!t.per}),p=a({args:u,permisson:d.permisson});r.setContent(p);var m=i.get("cancelMigration"),h=i.get("stopSync");(e.migrationStatus.permisson&d.permisson.canCancelMigration)>0?m.enable():m.disable(),m.onclick=function(){n.rdsMigrationCancel(s),m.disable()},(e.migrationStatus.permisson&d.permisson.canStopSync)>0?h.enable():h.disable(),h.onclick=function(){n.rdsMigrationStopSync(s),h.disable()},setTimeout(function(){t.fire("renderProcessView")},2e3)}})}}var o=require("bat-ria/mvc/FormAction"),c=require("etpl"),l=require("underscore"),d=require("./config"),u=null;return e.prototype.modelType=require("./CreateModel"),e.prototype.viewType=require("./CreateView"),e.prototype.initBehavior=function(){o.prototype.initBehavior.apply(this,arguments);var e=this.view;e.on("connectDb",t,this),e.on("startMigration",i,this),e.on("checkError",a,this),this.on("renderDbListView",n,this),this.on("renderCheckView",r,this),this.on("renderProcessView",s,this);var c=this.model.store.migrationTask;!c||"checking"!==c.migrationStatus&&"checked"!==c.migrationStatus?c&&(this.model.set("migrationId",c.migrationId),s.call(this)):(this.model.set("migrationId",c.migrationId),e.fire("checkError"))},require("er/util").inherits(e,o),e}),define("rds/migration/create.tpl",[],function(){return'\x3c!-- target: TPL_rds_migration_create --\x3e\r\n<div class="rds-migration-create detail-content">\r\n    <div data-ui="id:contentPanel;type:Panel">\r\n        \x3c!-- import: TPL_rds_migration_connect --\x3e\r\n    </div>\r\n</div>\r\n\r\n\x3c!-- target: TPL_rds_migration_create_child --\x3e\r\n\x3c!-- import: TPL_rds_migration_create --\x3e\r\n\r\n\x3c!-- target: TPL_rds_migration_connect --\x3e\r\n<div class="buy-step-panel" >\r\n    \x3c!-- use: TPL_rds_migration_nav(step=1) --\x3e\r\n</div>\r\n<div class="operation-tip">\r\n    注:<br>1.自建数据库账号权限见\r\n    <a data-redirect="global" href="http://bce.baidu.com/doc/RDS/Resources.html#RDS.E5.9C.A8.E7.BA.BF.E6.95.B0.E6.8D.AE.E8.BF.81.E7.A7.BB" target="_blank">迁移指南</a>。<br>2.自建数据库与目标RDS目标实例中的数据库同名且非空，不可迁移。<br>3.为保证数据的完整性，请你在迁移前做好备份操作。<br>4.数据库连接地址必须开通公网。\r\n</div>\r\n<div class="detail-parts">\r\n    <h3>自建数据库连接地址</h3>\r\n    <dl class="detail-part">\r\n\r\n        <dd>\r\n            <div class="detail-row">\r\n                <label>数据库连接地址：</label>\r\n                <span>\r\n                    <input data-ui-id="address"\r\n                           data-ui-type="TextBox"\r\n                        />\r\n                    <label data-ui="id:addressValidity;type:Validity"></label>\r\n                </span>\r\n            </div>\r\n            <div class="detail-row">\r\n                <label>数据库连接端口：</label>\r\n                <span>\r\n                    <input data-ui-id="dbPort"\r\n                           data-ui-type="TextBox"\r\n                        />\r\n                    <label data-ui="id:dbPortValidity;type:Validity"></label>\r\n                </span>\r\n            </div>\r\n            <div class="detail-row">\r\n                <label>数据库账号：</label>\r\n                <span>\r\n                    <input data-ui-id="dbUser"\r\n                           data-ui-type="TextBox"\r\n                        />\r\n                    <label data-ui="id:dbUserValidity;type:Validity"></label>\r\n                </span>\r\n            </div>\r\n            <div class="detail-row">\r\n                <label>数据库密码：</label>\r\n                <span>\r\n                    <input data-ui-id="dbPass"\r\n                           data-ui-type="TextBox"\r\n                           type="password"\r\n                        />\r\n                    <label data-ui="id:dbPassValidity;type:Validity"></label><br>\r\n                    <p class="tips">由字母、数字或下划线组成，长度6～32位</p>\r\n                </span>\r\n            </div>\r\n            <div class="detail-row">\r\n                <label></label>\r\n                <button data-ui-type="Button" data-ui-id="connect" data-ui-skin="primary">连接数据库并刷新列表</button>\r\n            </div>\r\n        </dd>\r\n    </dl>\r\n</div>\r\n\r\n\r\n\x3c!-- target: TPL_rds_migration_db_list --\x3e\r\n<div class="buy-step-panel" >\r\n    \x3c!-- use: TPL_rds_migration_nav(step=2) --\x3e\r\n</div>\r\n<div class="operation-tip">\r\n    自建数据库列表(导入数据库选择需要小于10个数据库)\r\n</div>\r\n<div class="list-content table-wrap">\r\n    <div class="clearfix">\r\n        <div class="layout-left">\r\n            <div data-ui-type="Table" data-ui-id="dbListTableLeft"\r\n                 data-ui-extension-command-type="Command" data-ui-extension-command-events="click"\r\n                 data-ui-order-by="@orderBy" data-ui-order="@order"\r\n                 data-ui-extension-tip-type="TableTip">\r\n            </div>\r\n        </div>\r\n        <div  class="layout-right">\r\n            <div data-ui-type="Table" data-ui-id="dbListTableRight"\r\n                 data-ui-extension-command-type="Command" data-ui-extension-command-events="click"\r\n                 data-ui-order-by="@orderBy" data-ui-order="@order"\r\n                 data-ui-extension-tip-type="TableTip">\r\n            </div>\r\n        </div>\r\n    </div>\r\n\r\n    <div class="ui-row">\r\n        \x3c!-- if: ${engine} !== \'sqlserver\' --\x3e\r\n        <span>是否锁表:</span>\r\n        <div data-ui-type="BoxGroup"\r\n            data-ui-id="lockTableRadio"\r\n            data-ui-name="lockTable"\r\n            class="label"\r\n            data-ui-box-type="radio" >\r\n\r\n            <input type="radio" id="lockTableOpen" name="lockTable" value="1" checked="checked" />\r\n            <label for="lockTableOpen">是</label>\r\n            <input type="radio" id="lockTableClose" name="lockTable" value="0" />\r\n            <label for="lockTableClose">否</label>\r\n        </div><br>\r\n        \x3c!-- /if --\x3e\r\n        <span >迁移方式:</span>\r\n        <div data-ui-type="BoxGroup"\r\n            data-ui-id="migrationMethodRadio"\r\n            data-ui-name="migrationMethod"\r\n            class="label"\r\n            data-ui-box-type="radio" >\r\n            <input type="radio" id="fullImport" name="migrationMethod" value="1" checked="checked" />\r\n            <label for="fullImport">全量迁移</label>\r\n            \x3c!-- if: ${engine} !== \'sqlserver\' --\x3e\r\n            <input type="radio" id="fullIncreaseImport" name="migrationMethod" value="0" />\r\n            <label for="fullIncreaseImport">（全量＋增量）迁移</label>\r\n            \x3c!-- /if --\x3e\r\n        </div>\r\n    </div>\r\n    <div class="ui-row ui-row-bottom">\r\n        <button data-ui="id:startMigration;type:Button" data-ui-skin="ok">开始迁移</button>\r\n        <button data-ui="id:cancelMigration;type:Button" data-ui-skin="cancel">取消</button>\r\n    </div>\r\n</div>\r\n\r\n\x3c!-- target: TPL_rds_migration_process --\x3e\r\n<div class="buy-step-panel" >\r\n    \x3c!-- use: TPL_rds_migration_nav(step=3) --\x3e\r\n</div>\r\n<div>\r\n    <div class="operation-tip">\r\n        迁移过程中RDS目标数据库的权限全部会变为只读，迁移结束后权限恢复。由于时间过长，为了不影响您的其他操作，您可以将该步骤关闭至后台。\r\n    </div>\r\n    <div class="form-block">\r\n        <h3>迁移进度</h3>\r\n        <div class="form-block-content">\r\n            <div class="rds-progress-bar">\r\n                \x3c!--for: ${args} as ${item},${index}--\x3e\r\n                    \x3c!--if: ${item.isCurrent} == true --\x3e\r\n                    <div class="inner-bar" style="width:${item.per}%;">\r\n                        ${item.per}%\r\n                    </div>\r\n                    \x3c!--/if--\x3e\r\n                \x3c!--/for--\x3e\r\n            </div>\r\n        </div>\r\n        <h3>迁移详情</h3>\r\n        <div class="form-block-content">\r\n            <div class="migration-progress">\r\n                <ul >\r\n                    \x3c!--for: ${args} as ${item},${index}--\x3e\r\n                        <li>\r\n                            <span> ${item.text}...</span>\r\n                            \x3c!-- if: ${item.state} === \'已完成\' --\x3e\r\n                            <div class="migration-state migration-success">\r\n                            \x3c!-- elif: ${item.state} === \'进行中\' --\x3e\r\n                            <div class="migration-state migration-progressing">\r\n                            \x3c!-- else --\x3e\r\n                            <div class="migration-state">\r\n                            \x3c!-- /if --\x3e\r\n                                <span >${item.state}\r\n                                \x3c!--if: ${item.permisson} == ${permisson.canCancelMigration}--\x3e\r\n                                    <button class="btn btn-action " data-ui="id:cancelMigration;type:Button;skin:primary">取消迁移</button>\r\n                                \x3c!--/if--\x3e\r\n                                \x3c!--if: ${item.permisson} == ${permisson.canStopSync}--\x3e\r\n                                    <button class=" btn btn-action" data-ui="id:stopSync;type:Button;skin:primary">停止同步</button>\r\n                                \x3c!--/if--\x3e\r\n                                </span>\r\n                            </div>\r\n                        </li>\r\n                    \x3c!--/for--\x3e\r\n                </ul>\r\n            </div>\r\n            <p class="operation-tip">备注：当全量迁移完成增量同步后，请根据已同步到的时间手动停止同步，操作步骤如下：1）停止向源数据库写入 2）点击”停止同步“按钮 3）将应用程序数据库连接指定的RDS</p>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n\r\n\x3c!-- target: TPL_rds_migration_check --\x3e\r\n<div class="buy-step-panel" >\r\n    \x3c!-- use: TPL_rds_migration_nav(step=2) --\x3e\r\n</div>\r\n<div class="table-wrap">\r\n    <div data-ui-type="Table" data-ui-id="checkTable"\r\n         data-ui-extension-command-type="Command" data-ui-extension-command-events="click"\r\n         data-ui-order-by="@orderBy" data-ui-order="@order"\r\n         data-ui-extension-tip-type="TableTip">\r\n    </div>\r\n    <div class="ui-row ui-row-bottom">\r\n        <button data-ui="id:reCheck;type:Button" data-ui-skin="ok">重新迁移</button>\r\n        <button data-ui="id:cancelCheck;type:Button" data-ui-skin="cancel">取消</button>\r\n    </div>\r\n</div>\r\n\r\n\x3c!--target: TPL_rds_migration_message --\x3e\r\n<div class="migration-message">\r\n    <span class="success-icon"></span>\r\n    <div class="message">\r\n        <p>${message}</p>\r\n        <label data-ui="id:closeDialogLink;type:Label">查看数据库列表>></label>\r\n    </div>\r\n</div>\r\n\r\n\x3c!-- target: TPL_rds_migration_nav --\x3e\r\n<div data-ui-type="ViewStep" data-ui-id="migrationStep" data-ui-current-step="${step}">\r\n    <ul>\r\n        <li>连接信息</li>\r\n        <li>迁移导入</li>\r\n        <li>数据库选择</li>\r\n    </ul>\r\n</div>\r\n\r\n'}),define("rds/migration/CreateModel",["require","bat-ria/mvc/FormModel","../config","./config","underscore","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/FormModel"),n=require("../config").api,i=require("./config"),a=require("underscore");return e.prototype.datasource=null,e.prototype.getDefaultArgs=function(){return{id:this.get("id")}},e.prototype.connectDb=function(e){return n.rdsConnectDb(e)},e.prototype.migrationCommit=function(e){return n.rdsMigrationCommit(e)},e.prototype.rdsMigrationCheck=function(e){return n.rdsMigrationCheck(e).then(function(e){var t=a.find(i.status,function(t){return e.migrationStatus.toUpperCase()===t.key});t&&(e.migrationStatus=t);var n=a.find(i.method,function(t){return e.migrationMethod.toUpperCase()===t.key});n&&(e.migrationMethod=n);var r=a.find(i.type,function(t){return e.migrationType.toUpperCase()===t.key});return r&&(e.migrationType=r),e})},e.prototype.rdsMigrationStart=function(e){return n.rdsMigrationStart(e)},e.prototype.rdsMigrationCancel=function(e){return n.rdsMigrationCancel(e)},e.prototype.rdsMigrationStopSync=function(e){return n.rdsMigrationStopSync(e)},require("er/util").inherits(e,t),e}),define("rds/migration/CreateView",["require","bat-ria/tpl!./create.tpl","bat-ria/mvc/FormView","underscore","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./create.tpl");var t=require("bat-ria/mvc/FormView"),n=require("underscore");e.prototype.template="TPL_rds_migration_create";var i=[{title:"数据库名称",content:function(e){return e}},{title:"是否可以迁移",content:function(e){return"可迁移"}}],a=new RegExp("^((?:(?:25[0-5]|2[0-4]d|((1d{2})|([1-9]?d))).){3}(?:25[0-5]|2[0-4]d|((1d{2})|([1-9]?d))))|([a-zA-Z0-9][-a-zA-Z0-9]{0,62}(?:.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+)$","g");return e.prototype.uiProperties={address:{width:140,placeholder:"请输入IP地址",required:"required",requiredErrorMessage:"数据库地址不能为空",pattern:a,patternErrorMessage:"IP地址无效",validityLabel:"addressValidity"},dbUser:{width:140,placeholder:"请输入用户账号",required:"required",requiredErrorMessage:"用户账号不能为空",pattern:/\w+/g,patternErrorMessage:"用户账号无效",validityLabel:"dbUserValidity"},dbPort:{width:140,placeholder:"请输入端口号",required:"required",requiredErrorMessage:"请输入端口号",pattern:/^([0-9]|[1-9]\d|[1-9]\d{2}|[1-9]\d{3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])$/g,patternErrorMessage:"端口号无效",validityLabel:"dbPortValidity"},dbPass:{width:140,placeholder:"请输入密码",required:"required",requiredErrorMessage:"密码不能为空",pattern:/^[a-zA-Z\d_]{6,32}$/,patternErrorMessage:"密码不符合规则",validityLabel:"dbPassValidity"},dbListTableLeft:{datasource:[],fields:i,sortable:!0,columnResizable:!0,select:"multi",selectMode:"line"},dbListTableRight:{datasource:[],fields:i,sortable:!0,columnResizable:!0,select:"multi",selectMode:"line"},checkTable:{datasource:[],fields:[{title:"检查项",content:function(e){return"<p>"+e.checkItem+"</p>"}},{title:"检查信息",content:function(e){return e.result?"成功":"失败"}},{title:"原因",content:function(e){return"<p>"+(e.reason||"-")+"</p>"}},{title:"正确配置方法",content:function(e){return"<p>"+(e.repairMethod||"-")+"</p>"}}],noDataHtml:"正在执行检查，请尝试刷新结果"}},e.prototype.uiEvents={"connect:click":function(){this.fire("connectDb")}},e.prototype.initDbListTable=function(e){var t=this.get("dbListTableLeft"),n=this.get("dbListTableRight"),i=e.databases.length,a=e.databases.slice(0,Math.ceil(i/2)),r=e.databases.slice(Math.ceil(i/2));t.setDatasource(a),n.setDatasource(r);var s=this.get("lockTableRadio");if(s&&(e.lockTablesPrivilege?s.setRawValue("1"):s.setRawValue("0")),"sqlserver"!==this.model.get("engine")){var o=this.get("migrationMethodRadio");e.fullIncreasePrivilege?o.setRawValue("1"):o.setRawValue("0")}},e.prototype.getMigrationCheckParams=function(){var e=this.model.get("connectCache"),t=this.model.get("engine").toLowerCase(),i=!1;if("sqlserver"!==t){var a=this.get("lockTableRadio").getRawValue();i=1===a.length&&a[0]-1==0}var r=this.get("migrationMethodRadio").getRawValue(),s=this.get("dbListTableLeft").getSelectedItems(),o=this.get("dbListTableRight").getSelectedItems(),c={databases:s.concat(o),migrationType:t,migrationMethod:1===r.length&&r[0]-1>=0?"fullImport":"fullIncreaseImport",lockTables:i};return n.extend(c,e),c},e.prototype.initCheckTable=function(e){this.get("checkTable").setDatasource(e)},require("er/util").inherits(e,t),e}),define("rds/migration/List",["require","bat-ria/mvc/BaseAction","moment","./ListModel","./ListView","er/util"],function(require){function e(){n.apply(this,arguments)}function t(){var e=this.view.get("rangeDate"),t=this.view.get("pager"),n=i(e.view.begin).format("YYYY-MM-DDT00:00:00")+"Z",a=i(e.view.end).format("YYYY-MM-DDT23:59:59")+"Z",r=t.page,s=t.pageSize,o=this;this.model.getMigrationList({instanceId:this.model.store.instanceId,startTime:n,endTime:a,pageNo:r,pageSize:s}).then(function(e){o.model.set("cache",e.result),o.view.updateTableAndPager(e)})}var n=require("bat-ria/mvc/BaseAction"),i=require("moment");return e.prototype.modelType=require("./ListModel"),e.prototype.viewType=require("./ListView"),e.prototype.initBehavior=function(){n.prototype.initBehavior.apply(this,arguments),this.view.on("query",t,this),t.call(this)},require("er/util").inherits(e,n),e}),define("rds/migration/list.tpl",[],function(){return'\x3c!-- target: TPL_rds_migration_list --\x3e\r\n<div class="rds-migration-list table-wrap">\r\n    <div class="list-header">\r\n        <label class="view-label">选择时间段：</label>\r\n     \r\n            <input data-ui-type="RangeCalendar"\r\n                   data-ui-id="rangeDate" class="range-calendar"\r\n                   data-ui-mini-mode="3" />\r\n     \r\n    </div>\r\n    \x3c!-- import: listTableWithCommand --\x3e\r\n    <div class="ui-row">\r\n    \x3c!-- import: listPager --\x3e\r\n    </div>\r\n</div>\r\n\r\n\x3c!-- target: TPL_rds_migration_list_child --\x3e\r\n\x3c!-- import: TPL_rds_migration_list --\x3e'}),define("rds/migration/ListModel",["require","bat-ria/mvc/BaseModel","../config","underscore","./config","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("../config").api,i=require("underscore"),a=require("./config");return e.prototype.datasource=[],e.prototype.defaultArgs={order:"desc",pageSize:15},e.prototype.getMigrationList=function(e){return i.extend(e,{}),n.rdsMigrationList(e).then(function(e){return function(e){return i.each(e.result,function(e){var t=i.find(a.status,function(t){return e.migrationStatus.toUpperCase()===t.key});t&&(e.migrationStatus=t);var n=i.find(a.method,function(t){return e.migrationMethod.toUpperCase()===t.key});n&&(e.migrationMethod=n);var r=i.find(a.type,function(t){return e.migrationType.toUpperCase()===t.key});r&&(e.migrationType=r)}),e}(e)})},require("er/util").inherits(e,t),e}),define("rds/migration/ListView",["require","bat-ria/tpl!./list.tpl","bat-ria/mvc/BaseView","common/util/timeUtil","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./list.tpl");var t=require("bat-ria/mvc/BaseView"),n=require("common/util/timeUtil");e.prototype.template="TPL_rds_migration_list";var i=[{title:"迁移类型",content:function(e){return e.migrationType.text}},{title:"迁移模式",content:function(e){return e.migrationMethod.text}},{title:"迁移时间",content:function(e){return e.createTime?n.toTime(e.createTime):"-"}},{title:"迁移状态",content:function(e){return e.migrationStatus.text}}];return e.prototype.uiProperties={table:{datasource:[],fields:i,sortable:!0,columnResizable:!0},pager:{pageSize:10}},e.prototype.uiEvents={pager:{pagechange:function(e){this.fire("query")},pagesizechange:function(e){this.fire("query")}},"rangeDate:change":function(e){this.fire("query")}},e.prototype.updateTableAndPager=function(e){e=e||{};var t=this.get("table"),n=this.get("pager"),i=this.model.get("cache")||e.cache;t.setDatasource(i),e.totalCount&&n.set("count",e.totalCount),e.pageNo&&n.set("page",e.pageNo),e.pageSize&&n.set("pagesize",e.pageSize)},require("er/util").inherits(e,t),e}),define("rds/Monitor",["require","bat-ria/mvc/BaseAction","jquery","underscore","inf-ria/utils/mtools","common/constants","./helper","inf-ria/helper","./MonitorModel","./MonitorView","er/util"],function(require){function e(){r.apply(this,arguments)}function t(e){var t=this,n=this.model.get("monitorMetric"),i=c.adjustToChartMetric(n);o.each(i,function(i,a){var r=s.extend(!0,{},e.params);"rdsproxy"===t.model.get("instance").instanceType?r.metricName=i.metrics[0]:r.metricNames=i.metrics,r.statistics=i.statistics,t.view.monitorCharts[a]&&(t.view.monitorCharts[a].dispose(),delete t.view.monitorCharts[a]),s("#js-chart-"+a).data({metricNames:r.metricNames,statistics:r.statistics}),t.model.getMonitorTrends(r).then(function(e){t.view.renderMonitorChart(a,e,n[a],r)},function(e){s("#js-chart-"+a).html('<span class="err-tips">'+o.escape(e.global)+"</span>")})})}function n(e){var t=this.model.get("instance"),n=this.model.get("monitorMetric")[e.chart],i="rdsproxy"===t.instanceType?"dimensions":"metricName",a=this.model.get("shortidMap");this.view.waitActionDialog({title:n.name,width:800,url:"/common/bcm/monitorChart",actionOptions:{scope:l,dimensions:this.model.get("dimensions"),statistics:e.statistics,timeRange:e.timeRange,periodInSecond:e.periodInSecond,metric:n,apiType:i,dimensionsMap:a}}).then(function(e){e.target.resize()})}function i(){require("inf-ria/helper").redirectToModule("bcm","/bcm/alarm/rule",{scope:l,dimensions:"InstanceId:"+this.model.get("instanceId")})}function a(){var e=this;this.model.getAlarmState({scope:l,dimensions:"InstanceId:"+this.model.get("instanceId")}).then(function(t){e.view.refreshAlarmState(t)})}var r=require("bat-ria/mvc/BaseAction"),s=require("jquery"),o=require("underscore"),c=require("inf-ria/utils/mtools"),l=require("common/constants").MONITOR_SCOPE.RDS,d=require("./helper");return e.prototype.initBehavior=function(){r.prototype.initBehavior.apply(this,arguments),d.handleDetailPublicEvent(this),this.view.on("getMonitorTrends",t,this),this.view.on("showDetailTrend",n,this),this.view.on("toAlarmDetail",i,this),this.view.on("getAlarmState",a,this),this.on("beforeleave",function(){clearInterval(this.view.timer),s(window).off("resize.rds"),s(".icon-show-big").off("click")}),this.view.initMonitor.call(this.view)},e.prototype.modelType=require("./MonitorModel"),e.prototype.viewType=require("./MonitorView"),require("er/util").inherits(e,r),e}),define("rds/monitor.tpl",[],function(){return'\x3c!-- target: TPL_rds_monitor --\x3e\r\n<div class="rds-monitor rds-main-wrap main-wrap-new monitor">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e监控\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                <div class="alarm-info ui-row">\r\n                    ${i18n.报警信息：}\r\n                    <span class="alarm-state"><span class="status normal"></span><span id="js-alarm-state-ok"></span> ${i18n.项状态正常}</span>\r\n                    <span class="alarm-state"><span class="status error"></span><span id="js-alarm-state-alarm"></span> ${i18n.项状态异常}</span>\r\n                    <span class="alarm-state"><span class="status warning"></span><span id="js-alarm-state-insufficient"></span> ${i18n.项数据不足}</span>\r\n                    <a href="/bcm/#/bcm/alarm/rule~scope=${monitorScope}&dimensions=InstanceId:${instanceId}" target="_blank" class="ui-button alarm-detail">${i18n.报警详情}</a>\r\n                </div>\r\n                \x3c!-- use: monitor_trend_search(type="monitor") --\x3e\r\n                <div class="monitor-trends">\r\n                    \x3c!-- for: ${monitorMetric} as ${chartMetric}, ${chart} --\x3e\r\n                    <div class="monitor-trend-box">\r\n                        <div class="monitor-trend-wrap" >\r\n                            <span class="title">${chartMetric.name}</span>\r\n                            <span class="icon-show-big" data-chart="${chart}"></span>\r\n                            <div class="chart" id="js-chart-${chart}"></div>\r\n                        </div>\r\n                    </div>\r\n                    \x3c!-- /for --\x3e\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/MonitorModel",["require","bat-ria/mvc/BaseModel","underscore","./config","./helper","./tips","jquery","inf-ria/utils/mtools","common/constants","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("underscore"),i=require("./config"),a=i.api,r=require("./helper");return e.prototype.datasource=[{tips:function(){return require("./tips")},instance:function(e){return a.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return r.handlePublicData(e),e})},isWhiteAccount:function(){return a.rdsIsWhiteAccount()},tab:function(){return{monitor:"ui-tab-item-active"}}},{shortidMap:function(e){var t=e.get("instance");if("rdsproxy"===t.instanceType){var n=t.topology.master.concat(t.topology.readReplica);return a.rdsGetInstanceShortids({instanceIds:n})}return{}}}],e.prototype.prepare=function(){var e=this.get("instance"),t="available"===e.eipStatus,a=require("jquery");if("rdsproxy"===e.instanceType){var s=e.topology,o=n.map(n.union(s.master,s.readReplica),function(e){return"InstanceId:"+e});this.set("monitorMetricOrigin",i.rdsproxyMonitorMetric),this.set("dimensions",o)}else{var c=n.deepClone(i.monitorMetric),l="";l="sqlserver"===e.engine||"postgresql"===e.engine?n.omit(c,["mysqlSlowQueriesPt","secondsBehindMaster"]):c,this.set("monitorMetricOrigin",l),this.set("dimensions","InstanceId:"+this.get("instanceId"))}var d=a.extend(!0,{},this.get("monitorMetricOrigin"));t||require("inf-ria/utils/mtools").filterMetrics(d,"eip",t),this.set("monitorMetric",d);var u=require("common/constants");this.set("monitorScope",u.MONITOR_SCOPE.RDS),r.getDelayInfo(this)},e.prototype.getMonitorTrends=function(e){return"rdsproxy"===this.get("instance").instanceType?a.bcmMetricDataDimensions(e):a.bcmMetricDataMetricName(e)},e.prototype.getAlarmState=function(e){return a.bcmAlarmStateSummary(e)},require("er/util").inherits(e,t),e}),define("rds/MonitorView",["require","bat-ria/tpl!./monitor.tpl","bat-ria/mvc/BaseView","jquery","underscore","inf-ria/echarts","common/constants","inf-ria/utils/mtools","./config","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./monitor.tpl");var t=require("bat-ria/mvc/BaseView"),n=require("jquery"),i=require("underscore"),a=require("inf-ria/echarts"),r=require("common/constants"),s=require("inf-ria/utils/mtools");return e.prototype.template="TPL_rds_monitor",e.prototype.uiProperties={},e.prototype.uiEvents={"monitorTimeRange:change":function(){this.getMonitorTrends()},"monitorRefresh:click":function(){this.getMonitorTrends()},"toAlarm:click":function(){this.fire("toAlarmDetail")}},e.prototype.initMonitor=function(){var e=this;e.monitorCharts={},e.registerMonitorEvents(),e.fire("getAlarmState"),e.getMonitorTrends(),e.timer=setInterval(function(){e.fire("getAlarmState")},r.ALARM_STATE_QUERY_PERIOD)},e.prototype.registerMonitorEvents=function(){var e=this;n(window).on("resize.rds",function(){i.each(e.monitorCharts,function(e,t){e&&e.resize()})}),n(".icon-show-big").click(function(t){var i=require("./config"),a=n(this).attr("data-chart"),r=n("#js-chart-"+a).data("statistics"),s=e.get("monitorTimeRange").getValue(),o=i.monitorDefaultPeriod[s]||60;e.fire("showDetailTrend",{chart:a,statistics:r,timeRange:s,periodInSecond:o})})},e.prototype.getMonitorTrends=function(){var e=this.get("monitorTimeRange").getValue(),t=require("./config").monitorDefaultPeriod[e]||60,n={periodInSecond:t,startTime:(e=s.getUTCTimeRange(e,t)).startTime,endTime:e.endTime,dimensions:this.model.get("dimensions"),scope:this.model.get("monitorScope")};this.fire("getMonitorTrends",{params:n})},e.prototype.renderMonitorChart=function(e,t,n,r){if("rdsproxy"===this.model.get("instance").instanceType){var o=this.model.get("shortidMap");i.each(t.series,function(e){o[e.name]&&(e.name=o[e.name])})}n.statistics=r.statistics,s.adjustSeriesData(t,r.statistics);var c=s.getChartOptions(t,n,null,{period:r.periodInSecond});this.monitorCharts[e]=a.init(document.getElementById("js-chart-"+e)),this.monitorCharts[e].setOption(c,!0)},e.prototype.refreshAlarmState=function(e){n("#js-alarm-state-ok").text(e.okStateCount),n("#js-alarm-state-alarm").text(e.alarmStateCount),n("#js-alarm-state-insufficient").text(e.insufficientStateCount)},require("er/util").inherits(e,t),e}),define("rds/recharge/config",["require","er/controller"],function(require){require("er/controller").registerAction([{type:"rds/recharge/Recharge",path:"/rds/recharge"}]);return{}}),define("rds/recharge/Recharge",["require","bat-ria/mvc/BaseAction","moment","common/util/timeUtil","common/region","common/util/moneyUtil","common/constants","common/util/orderUtil","./RechargeModel","./RechargeView","er/util"],function(require){function e(){i.apply(this,arguments)}function t(){var e=this.model.get("instanceDetail"),t=a(e.instanceExpireTime),n=this.view.get("duration").getRawValue(),i=r.toTime(t.month(t.month()+n));this.view.get("expireTime").setText(i),function(e,t){var n=this;this.model.getPrice(e,t).then(function(t){var i="postpay"===e.productType,a=o.convertPrice(t.price),r="￥"+a.getPriceOfMinute();i&&(r+="/分钟"),n.model.set("price",a.getPriceOfMinute()),n.view.get("price").setText(r)})}.call(this,e,n)}function n(){var e={instanceId:this.model.get("instanceDetail").instanceId,duration:this.view.get("duration").getRawValue()},t=function(e){var t=this.model.get("instanceDetail"),n=this.model.get("price"),i="￥"+n+"/台",a="RDS"===this.model.get("serviceType")?"RDS主实例":"RDS只读实例";return l.make({serviceType:"RDS",productType:t.productType,type:"RENEW",price:n,items:[{serviceType:"RDS",productType:t.productType,count:1,price:n,time:e.duration,timeUnit:"MONTH",unitPrice:n,unitPriceShow:i,chargeType:c.SERVICE_TYPE.RDS.chargeType[t.productType],configuration:["地域："+s.getCurrentRegion().label,"实例类型："+a]}]})}.call(this,e);this.view.renderOrderConfirm(t,e)}var i=require("bat-ria/mvc/BaseAction"),a=require("moment"),r=require("common/util/timeUtil"),s=require("common/region"),o=require("common/util/moneyUtil"),c=require("common/constants"),l=require("common/util/orderUtil");return e.prototype.modelType=require("./RechargeModel"),e.prototype.viewType=require("./RechargeView"),e.prototype.initBehavior=function(){i.prototype.initBehavior.apply(this,arguments),this.view.on("durationChange",t,this),this.view.on("recharge",n,this),t.call(this)},require("er/util").inherits(e,i),e}),define("rds/recharge/recharge.tpl",[],function(){return'\x3c!-- target: TPL_rds_recharge_recharge --\x3e\r\n<div class="rds-recharge-recharge">\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e\r\n            \x3c!-- if: ${serviceType} === \'RDS\' --\x3e续费RDS\r\n            \x3c!-- else --\x3e续费只读RDS\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        <div class="create-content">\r\n            <div data-ui-type="ViewStep"\r\n                    data-ui-id="buyStep"\r\n                    data-ui-current-step="1">\r\n                <ul>\r\n                    <li bind-for="tab1">续费</li>\r\n                    <li bind-for="tab2">确认</li>\r\n                    <li >续费成功</li>\r\n                </ul>\r\n            </div>\r\n            <div class="ui-tab-navigator"></div>\r\n            <div id="tab1" class="ui-tab-content">\r\n                <div class="detail-parts-table">\r\n                    <dl class="detail-part-1-col">\r\n                        <dt>\r\n                            <h4>续费信息</h4>\r\n                        </dt>\r\n                        <dd>\r\n                            <div class="form-cell">\r\n                                <label>实例ID:</label>\r\n                                <div class="form-value">\r\n                                    ${instanceId}\r\n                                </div>\r\n                            </div>\r\n                        </dd>\r\n                        <dd>\r\n                            <div class="form-cell">\r\n                                <label>到期时间</label>\r\n                                <div class="form-value">\r\n                                    ${instanceDetail.instanceExpireTime|formatTime}\r\n                                </div>\r\n                            </div>\r\n                        </dd>\r\n                        <dd>\r\n                            <div class="form-cell">\r\n                                <label>续费时长：</label>\r\n                                <div class="form-value">\r\n                                    <span class="ui-group ui-select-group">\r\n                                        <span data-ui-type="Select" data-ui-id="durationType"></span>\r\n                                        <span data-ui-type="Select" data-ui-name="duration"\r\n                                        data-ui-id="duration"></span>\r\n                                    </span>\r\n                                </div>\r\n                            </div>\r\n                        </dd>\r\n                        <dd>\r\n                            <div class="form-cell">\r\n                                <label>续费后到期时间：</label>\r\n                                <div class="form-value">\r\n                                    <span data-ui="id:expireTime;type:Label"></span>\r\n                                </div>\r\n                            </div>\r\n                        </dd>\r\n                        <dd>\r\n                            <div class="form-cell">\r\n                                <label></label>\r\n                                <div class="form-value">\r\n                                    配置费用：\r\n                                    <span data-ui="id:price;type:Label" class="price"></span>\r\n                                </div>\r\n                            </div>\r\n                        </dd>\r\n                        <dd>\r\n                            <div class="form-cell">\r\n                                <label></label>\r\n                                <div class="form-value">\r\n                                    <button data-ui="id:rechargeConfirm;type:Button;" class="confirm-button">续费</button>\r\n                                </div>\r\n                            </div>\r\n                        </dd>\r\n                    </dl>\r\n                </div>\r\n            </div>\r\n            <div id="tab2" class="ui-tab-content clearfix">\r\n                <div data-ui="id:orderAction;type:ActionPanel"></div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n'}),define("rds/recharge/RechargeModel",["require","bat-ria/mvc/BaseModel","underscore","common/region","../config","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("underscore"),i=require("common/region"),a=require("../config").api;return e.prototype.datasource={instanceDetail:function(e){return a.rdsInstanceDetail({instanceId:e.get("instanceId")})}},e.prototype.getPrice=function(e,t){var r=n.pick(e,"cpuCount","allocatedMemoryInGB","allocatedStorageInGB","engine","engineVersion");return n.extend(r,{location:i.BEI_JING?i.BEI_JING.value:"bj"}),a.rdsGetPrice({instance:r,number:1,productType:e.productType,duration:t})},require("er/util").inherits(e,t),e}),define("rds/recharge/RechargeView",["require","bat-ria/tpl!./recharge.tpl","bat-ria/mvc/BaseView","inf-ria/app/brpc","common/constants","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./recharge.tpl");var t=require("bat-ria/mvc/BaseView"),n=require("inf-ria/app/brpc"),i=require("common/constants").DURATION;return e.prototype.template="TPL_rds_recharge_recharge",e.prototype.uiProperties={durationType:{datasource:[{name:"按月",value:"MONTH"},{name:"按年",value:"YEAR"}],selectedIndex:0},duration:{datasource:i.MONTH,selectedIndex:0}},e.prototype.uiEvents={"durationType:change":function(e){var t=e.target.getValue();this.get("duration").setProperties({datasource:i[t]}),this.fire("durationChange")},"duration:change":function(){this.fire("durationChange")},"rechargeConfirm:click":function(){this.fire("recharge")},"orderAction:action@prevPage":function(){this.renderRechargeConfig()}},e.prototype.renderOrderConfirm=function(e,t){var i=this.get("orderAction"),a=this.get("buyStep"),r={order:e,config:t};n.invokeService("billing://order_confirm",i,r).then(function(){a.set("currentStep",2)})},e.prototype.renderRechargeConfig=function(){var e=this.get("orderAction");this.get("buyStep").set("currentStep",1),e.disposeAction()},require("er/util").inherits(e,t),e}),define("rds/RequireAuthCode",["require","bat-ria/mvc/FormAction","./RequireAuthCodeModel","./RequireAuthCodeView","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/FormAction");return e.prototype.modelType=require("./RequireAuthCodeModel"),e.prototype.viewType=require("./RequireAuthCodeView"),e.prototype.redirectAfterSubmit=function(){var e=this.model.get("parentAction");e&&(e.redirectAfterDelete&&e.redirectAfterDelete()||e.reload())},e.prototype.initBehavior=function(){t.prototype.initBehavior.apply(this,arguments),this.on("beforesubmit",function(){this.toastMessage=this.model.get("toastMessage")||"";var e=this.model.get("requester");e&&(this.model.submitRequester=e)},this)},e.prototype.handleSubmitError=function(){},require("er/util").inherits(e,t),e}),define("rds/requireauthcode.tpl",[],function(){return'\x3c!-- target: TPL_rds_instance_requireauth_code --\x3e\r\n<div class="rds-instance-requireauth-code main-wrap-new">\r\n    \x3c!-- if: ${tip} --\x3e\r\n    <p class="tip-yellow">${tip}</p>\r\n    \x3c!-- /if --\x3e\r\n\r\n\r\n\r\n    <form data-ui-type="Form"\r\n          data-ui-id="form"\r\n          data-ui-auto-validate="true">\r\n        <table>\r\n            \x3c!-- if: ${extraShowData} --\x3e\r\n            <tr>\r\n                <th class="form-label">待删除实例：</th>\r\n                <td>\r\n                    <div data-ui-type="Table" data-ui-id="table" data-ui-width="420"></div>\r\n                </td>\r\n            </tr>\r\n            \x3c!-- /if --\x3e\r\n        </table>\r\n    </form>\r\n\r\n</div>\r\n\r\n\x3c!-- target: TPL_rds_instance_requireauth_code_child --\x3e\r\n\x3c!-- import: TPL_rds_instance_requireauth_code --\x3e\r\n'}),define("rds/RequireAuthCodeModel",["require","bat-ria/mvc/FormModel","./config","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/FormModel"),n=require("./config").api;return e.prototype.datasource={userInfo:function(e){return n.userInfo()}},e.prototype.sendAuthCode=function(){return n.rdsSendAuthCode({})},e.prototype.getExtraData=function(){return this.get("extraData")},require("er/util").inherits(e,t),e}),define("rds/RequireAuthCodeView",["require","bat-ria/tpl!./requireauthcode.tpl","bat-ria/mvc/FormView","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./requireauthcode.tpl");var t=require("bat-ria/mvc/FormView");e.prototype.template="TPL_rds_instance_requireauth_code";return e.prototype.uiProperties={table:{datasource:"@extraShowData",fields:[{title:"实例名称",content:function(e){return e.instanceName}},{title:"实例ID",content:function(e){return e.instanceShortId||e.instanceId}},{title:"有无只读/代理实例",content:function(e){return e.hasProxy||e.hasSlave?"有":"无"}}]}},e.prototype.uiEvents={},require("er/util").inherits(e,t),e}),define("rds/security/config",["exports","module","er/controller","babel-runtime/helpers/interop-require-default"],function(exports,module,e,t){t["default"](e)["default"].registerAction([{type:"rds/security/Firewall",path:"/rds/security/firewall"},{type:"rds/security/Ssl",path:"/rds/security/ssl"}]);module.exports={}}),define("rds/security/Firewall",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","bat-ria/mvc/BaseAction","babel-runtime/helpers/interop-require-default","moment","../config","../helper","jquery","etpl","./FirewallModel","./FirewallView"],function(exports,module,e,t,n,i,a,r,s,o,c,l,d,u){var p=a["default"](i),m=(a["default"](r),a["default"](o)),h=a["default"](c),g=a["default"](l),f=a["default"](d),b=a["default"](u),v=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.initBehavior=function(){var e=this;i.prototype.initBehavior.call(this),m["default"].handleDetailPublicEvent(this);var t=this.view,n=!this.model.get("dbfirewall")||"关闭"!==this.model.get("dbfirewall").dbfwStatus,a=(h["default"]('input[name="fwStatus"]'),h["default"]('input[name="fwRule"]'));n||a.attr("disabled","disabled"),t.updatePageAndTable(),t.on("addToWhitelist",function(n){var i=t.get("table").datasource[n.itemIndex];t.waitConfirm({title:"添加SQL白名单提示",content:"请确定将以下SQL加入白名单：<br>"+i.sqlFingerprint,encode:!1,width:500}).then(function(){s.api.rdsAddtoWhitelist({instanceId:e.model.get("instanceId"),dbName:i.dbName,sqlMd5:i.sqlMd5,sqlFingerprint:i.sqlFingerprint})})}),t.on("delfromWhitelist",function(n){var i=t.get("sqlWhitelist").datasource;selectItem=i[n.itemIndex],s.api.rdsDelfromWhitelist({instanceId:e.model.get("instanceId"),sqlMd5:selectItem.sqlMd5}).then(function(){i.splice(n.itemIndex,1),t.get("sqlWhitelist").setDatasource(i)})}),t.on("fwEditSave",function(){var t="true"==h["default"]('input[name="fwStatus"]:checked').val(),i=+h["default"]('input[name="fwRule"]:checked').val();null!=t&&null!=i&&(n===t?e.model.saveEdit(t,i).then(function(t){e.reload()}):e.view.waitConfirm(1==t?{title:"DB防火墙开启提示",content:"DB防火墙开启后，会增加防御SQL注入的能力，SQL响应时间影响较小,每条SQL增加0.1毫秒延时，请确认是否开启？",width:500}:{title:"DB防火墙关闭提示",content:"DB防火墙关闭后，代理实例不再具有防御SQL注入的功能，请确认是否关闭？",width:500}).then(function(){e.model.saveEdit(t,i).then(function(t){e.reload()})}))},this),t.on("fwEditCancel",function(){h["default"](".fw-edit-container").hide(),h["default"](".fw-edit-ctrl").show()}),t.on("getSqlinjectDetail",function(n){var i=t.get("table").datasource[n.data];e.model.getSqlinjectDetail(e.model.get("instanceId"),i.sqlId).then(function(e){t.setSubrowContent(e,n.data)})}),h["default"]('span[name="edit-btn"]').click(function(){h["default"](".fw-edit-ctrl").hide();var t=e.model.get("dbfirewall");"开启"==t.dbfwStatus?h["default"](".fwStatusOn").attr("checked",!0):h["default"](".fwStatusOff").attr("checked",!0),"告警"==t.dbfwRule?h["default"](".fwRuleAlarm").attr("checked",!0):h["default"](".fwRuleBlock").attr("checked",!0),h["default"](".fw-edit-container").show()}),h["default"](".sqlAuditTab").click(this.changeTab.bind(this,"TPL_rds_sqlAudit")),h["default"](".sqlWhitelistTab").click(this.changeTab.bind(this,"TPL_rds_sqlWhitelist")),h["default"](".open-icon").click(function(e){var t=h["default"](e.target);return t.hasClass("open-icon-rotate")?t.removeClass("open-icon-rotate"):t.addClass("open-icon-rotate"),!1}),h["default"]('input[name="fwStatus"]').change(function(e){"fwStatusOn"===e.target.className?a.attr("disabled",!1):a.attr("disabled","disabled")})},a.prototype.changeTab=function(e){var t=this.view,n=t.get("sqlInjection"),i=g["default"].getRenderer(e)(this.model.store);if("TPL_rds_sqlAudit"===e?(h["default"](".sql-audit-tab").addClass("ui-tab-item-active"),h["default"](".sql-whitelist-tab").removeClass("ui-tab-item-active")):(h["default"](".sql-whitelist-tab").addClass("ui-tab-item-active"),h["default"](".sql-audit-tab").removeClass("ui-tab-item-active")),n){n.setContent(i);var a=t.get("pager"),r=t.get("table")||t.get("sqlWhitelist");a.onchangepage=t.uiEvents.pager.pagechange.bind(t),a.onchangepagesize=t.uiEvents.pager.pagesizechange.bind(t),r.onsubrowopen=t.uiEvents.table.subrowopen.bind(t),r.oncommand=t.uiEvents[r.id].command.bind(t);var s=t.get("searchBtn");return s&&(s.onclick=t.uiEvents.searchBtn.click.bind(t)),t.updatePageAndTable(),!1}},t["default"](a,[{key:"modelType",get:function(){return f["default"]}},{key:"viewType",get:function(){return b["default"]}}]),a}(p["default"]);module.exports=v}),define("rds/security/firewall.tpl",[],function(){return'\x3c!-- target: TPL_rds_security_firewall --\x3e\n<div class="rds-security-firewall rds-main-wrap main-wrap-new">\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\n    <div class="content-wrap">\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\n            \x3c!-- block: list_link --\x3e\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\n            \x3c!-- else --\x3e#/rds/list"\n            \x3c!-- /if --\x3e\n            \x3c!-- /block --\x3e\n            \x3c!-- block: text_content_wrapper --\x3e DB防火墙\x3c!-- /block --\x3e\n        \x3c!-- /import --\x3e\n        \x3c!-- import: TPL_rds_tab --\x3e\n            <div class="ui-tab-content">\n                <div class="ui-smart-tab">\n                    \x3c!-- import: TPL_rds_security_tab --\x3e\n                </div>\n                <div class="fw-title">\n                    <span class="title va-bottom">防火墙配置</span>\n                    \x3c!-- if: ${instance.instanceType} === \'rdsproxy\'--\x3e\n                    <div class="edit-btn-container fw-edit-ctrl">\n                        <span class="icon va-middle">\n                            <i class="iconfont icon-edit"></i>\n                        </span>\n                        <span class="edit va-bottom" name="edit-btn">编辑</span>\n                    </div>\n                    \x3c!-- /if --\x3e\n                </div>\n                \x3c!-- if: ${instance.instanceType} !== \'rdsproxy\'--\x3e\n                <div class="tip-orange">\n                    \x3c!-- if: ${instance.topology.rdsproxy.length} > 0 --\x3e\n                    ${tips.rdsSecurityFirewalTip[0]}<a\n                        href="#/rds/security/firewall~instanceId=${instance.topology.rdsproxy[0]}">代理实例</a>${tips.rdsSecurityFirewalTip[1]}\n                    \x3c!-- else --\x3e\n                    ${tips.rdsSecurityFirewalTip[0]}<a\n                        href="#/rds/create~instanceId=${instance.instanceId}&type=rdsproxy">代理实例</a>${tips.rdsSecurityFirewalTip[1]}\n                    \x3c!-- /if --\x3e\n                </div>\n                \x3c!-- /if --\x3e\n                \x3c!-- if: ${instance.instanceType} === \'rdsproxy\' --\x3e\n                <div class="fw-status fw-edit-ctrl">\n                    <span class="title">DB防火墙:</span>\n                    <span class="f-status">${dbfirewall.dbfwStatus}</span>\n                </div>\n                \x3c!-- if: ${dbfirewall.dbfwStatus} === \'开启\' --\x3e\n                <div class="fw-status fw-edit-ctrl">\n                    <span class="title">安全模式:</span>\n                    <span class="f-status">${dbfirewall.dbfwRule}</span>\n                    \x3c!-- if: ${dbfirewall.dbfwRule} === \'告警\' --\x3e\n                    <span data-ui-type="Tip"\n                        data-ui-content="${tips.rdsFWRuleTip.alarm}"\n                        class="doc-tip"></span>\n                    \x3c!-- /if --\x3e\n                    \x3c!-- if: ${dbfirewall.dbfwRule} === \'阻断\' --\x3e\n                    <span data-ui-type="Tip"\n                        data-ui-content="${tips.rdsFWRuleTip.block}"\n                        class="doc-tip"></span>\n                    \x3c!-- /if --\x3e\n                </div>\n                \x3c!-- /if --\x3e\n                <div class="fw-edit-container">\n                    <div class="fw-status">\n                        <span class="title">DB防火墙:</span>\n                        <span class="status-edit">\n                            <label>\n                                <input type="radio" class="fwStatusOn" name="fwStatus" value="true">开启\n                            </label>\n                            <label>\n                                <input type="radio" class="fwStatusOff" name="fwStatus" value="false">关闭\n                            </label>\n                        </span>\n                    </div>\n                    <div class="fw-status">\n                        <span class="title">安全模式:</span>\n                        <span class="status-edit">\n                            <label>\n                                <input type="radio" class="fwRuleAlarm" name="fwRule" value="1">告警\n                            </label>\n                            <label>\n                                <input type="radio" class="fwRuleBlock" name="fwRule" value="2">阻断\n                            </label>\n                            <span data-ui-type="Tip"\n                                data-ui-content="${tips.rdsFWEditTip}"\n                                class="doc-tip"></span>\n                        </span>\n                    </div>\n                    <div class="edit-btns">\n                        <button data-ui-type="Button" data-ui-skin="ok" data-ui-id="fwEditSave">保存</button>\n                        <a data-ui-type="Button" data-ui-skin="cancel" data-ui-id="fwEditCancel">取消</a>\n                    </div>\n                </div>\n                <div class="dividing-line"></div>\n                <div class="fw-title">\n                    <span class="title va-bottom">SQL注入详情</span>\n                </div>\n                <div class="detail-content">\n                    <ul class="ui-tab-navigator">\n                        <li class="sql-audit-tab ui-tab-item ui-tab-item-active">\n                            <a class="sqlAuditTab">SQL注入审计</a>\n                        </li>\n                        <li class="sql-whitelist-tab ui-tab-item">\n                            <a class="sqlWhitelistTab">SQL白名单</a>\n                        </li>\n                    </ul>\n                    \x3c!-- if: ${dbfirewall.dbfwStatus} === \'关闭\' --\x3e\n                    <div class="nosql-panel">\n                        <span class="nosql-tip">${tips.rdsFWNoSqlauditTip}</span>\n                    </div>\n                    \x3c!-- /if --\x3e\n                    \x3c!-- if: ${dbfirewall.dbfwStatus} === \'开启\' --\x3e\n                    <div data-ui="id:sqlInjection;type:Panel" class="sql-injection">\n                        \x3c!-- import: TPL_rds_sqlAudit --\x3e\n                    </div>\n                    \x3c!-- /if --\x3e\n                </div>\n                \x3c!-- /if --\x3e\n            </div>\n        </div>\n    </div>\n</div>\n\n\x3c!-- target: TPL_rds_sqlAudit --\x3e\n\x3c!-- if: ${dbfirewall.dbfwStatus} === \'开启\' --\x3e\n<div class="sqlAudit-list">\n    <div class="filter-container">\n        <input data-ui-type="RangeCalendar"\n            data-ui-id="rangeCalendar" data-ui-time="true"\n            data-ui-param-format="YYYYMMDDHHmmss" class="range-calendar"/>\n        <span class="ui-group ui-search-group">\n            <span data-ui-type="SelectEx" data-ui-id="keywordType"\n                  data-ui-value="@keywordType" data-ui-has-child-list="true"></span>\n            <input class="search-box" data-ui-type="TextBox"\n                   data-ui-id="keyword" data-ui-value="@keyword"\n                   data-ui-extension-textbox-type="TextBoxSelect" />\n            <button data-ui-type="Button" data-ui-id="searchBtn"></button>\n        </span>\n    </div>\n    <div class="sql-audit-container">\n        \x3c!-- import: listTableWithCommandAndSubrow --\x3e\n        <div class="ui-row clearfix">\n            \x3c!-- import: listPager --\x3e\n        </div>\n    </div>\n</div>\n\x3c!-- /if --\x3e\n\n\x3c!-- target: TPL_rds_sqlWhitelist --\x3e\n\x3c!-- if: ${dbfirewall.dbfwStatus} === \'开启\' --\x3e\n<div class="sqlWhitelist-list">\n    <div class="sql-audit-container">\n        <div data-ui-type="Table" data-ui-id="sqlWhitelist" data-ui-datasource="@tableData"\n            data-ui-order-by="@orderBy" data-ui-order="@order" data-ui-select="@selectMode"\n            data-ui-extension-tip-type="TableTip"\n            data-ui-extension-command-type="Command">\n        </div>\n        <div class="ui-row clearfix">\n            \x3c!-- import: listPager --\x3e\n        </div>\n    </div>\n</div>\n\x3c!-- /if --\x3e\n'}),define("rds/security/FirewallModel",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","bat-ria/mvc/BaseModel","babel-runtime/helpers/interop-require-default","common/util/timeUtil","../tips","../config","../helper","underscore"],function(exports,module,e,t,n,i,a,r,s,o,c,l){var d=a["default"](i),u=(a["default"](r),a["default"](s)),p=a["default"](c),m=a["default"](l),h=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.prepare=function(){this.set("keywordTypeDatasource",[{name:"数据库",value:"dbName"},{name:"账号",value:"accountName"}]),p["default"].getDelayInfo(this)},a.prototype.saveEdit=function(e,t){return o.api.rdsFWUpdateState({instanceId:this.get("instanceId"),dbfwStatus:e,dbfwRule:t})},a.prototype.getSqlinjectList=function(e){var t={instanceId:this.get("instanceId")};return m["default"].extend(t,e),o.api.rdsSqlinjectList(t)},a.prototype.getSqlWhitelist=function(e){var t={instanceId:this.get("instanceId")};return m["default"].extend(t,e),o.api.rdsSqlWhitelist(t)},a.prototype.getSqlinjectDetail=function(e,t){return o.api.rdsSqlinjectDetail({instanceId:e,sqlId:t})},t["default"](a,[{key:"datasource",get:function(){var e={security:"ui-tab-item-active",firewall:"ui-tab-item-active"};return[{instance:function(e){return o.api.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return p["default"].handlePublicData(e),e})},tab:function(){return e},tips:function(){return{rdsSecurityFirewalTip:u["default"].rdsSecurityFirewalTip.split("代理实例"),rdsFWEditTip:u["default"].rdsFWEditTip,rdsFWRuleTip:{alarm:u["default"].rdsRuleAlarmTip,block:u["default"].rdsRuleBlockTip},rdsFWNoSqlauditTip:u["default"].rdsFWNoSqlauditTip}}},{dbfirewall:function(e){if("rdsproxy"==e.get("instance").instanceType)return o.api.rdsDBFirewall({instanceId:e.get("instanceId")}).then(function(t){var n=t;return e.get,n.dbfwStatus=n.dbfwStatus?"开启":"关闭",n.dbfwRule=2===n.dbfwRule?"阻断":"告警",n})}}]}}]),a}(d["default"]);module.exports=h}),define("rds/security/FirewallView",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","bat-ria/tpl!./firewall.tpl","bat-ria/mvc/BaseView","babel-runtime/helpers/interop-require-default","humanize","common/util/timeUtil","common/util/tableUtil","common/constants","underscore"],function(exports,module,e,t,n,i,a,r,s,o,c,l,d){var u=r["default"](a),p=(r["default"](s),r["default"](o)),m=r["default"](c),h=(r["default"](l),r["default"](d)),g=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.setSubrowContent=function(e,t){e=(e=[{"自增主键：":e.sqlId},{"注入来源端口：":e.userPort},{"拦截时安全级别：":{WARNING:"告警",FORBID:"阻断"}[e.secLevel]},{"注入签名：":e.sqlFingerprint},{"代理实例ID：":e.appId},{"注入来源代理实例端口：":e.dbproxyPort}]).map(function(e){var t="";for(var n in e)t="<tr><td>"+n+"</td><td>"+e[n]+"</td></tr>";return t});var n=this.get("table"),i='\n            <div class="subrow-container">\n                <div class="subrow">\n                    <table>\n                        '+e.slice(0,4).join("")+'\n                    </table>\n                </div>\n                <div class="subrow">\n                    <table>\n                        '+e.slice(4).join("")+"\n                    </table>\n                </div>\n            </div>";n.setSubrowContent(i,t)},a.prototype.updatePageAndTable=function(e){var t=this.get("table")||this.get("sqlWhitelist"),n=this.get("pager");if(params={pageNo:n&&n.page,pageSize:n&&n.pageSize,filters:[]},t){h["default"].extend(params,this.model.get("searchParams")),h["default"].extend(params,e);var i=function(e){t&&t.setDatasource(e.result),n&&n.set("page",e.pageNo),n&&n.set("pageSize",e.pageSize),n&&n.set("count",e.totalCount)};return"table"===t.id?this.model.getSqlinjectList(params).then(i):this.model.getSqlWhitelist(params).then(i)}},t["default"](a,[{key:"template",get:function(){return"TPL_rds_security_firewall"}},{key:"uiProperties",get:function(){var e=[{title:function(){return'<span class="num-title">序号</span>'},width:-50,subEntry:1,content:"sqlId"},{title:"连接IP源",width:-50,content:"userIp"},{title:"账号",width:-60,content:"accountName"},{title:"数据库",width:-50,content:"dbName"},{title:"SQL语句",width:110,content:function(e){return'<span class="sql-fingerprint">'+e.sqlFingerprint+"</span>"}},{title:"发生时间",content:function(e){return p["default"].toTime(e.createTime)}},{title:"操作",content:function(e,t){return'<a data-command="addToWhitelist" data-command-args="'+t+'" style="cursor:pointer;">添加到白名单</a>'}}];return{table:m["default"].tableProperty(e,{datasource:[],select:"",subrow:!0,subrowMutex:0}),keywordType:{datasource:"@keywordTypeDatasource"},rangeCalendar:{range:{end:new Date}},pager:{pageSizes:[10,20,50,100]},sqlWhitelist:m["default"].tableProperty([{title:"ID",width:-200,content:"sqlId"},{title:"SQL签名",width:300,content:function(e){return'<span class="sql-fingerprint">'+e.sqlFingerprint+"</span>"}},{title:"操作",width:-200,content:function(e,t){return'<a data-command="delfromWhitelist" data-command-args="'+t+'" style="cursor:pointer;">删除</a>'}}],{datasource:[],select:""}),whitelistPager:{pageSizes:[10,20,50,100]}}}},{key:"uiEvents",get:function(){return{"fwEditSave:click":function(){this.fire("fwEditSave")},"fwEditCancel:click":function(){this.fire("fwEditCancel")},table:{subrowopen:function(e){this.fire("getSqlinjectDetail",e.index)},command:function(e){this.fire(e.name,{itemIndex:+e.args})}},sqlWhitelist:{command:function(e){this.fire(e.name,{itemIndex:+e.args})}},pager:{pagechange:function(){this.updatePageAndTable()},pagesizechange:function(){this.updatePageAndTable()}},searchBtn:{click:function(e){var t=this.get("rangeCalendar").value.split(","),n=this.get("keywordType").getValue(),i=this.get("keyword").getValue(),a={filters:[]};a.filters.push({keywordType:"startTime",keyword:p["default"].timeToUtc(t[0])},{keywordType:"endTime",keyword:p["default"].timeToUtc(t[1])}),i&&a.filters.push({keywordType:n,keyword:i}),this.model.set("searchParams",a);var r=this.get("pager");1===r.page?this.updatePageAndTable(a):r.set("page",1)}}}}}]),a}(u["default"]);module.exports=g}),define("rds/security/Ssl",["exports","module","babel-runtime/helpers/inherits","babel-runtime/helpers/create-class","babel-runtime/helpers/class-call-check","underscore","babel-runtime/helpers/interop-require-default","bat-ria/mvc/BaseAction","bat-ria/mvc/BaseView","bat-ria/mvc/BaseModel","bat-ria/tpl!./ssl.tpl","moment","common/constants","jquery","../config","../helper"],function(exports,module,e,t,n,i,a,r,s,o,c,l,d,u,p,m){a["default"](i);var h=a["default"](r),g=a["default"](s),f=a["default"](o),b=a["default"](l),v=a["default"](d),y=a["default"](u),x=(a["default"](p),a["default"](m)),w=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),t["default"](a,[{key:"template",get:function(){return"TPL_rds_security_ssl"}},{key:"uiProperties",get:function(){return{sslToggleBtn:{checked:"@sslInfo.sslStatus",disabled:""}}}},{key:"uiEvents",get:function(){return{"downloadCABtn:click":function(){this.fire("downloadCa")},"sslToggleBtn:change":function(){this.fire("sslToggle")}}}}]),a}(g["default"]),T=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.rdsSslSet=function(e){return p.api.rdsSslSet(e)},t["default"](a,[{key:"datasource",get:function(){var e={security:"ui-tab-item-active",ssl:"ui-tab-item-active"};return{instance:function(e){return p.api.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return x["default"].handlePublicData(e),e})},sslInfo:function(e){return p.api.rdsSslGet({instanceId:e.get("instanceId")}).then(function(e){var t=e.sslState;return t.sslStatus="open"===t.sslStatus,t.sslStatus&&(t.startTime=b["default"](t.startTime).format(v["default"].TIME_FORMAT),t.endTime=b["default"](t.endTime).format(v["default"].TIME_FORMAT)),t})},tab:function(){return e}}}}]),a}(f["default"]),I=function(i){function a(){n["default"](this,a),i.apply(this,arguments)}return e["default"](a,i),a.prototype.initBehavior=function(){i.prototype.initBehavior.call(this),this.view.on("downloadCa",this.downloadCa,this),this.view.on("sslToggle",this.sslToggle,this),x["default"].handleDetailPublicEvent(this);var e=this.model.get("instance"),t=this.view.get("sslToggleBtn");t.getValue()?y["default"](".ssl-setting").show():y["default"](".ssl-setting").hide(),"sslModifying"===e.instanceStatus&&t.disable()},a.prototype.sslToggle=function(){var e=this;this.view.get("sslToggleBtn").getValue()?this.model.rdsSslSet({instanceId:this.model.get("instanceId"),sslAccessible:!0}).then(function(){return e.reload()}):this.model.rdsSslSet({instanceId:this.model.get("instanceId"),sslAccessible:!1}).then(function(){return e.reload()})},a.prototype.downloadCa=function(){window.open("/api/rds/ssl/get/ca?instanceId="+this.model.get("instanceId"))},t["default"](a,[{key:"modelType",get:function(){return T}},{key:"viewType",get:function(){return w}}]),a}(h["default"]);module.exports=I}),define("rds/security/ssl.tpl",[],function(){return'\x3c!-- target: TPL_rds_security_ssl --\x3e\n<div class="rds-security-ssl rds-main-wrap main-wrap-new">\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\n    <div class="content-wrap">\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\n            \x3c!-- block: list_link --\x3e\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\n            \x3c!-- else --\x3e#/rds/list"\n            \x3c!-- /if --\x3e\n            \x3c!-- /block --\x3e\n            \x3c!-- block: text_content_wrapper --\x3e SSL\x3c!-- /block --\x3e\n        \x3c!-- /import --\x3e\n\n        \x3c!-- import: TPL_rds_tab --\x3e\n            <div class="ui-tab-content">\n                <div class="ui-smart-tab">\n                    \x3c!-- import: TPL_rds_security_tab --\x3e\n                </div>\n                <div class="detail-parts-table">\n                    <dl class="detail-part-1-col">\n                        <dt>\n                            <h4>SSL设置\n                                <a href="https://cloud.baidu.com/doc/RDS/GettingStarted.html#.E5.BC.80.E5.90.AF.2F.E5.85.B3.E9.97.ADSSL.E5.8A.A0.E5.AF.86"><i class="iconfont icon-information"></i> 帮助文档</a>\n                            </h4>\n                        </dt>\n                        <dd>\n                            <div class="tip-yellow">\n                                开通SSL能增加数据在传输过程中的安全性，但会降低RDS的性能；开通和关闭SSL会重启实例，请谨慎操作\n                            </div>\n                        </dd>\n                        <dd>\n                            <div class="form-row">\n                                <label>SSL安全访问：</label>\n                                <div class="form-value">\n                                    <div data-ui-type="ToggleButton" data-ui-id="sslToggleBtn"></div>\n                                </div>\n                            </div>\n                        </dd>\n                        <dd class="ssl-setting">\n                            <div class="form-row">\n                                <label>受保护地址：</label>\n                                <div class="form-value">\n                                    ${sslInfo.sslAddress}\n                                    <span data-ui-type="Tip" data-ui-content="用户使用域名/外网IP/内网IP连接主实例都会通过SSL链路安全传输数据" data-ui-layer-width="220"></span>\n                                </div>\n                            </div>\n                        </dd>\n                        <dd class="ssl-setting">\n                            <div class="form-row">\n                                <label>证书生效期：</label>\n                                <div class="form-value">\n                                    ${sslInfo.startTime} <span class="tips">（该证书为服务端证书，其有效期至 ${sslInfo.endTime}  ）</span>\n                                </div>\n                            </div>\n                        </dd>\n                        <dd>\n                            <div class="form-row">\n                                <label>CA证书：</label>\n                                <div class="form-value">\n                                    <div data-ui-type="Button" data-ui-id="downloadCABtn">CA证书下载</div><br>\n                                    <p class="tips">点击下载至本地，证书使用详情请点击查看<a href="https://cloud.baidu.com/doc/RDS/GettingStarted.html#.E9.85.8D.E7.BD.AECA.E8.AF.81.E4.B9.A6">帮助文档</a></p>\n                                </div>\n                            </div>\n                        </dd>\n\n                    </dl>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n'}),define("rds/Settimepoint",["require","bat-ria/mvc/BaseAction","moment","./config","./SettimepointModel","./SettimepointView","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseAction"),n=require("moment"),i=require("./config").api;return e.prototype.initBehavior=function(){t.prototype.initBehavior.apply(this,arguments);var e=this.model.get("backupPolicy"),i=n("2014-02-03T"+e.backupTime).format("HH:mm:ss");this.view.get("weekdays").setValue(e.backupDays),this.view.get("startTime").setValue(i),this.model.get("isEnhanced")&&this.view.get("expireInDays").setProperties({custom:function(e){return+e>=7&&+e<=3660},customErrorMessage:"保留天数范围7~3660（天）",placeholder:"7~3660"})},e.prototype.modelType=require("./SettimepointModel"),e.prototype.viewType=require("./SettimepointView"),e.prototype.submit=function(e){var t=this.view.get("form");if(t.validate()){var a=t.getData(),r=n.utc("2014-02-03 "+a["time-input"]+"+08:00").format("HH:mm:ss")+"Z",s={backupDays:a.weekdays.join(","),backupTime:r,persistent:this.view.get("enableStorage").checked,expireInDays:this.view.get("expireInDays").getValue()?+this.view.get("expireInDays").getValue():null},o={instanceId:this.model.get("instanceId"),backupPolicy:s};i.rdsBackupSetting(o).then(e)}},require("er/util").inherits(e,t),e}),define("rds/settimepoint.tpl",[],function(){return'\x3c!-- target: TPL_rds_settimepoint --\x3e\r\n<div class="rds-settimepoint">\r\n    <form class="settimepoint-form"\r\n                data-ui-type="Form"\r\n                data-ui-id="form">\r\n        <div class="form-row">\r\n            <label>备份保留时长：</label>\r\n            <div class="times">\r\n                <input  data-ui-type="TextBox"\r\n                        data-ui-id="expireInDays"\r\n                        data-ui-child-name="time-input"\r\n                        data-ui-name="expire-input"\r\n                        data-ui-mode="text"\r\n                        data-ui-width="60"\r\n                        class="time-input"\r\n                        placeholder="7~730" />天\r\n                <label> <input type="checkbox" data-ui-type="CheckBox" data-ui-id="enableStorage" />允许备份存储超过免费赠送空间</label>\r\n                <span data-ui-type="Tip" data-ui-content="${tips.rdsAutoBackupTip}" class="readonly-tip" ></span>\r\n                <br>\r\n                <label data-ui-type="Validity" data-ui-id="expireInDaysValidity" class="account-name-validity"></label>\r\n            </div>\r\n        </div>\r\n        <div class="form-row">\r\n            <label>自动备份周期：</label>\r\n            <div data-ui-type="BoxGroup" data-ui-id="weekdays"\r\n                            data-ui-name="weekdays" data-ui-box-type="checkbox" class="weekdays">\r\n                <ul>\r\n                    <li>\r\n                        <input type="checkbox" id="weekdays-Monday" name="weekdays" value="1" />\r\n                        <label for="weekdays-Monday">星期一</label>\r\n                    </li>\r\n                    <li>\r\n                        <input type="checkbox" id="weekdays-Tuesday" name="weekdays" value="2" />\r\n                        <label for="weekdays-Tuesday">星期二</label>\r\n                    </li>\r\n                    <li>\r\n                        <input type="checkbox" id="weekdays-Wednesday" name="weekdays" value="3" />\r\n                        <label for="weekdays-Wednesday">星期三</label>\r\n                    </li>\r\n                    <li>\r\n                        <input type="checkbox" id="weekdays-Thursday" name="weekdays" value="4" />\r\n                        <label for="weekdays-Thursday">星期四</label>\r\n                    </li>\r\n                    <li>\r\n                        <input type="checkbox" id="weekdays-Friday" name="weekdays" value="5" />\r\n                        <label for="weekdays-Friday">星期五</label>\r\n                    </li>\r\n                    <li>\r\n                        <input type="checkbox" id="weekdays-Saturday" name="weekdays" value="6" />\r\n                        <label for="weekdays-Saturday">星期六</label>\r\n                    </li>\r\n                    <li>\r\n                        <input type="checkbox" id="weekdays-Sunday" name="weekdays" value="0" />\r\n                        <label for="weekdays-Sunday">星期日</label>\r\n                    </li>\r\n                </ul>\r\n            </div>\r\n        </div>\r\n        <p class="validity-container"><label data-ui-type="Validity"\r\n                data-ui-id="weekdayInputValidity"\r\n                class="weekday-input-validity"></label></p>\r\n\r\n        <div class="form-row">\r\n            <label>开始备份时间：</label>\r\n            <div class="hours">\r\n                <input  data-ui-type="TextBox"\r\n                        data-ui-id="startTime"\r\n                        data-ui-child-name="time-input"\r\n                        data-ui-name="time-input"\r\n                        data-ui-mode="text"\r\n                        class="time-input"\r\n                        value="00:00:00" />\r\n\r\n                <label data-ui-type="Validity"\r\n                data-ui-id="startTimeInputValidity"\r\n                class="time-input-validity"></label>\r\n            </div>\r\n        </div>\r\n        <div class="tip-yellow">\r\n            \x3c!-- if: ${isEnhanced} --\x3e\r\n            注：RDS赠送您200%*本地磁盘空间大小的备份存储空间，超过该大小的备份存储将会额外计费，详情请参考\r\n            \x3c!-- else --\x3e\r\n            注：RDS赠送您100%*本地磁盘空间大小的备份存储空间，超过该大小的备份存储将会额外计费，详情请参考\r\n            \x3c!-- /if --\x3e\r\n            <a target="_blank" href="https://cloud.baidu.com/doc/RDS/Pricing.html#.E5.A4.87.E4.BB.BD.E5.AD.98.E5.82.A8.E4.BB.B7.E6.A0.BC">备份存储计费</a>。\r\n        </div>\r\n    </form>\r\n</div>\r\n\x3c!-- target: TPL_rds_settimepoint_child --\x3e\r\n\x3c!-- import: TPL_rds_settimepoint --\x3e\r\n'}),define("rds/SettimepointModel",["require","bat-ria/mvc/BaseModel","./tips","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("./tips");return e.prototype.datasource={tips:function(){return n}},e.prototype.prepare=function(){var e=this.get("backupPolicy");this.set("disableStorage",!e.persistent),0===e.expireInDays&&(e.expireInDays="")},require("er/util").inherits(e,t),e}),define("rds/SettimepointView",["require","bat-ria/tpl!./settimepoint.tpl","bat-ria/mvc/BaseView","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./settimepoint.tpl");var t=require("bat-ria/mvc/BaseView");return e.prototype.template="TPL_rds_settimepoint",e.prototype.uiProperties={weekdays:{required:"required",requiredErrorMessage:"备份周期必选",validityLabel:"weekdayInputValidity"},startTime:{width:60,maxLength:8,required:"required",requiredErrorMessage:"开始时间必填",pattern:"^([0-1][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$",patternErrorMessage:"开始时间格式错误",validityLabel:"startTimeInputValidity"},enableStorage:{checked:"@backupPolicy.persistent"},expireInDays:{required:"required",requiredErrorMessage:"请填写保留天数",custom:function(e){return+e>=7&&+e<=730},customErrorMessage:"保留天数范围7~730（天）",value:"@backupPolicy.expireInDays",disabled:"@disableStorage",validityLabel:"expireInDaysValidity"}},e.prototype.uiEvents={"enableStorage:change":function(){var e=this.get("enableStorage").checked,t=this.get("expireInDays"),n=this.get("expireInDaysValidity");e?(t.enable(),t.validate()):(t.disable(),n.hide())}},require("er/util").inherits(e,t),e}),define("rds/startup",["exports","bat-ria/tpl!./common.tpl","./recharge/config","./whitelist/config","./binlog/config","./backup/config","./database/config","./account/config","./argument/config","./migration/config","./log/config","./security/config","./cluster/config","./dcc/config","./config","babel-runtime/helpers/interop-require-default","common/startup"],function(exports,e,t,n,i,a,r,s,o,c,l,d,u,p,m,h,g){exports.__esModule=!0;var f=h["default"](m),b=h["default"](g);exports.start=function(){return b["default"].start(f["default"])};exports.initialize=function(){return b["default"].initialize(f["default"])}}),define("rds/tips",["require"],function(require){return{mysqlUsedSpaceTip:"RDS实例已用磁盘空间包括共享表空间、数据量",pgUsedSpaceTip:"RDS实例已用磁盘空间包括数据量",sqlserverUsedSpaceTip:"RDS实例已用磁盘空间包括数据量，事务日志，临时表空间",domain:"同账户下可以直接以RDS的域名在BCC上对RDS进行访问",floatTip:{backup:"默认会保存7天内的备份数据",binlog:"binlog数据占用磁盘空间，本地默认保留7天的binlog",slowlog:"为您提供至少7天的日志数据，每2个小时生成一次",enhancedBinlog:'最新binlog数据占用磁盘空间，默认保留60天的binlog, 如需下载日志文件或恢复数据请<a target="_blank" href="https://ticket.bce.baidu.com/#/ticket/create">提交工单</a>',enhancedSlowlog:"为您提供至少60天的日志数据，每2个小时生成一次"},readOnlyInstanceTip:"RDS只读实例面向对数据库有大量读请求而非大量写请求的读写场景，通过为标准实例创建多个只读实例，赋予标准实例弹性的读能力扩展，从而增加用户的吞吐量。RDS只读实例从属于RDS标准实例，二者是主从关系，创建只读实例前须先创建好标准实例。同理，标准实例释放时，其从属的只读实例会被自动释放。",rdsproxyInstanceTip:"RDS代理实例可将数据库请求按读写类型，自动分摊到其对应的标准实例和只读实例，实现读写自动分离。每个RDS标准实例仅能创建一个代理实例，创建代理实例前须先创建好标准实例。同理，标准实例释放时，其对应的代理实例会被自动释放。",rdsproxyConfigTip:"规格建议说明：<br>2节点（主实例内存1G-2G)<br>4节点（主实例内存4G-8G)<br>6节点（主实例内存16G-24G)<br>8节点（主实例内存32G-64G)<br>16节点（主实例内存96G-256G)<br>",saleTip:{12:"注：购买1年8.3折",24:"注：购买2年7折",36:"注：购买3年5折"},rdsAZoneTip:'选择"默认分配"，系统将根据当前资源情况自动分配到某一可用区；选择单可用区时，RDS默认主备节点及只读节点均将在该可用区创建；选择多可用区时，主备节点将分布在不同可用区，只读节点将在多可用区间随机分配。<a href="https://cloud.baidu.com/doc/Reference/Regions.html#.E5.8F.AF.E7.94.A8.E5.8C.BA" target="_blank">了解详情</a>',rdsSubnetTip:"默认私有网络：IP地址由百度云统一默认分配；<br>用户自定义网络：用户创建的虚拟私有网络。",rdsAutoBackupTip:"默认只使用免费赠送空间存储数据库自动备份文件，超过免费空间将自动删除旧备份，不产生任何备份存储计费；您可以通过允许备份存储超过免费赠送空间来设置指定备份保留时长，若超过免费空间部分将产生存储计费。",rdsPgBackupTip:'RDS for PostgreSQL当前仍只保留7天备份，自定义备份策略功能会尽快支持，如有特殊需求可<a target="_blank" href="https://ticket.bce.baidu.com/">工单</a>联系我们，谢谢！',rdsPrepayToPostpayTip:"该实例已开通计费变更-预付费转后付费，到期后会自动转为后付费资源，请关注！<br>如需进行续费、升配等操作，请先取消计费变更，谢谢！",rdsSecurityFirewalTip:"DB防火墙可以增加防SQL注入能力，请前往代理实例管理DB防火功能",rdsFWEditTip:"告警：注入SQL将被记录并放行<br>阻断：注入SQL将被记录并拦截<br>请前往SQL注入详情里面查看审计记录",rdsRuleAlarmTip:"注入SQL将被记录并放行，可切换为阻断",rdsRuleBlockTip:"注入SQL将被记录并拦截，可切换为告警",rdsFWNoSqlauditTip:"防火墙未开启，故无SQL注入审计数据",packageTip:'可选规格为当前可用区资源<br>小微型：轻便灵活，价格优惠；<br>标准型：通用规格，高性价比；<br>内存增强型：高内存配置，适用大数据量读写；<br>CPU增强型：高CPU配置，适用高逻辑运算并发读写；<br><a target="_blank" href="https://cloud.baidu.com/doc/RDS/ProductDescription.html#.E4.BA.A7.E5.93.81.E7.B3.BB.E5.88.97">>>了解更多系列及规格</a>',rdsReplicaSwitchTip:"默认开启。开启时该只读实例承接由代理实例分发的读业务流量；关闭时该只读实例不承接任何业务流量。",rdsTopologyTips:'请前往<a id="goto-cluster-link" href="javascript:;">集群管理</a>页面查看详细只读实例信息及设置流量开关'}}),define("rds/UpdateConfiguration",["require","bat-ria/mvc/BaseAction","underscore","moment","common/region","common/constants","common/util/orderUtil","./config","./UpdateConfigurationModel","./UpdateConfigurationView","er/util"],function(require){function e(){var e=this.getQueryData(),t=function(e){var t=this.model.get("instance"),n=t.engine,l=n,d=t.engineVersion;c.ENGINE_INFO[n]&&(l=c.ENGINE_INFO[n].name,i.each(c.ENGINE_INFO[n].version,function(e){e.value===t.engineVersion&&(d=e.name)}));var u=l+"("+d+")",p=this.model.get("price"),m=t.instanceExpireTime?a(t.instanceExpireTime).diff(a(t.timestamp),"days"):"-",h="￥"+p.price+("prepay"===t.productType?"/台":"/分钟"),g="rdsproxy"===t.instanceType?"RDS_PROXY":"RDS",f=["地域："+r.getCurrentRegion().label,"数据库版本："+u];if("rdsproxy"===t.instanceType)f.push("资源规格："+c.NODE_MAP[e.nodeAmount]);else{var b=c.MEMORY_MAP[e.allocatedMemoryInGB]||e.allocatedMemoryInG+"GB";f=f.concat(["CPU："+e.cpuCount+"核","内存："+b,"存储磁盘："+e.allocatedStorageInGB+"GB"])}return o.make({serviceType:"RDS",productType:t.productType,type:"RESIZE",instanceId:t.instanceId,price:p.price,items:[{instanceId:t.instanceId,serviceType:g,productType:t.productType,count:1,price:p.price,time:m,timeUnit:"DAY",unitPrice:p.price,unitPriceShow:h,chargeType:s.SERVICE_TYPE.RDS.chargeType[t.productType],configuration:f}]})}.call(this,e);this.view.renderOrderConfirm(t,e)}function t(){n.apply(this,arguments)}var n=require("bat-ria/mvc/BaseAction"),i=require("underscore"),a=require("moment"),r=require("common/region"),s=require("common/constants"),o=require("common/util/orderUtil"),c=require("./config");return t.prototype.getQueryData=function(){var e=this.view,t=this.model.get("instance"),n={instanceId:t.instanceId,productType:t.productType,isEnhanced:"enhanced"===this.model.get("instance").applicationType};if("rdsproxy"===t.instanceType)i.extend(n,{nodeAmount:e.get("nodeAmount").getValue()});else{var a=e.get("packageSelect").getValue(),r=c.PACKAGE_MAP[a].memory,s=c.PACKAGE_MAP[a].cpu,o=!i.contains(c.ENGINE_INFO[t.engine].availablePackage,a);i.extend(n,{cpuCount:s,allocatedMemoryInGB:r,allocatedStorageInGB:e.get("allocatedStorageInGB").getRawValue()}),o&&i.extend(n,{oldFlavor:o,allocatedMemoryInMB:parseInt(1024*n.allocatedMemoryInGB,10)})}return n},t.prototype.initBehavior=function(){n.prototype.initBehavior.apply(this,arguments);var t=this;this.view.on("pickChange",this.getPriceEventHandler,this),this.view.on("packageChange",this.packageChange,this),this.view.on("pick",e,this),this.view.on("refresh",this.reload,this),this.model.checkBilling(this.model.get("instance").productType).then(function(e){if(t.model.set("purchaseValidation",e.status),e.status)t.getPriceEventHandler();else{t.getPriceEventHandler();var n=t.view.get("warningPanel");n.setContent(e.failReason+' <a href="/billing/#/account/recharge">立即充值</a>'),n.show()}})},t.prototype.packageChange=function(){var e=this.model.get("instance"),t=this.model.get("sourceInstance"),n=this.view.get("packageSelect").getValue(),a=c.PACKAGE_MAP[n],r=e.azone,s=this.model.get("zonePackageLimit")[r].maxStorage,o=a?a.maxStorage:1e3,l=i.min([o,s]),d=this.view.get("allocatedStorageInGB").getRawValue();d=i.min([d,l]);var u=e.allocatedStorageInGB;t&&(u=i.max([u,t.allocatedStorageInGB])),l=i.max([u,l]),this.view.get("allocatedStorageInGB").setProperties({max:l}),this.view.get("allocatedStorageInGB").setValue(d),this.getPriceEventHandler()},t.prototype.modelType=require("./UpdateConfigurationModel"),t.prototype.viewType=require("./UpdateConfigurationView"),t.prototype.getPriceEventHandler=function(){var e=this.view,t=this.model.get("instance"),n=t.productType,i=this.model.get("instanceId");if("rdsproxy"===t.instanceType){var a=e.get("nodeAmount").getValue();this.model.getPrice({instanceId:i,productType:n,nodeAmount:a}).then(function(t){e.showPrice(t,n)})}else{var r=e.get("packageSelect").getValue(),s=c.PACKAGE_MAP[r].memory,o=c.PACKAGE_MAP[r].cpu,l=e.get("allocatedStorageInGB").getRawValue(),d="";d="MySQL"===t.engine?"最大连接数："+c.ENGINE_INFO.MySQL.memoryInfo[s].maxLink:"postgresql"===t.engine?"最大链接数：1000":"最大连接数：不限",e.get("memoryTip").setText(d),this.model.getPrice({instanceId:i,cpuCount:o,allocatedMemoryInGB:s,allocatedStorageInGB:l,productType:n,isEnhanced:"enhanced"===this.model.get("instance").applicationType}).then(function(t){e.showPrice(t,n)})}},require("er/util").inherits(t,n),t}),define("rds/updateConfiguration.tpl",[],function(){return'\x3c!-- target: TPL_rds_update_configuretion --\x3e\r\n<div class="rds-update-configuretion rds-main-wrap main-wrap-new">\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e变更配置\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n        <div class="create-content">\r\n            <div data-ui-type="ViewStep"\r\n                    data-ui-id="buyStep"\r\n                    data-ui-current-step="1">\r\n                <ul>\r\n                    <li bind-for="tab1">变更配置</li>\r\n                    <li bind-for="tab2">确认</li>\r\n                    <li >变更成功</li>\r\n                </ul>\r\n            </div>\r\n            <div class="ui-tab-navigator">\r\n                <h1>变更配置</h1>\r\n            </div>\r\n            <div id="tab1" class="ui-tab-content create-main">\r\n                <p data-ui-type="ToastLabel"\r\n                    data-ui-id="warningPanel"\r\n                    data-ui-message-type="alert"\r\n                    data-ui-hidden="true"\r\n                    class="warning-panel">\r\n\r\n                </p>\r\n                <p class="tip-yellow upgrade-tips">\r\n                    请选择业务流量较低的时间变更配置，并避免在变更配置期间大规模导入数据，否则可能导致数据库长时间停写！\r\n                </p>\r\n                <div class="detail-parts-table">\r\n                    <dl class="detail-part-1-col">\r\n                        <dt>\r\n                            <h4>当前配置</h4>\r\n                        </dt>\r\n                        <dd>\r\n                            <div class="detail-cell">\r\n                                <label>实例名称：</label>\r\n                                <span title="${instance.instanceName}">${instance.instanceName}</span>\r\n                            </div>\r\n                            <div class="detail-cell">\r\n                                <label>端口：</label>\r\n                                <span>${instance.endpoint.port}</span>\r\n                            </div>\r\n                        </dd>\r\n                        <dd>\r\n                            <div class="detail-cell">\r\n                                <label>创建时间：</label>\r\n                                <span>${instance.instanceCreateTime}</span>\r\n                            </div>\r\n                            <div class="detail-cell">\r\n                                <label>实例ID：</label>\r\n                                <span>${instance.instanceShortId}</span>\r\n                            </div>\r\n                        </dd>\r\n                        <dd>\r\n                            <div class="detail-cell">\r\n                                <label>CPU：</label>\r\n                                <span>${instance.cpuCount} 核</span>\r\n                            </div>\r\n                            <div class="detail-cell">\r\n                                <label>内存：</label>\r\n                                <span>${instance.allocatedMemoryText}</span>\r\n                            </div>\r\n                        </dd>\r\n                        <dd>\r\n                            <div class="detail-cell">\r\n                                <label>存储空间：</label>\r\n                                <span>${instance.allocatedStorageInGB}GB</span>\r\n                            </div>\r\n                            \x3c!-- if: ${instance.productType} == \'prepay\' --\x3e\r\n                            <div class="detail-cell">\r\n                                <label>到期时间：</label>\r\n                                <span>${instance.instanceExpireTime}</span>\r\n                            </div>\r\n                            \x3c!-- /if --\x3e\r\n                        </dd>\r\n                        <dd>\r\n                            <div class="detail-cell">\r\n                                <label>域名：</label>\r\n                                <span title="${instance.endpoint.address}">\r\n                                    ${instance.endpoint.address}\r\n                                </span>\r\n                            </div>\r\n                        </dd>\r\n                    </dl>\r\n                    <dl class="update-configuration detail-part-1-col detail-create">\r\n                        <dt>\r\n                            <h4>变更配置</h4>\r\n                        </dt>\r\n                        \x3c!-- if: ${instance.instanceType} === \'rdsproxy\' --\x3e\r\n                        <dd>\r\n                            <label>资源规格：</label>\r\n                            <div class="form-value">\r\n                                <span data-ui-type="Select"\r\n                                    data-ui-id="nodeAmount"\r\n                                    data-ui-name="nodeAmount"></span>\r\n                                    \x3c!-- <div data-ui-type="Tip" data-ui-content="${tips.rdsproxyConfigTip}" class="config-tip ui-radioselect-custom" ></div> --\x3e\r\n                                    \x3c!-- <span class="tps-tips">参考QPS：<span class="qps-num">5000</span> </span> --\x3e\r\n                            </div>\r\n                        </dd>\r\n                        \x3c!-- else --\x3e\r\n                        <dd>\r\n                            <p class="tip-yellow inline-block">\r\n                                因可用区资源动态变化，可选规格为该可用区当前支持的规格\r\n                            </p>\r\n                        </dd>\r\n                        <dd>\r\n                            <label>规格：</label>\r\n                            <div class="form-value">\r\n                                <span\r\n                                    data-ui-type="Select"\r\n                                    data-ui-id="packageSelect"\r\n                                    data-ui-width="200"\r\n                                    data-ui-selected-index="0">\r\n                                </span>\r\n                                <span data-ui-type="Tip"\r\n                                    data-ui-id="packageTip"\r\n                                    data-ui-content="${tips.packageTip}"\r\n                                    data-ui-layer-width="320"\r\n                                    data-ui-skin="normal" class="package-tip"></span>\r\n                                <label data-ui="id:memoryTip;type:Label" class="memory-tip">最大连接数:1000</label><br>\r\n                            </div>\r\n                        </dd>\r\n                        <dd>\r\n                            <label>存储磁盘：</label>\r\n                            <div class="form-value">\r\n                                <div data-ui-id="allocatedStorageInGB"\r\n                                    data-ui-type="Dragger"></div><br>\r\n                                <p class="row-tip">\r\n                                    磁盘大小必须为5的倍数\r\n                                </p>\r\n                            </div>\r\n                        </dd>\r\n                        \x3c!-- /if --\x3e\r\n                    </dl>\r\n                </div>\r\n                <div data-ui-id="buyBucket" data-ui-type="BuyBucket"></div>\r\n            </div>\r\n            <div id="tab2" class="ui-tab-content clearfix">\r\n                <div data-ui="id:orderAction;type:ActionPanel"></div>\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n</div>\r\n'}),define("rds/UpdateConfigurationModel",["require","bat-ria/mvc/BaseModel","underscore","common/util/timeUtil","./tips","./config","./helper","common/region","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("underscore"),i=require("common/util/timeUtil"),a=require("./tips"),r=require("./config"),s=require("./helper"),o=(require("common/region"),r.api);return e.prototype.datasource=[{instance:function(e){return o.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return e.instanceShortId=e.instanceShortId||e.instanceId,e.instanceCreateTime=i.toTime(e.instanceCreateTime),e.instanceExpireTime=e.instanceExpireTime?i.toTime(e.instanceExpireTime):e.instanceExpireTime,e.allocatedMemoryText=e.allocatedMemoryInGB<1?parseInt(1024*e.allocatedMemoryInGB,10)+"MB":e.allocatedMemoryInGB+"GB",e})},purchaseValidation:function(){return!1},tips:function(){return a},zoneDatasource:function(e){return o.rdsZoneList().then(function(t){var i=t.zones||[],a={};return n.each(i,function(e){var t=e.zoneNames.join(",");a[t]=e}),e.set("zonePackageLimit",a),i})}},{sourceInstance:function(e){return e.get("instance").sourceInstanceId?o.rdsInstanceDetail({instanceId:e.get("instance").sourceInstanceId}):null}}],e.prototype.checkBilling=function(e){return o.getRdsPurchaseValidation({serviceType:"RDS",productType:e})},e.prototype.prepare=function(){var e=this.get("sourceInstance"),t=this.get("instance"),i=t.azone,a=this.get("zonePackageLimit"),o=a[i].maxStorage,c=t.engine,l=r.ENGINE_INFO[c],d=t.allocatedStorageInGB,u=r.PACKAGE_MAP,p="C"+t.cpuCount+"M"+t.allocatedMemoryInGB,m=u[p],h=m?m.maxStorage:1e3;if(h=n.min([o,h]),"rdsproxy"===t.instanceType){var g=[],f="2";if(g=n.map(r.NODE_MAP,function(e,t){return{value:t,name:e}}),t.nodeAmount)f=t.nodeAmount;else{var b=t.allocatedMemoryInGB;b<=2?f="2":b<=8?f="4":b<=24?f="6":b<=64?f="8":b>64&&(f="16")}this.set("proxyNodes",g),this.set("defaultProxyNode",f)}else{var v=n.clone(l.availablePackage),y=n.clone(l.enhancedPackage),x=[],w=[];if(!n.contains(v,p)){var T="上一代 "+t.cpuCount+"核"+(t.allocatedMemoryInGB<1?parseInt(1024*t.allocatedMemoryInGB,10)+"M":t.allocatedMemoryInGB+"G");x.push({name:T,value:p})}n.each(v,function(e){if(s.isFinancialRegion()&&"financial"===t.instanceType&&y.indexOf(e)<0)return!1;var n=r.PACKAGE_MAP[e];n.cpu>=t.cpuCount&&n.memory>=t.allocatedMemoryInGB?x.push({name:n.type+" "+n.cpu+"核"+n.memory+"G",value:e}):"postpay"===t.productType&&n.maxStorage>d&&"sqlserver"!==t.engine&&w.push({name:n.type+" "+n.cpu+"核"+n.memory+"G",value:e})}),x=x.concat(w),x=n.filter(x,function(e){var t=r.PACKAGE_MAP[e.value];return!!t&&(t.cpu<=a[i].maxCpuCount&&t.memory<=a[i].maxMemory)}),this.set("defaultPackages",x),this.set("originPackage",p);var I=t.allocatedStorageInGB;e&&(I=n.max([I,e.allocatedStorageInGB])),h=n.max([I,h]),this.set("defaultStorage",{min:I,max:h})}},e.prototype.getPrice=function(e){var t=this,i="C"+e.cpuCount+"M"+e.allocatedMemoryInGB,a=this.get("instance"),s=!n.contains(r.ENGINE_INFO[a.engine].availablePackage,i);if("prepay"===e.productType)return s&&(n.extend(e,{oldFlavor:s,allocatedMemoryInMB:parseInt(1024*e.allocatedMemoryInGB,10)}),delete e.allocatedMemoryInGB),o.rdsGetPriceDifference(e).then(function(e){return t.set("price",e),e});var c={engine:"rdsproxy"===a.instanceType?"rdsproxy":a.engine,engineVersion:a.engineVersion,location:a.location,isEnhanced:"enhanced"===this.get("instance").applicationType,instanceId:this.get("instanceId")};"rdsproxy"===a.instanceType?n.extend(c,{nodeAmount:e.nodeAmount}):(n.extend(c,{cpuCount:e.cpuCount,allocatedStorageInGB:e.allocatedStorageInGB}),s?n.extend(c,{allocatedMemoryInMB:parseInt(1024*e.allocatedMemoryInGB,10),oldFlavor:s}):n.extend(c,{allocatedMemoryInGB:e.allocatedMemoryInGB}));var l={instance:c,number:1,productType:e.productType};return"readReplica"===a.instanceType&&n.extend(l.instance,{sourceInstanceId:a.sourceInstanceId}),o.rdsGetPrice(l).then(function(e){return t.set("price",e),e})},require("er/util").inherits(e,t),e}),define("rds/UpdateConfigurationView",["require","bat-ria/tpl!./updateConfiguration.tpl","underscore","inf-ria/app/brpc","bat-ria/mvc/BaseView","common/util/moneyUtil","./config","er/util"],function(require){function e(){i.apply(this,arguments)}require("bat-ria/tpl!./updateConfiguration.tpl");var t=require("underscore"),n=require("inf-ria/app/brpc"),i=require("bat-ria/mvc/BaseView"),a=require("common/util/moneyUtil"),r=require("./config");e.prototype.template="TPL_rds_update_configuretion";var s=[{title:"更改配置:",content:function(e){if(e.nodeAmount)return"资源规格 "+r.NODE_MAP[e.nodeAmount];var t=r.MEMORY_MAP[e.allocatedMemoryInGB]||(e.allocatedMemoryInG||"-")+"GB";return"CPU"+(e.cpuCount||"-")+"核、内存"+(t||"-")+"、存储磁盘"+(e.allocatedStorageInGB||"-")+"GB"}},{title:"价格:",content:function(e){var t=a.convertPrice(e.price);return'<span class="price" >￥'+("prepay"===e.productType?t.getPriceOfMinute():t.getPriceOfMinute("/分钟"))+"</span>"}},{title:"公网流量费:",content:function(e){return'<span class="price" >￥'+a.convertPrice(e.trafficInGB).getPriceOfMinute("/GB")+"</span>"}}];return e.prototype.uiProperties={packageSelect:{datasource:"@defaultPackages",value:"@originPackage",width:170,height:30},allocatedStorageInGB:{max:"@defaultStorage.max",min:"@defaultStorage.min",step:5,length:349,unit:"GB"},buyBucket:{fields:s,value:{},offsetTop:20,confirmBtn:{text:"下一步",skin:"skin-primary-button"},disabled:!0},nodeAmount:{datasource:"@proxyNodes",value:"@defaultProxyNode"}},e.prototype.renderOrderConfirm=function(e,t){var i=this.get("orderAction"),a=this.get("buyStep"),r={order:e,config:t};n.invokeService("billing://order_confirm",i,r).then(function(){a.set("currentStep",2)})},e.prototype.renderRdsConfig=function(){var e=this.get("orderAction");this.get("buyStep").set("currentStep",1),e.disposeAction()},e.prototype.uiEvents={"packageSelect:change":function(e){this.fire("packageChange")},"allocatedStorageInGB:change":function(){this.fire("pickChange")},"buyBucket:confirm":function(){this.fire("pick")},"buyBucket:reset":function(e){this.fire("refresh"),e.preventDefault()},"orderAction:action@prevPage":function(){this.renderRdsConfig()},"nodeAmount:change":function(){this.fire("pickChange")}},e.prototype.showPrice=function(e,n){var i=this.model.get("instance"),a=this.get("buyBucket");if("rdsproxy"===i.instanceType){var s=this.get("nodeAmount").getValue();!this.model.get("purchaseValidation")||+s===i.nodeAmount&&0===i.oldInstance?a.disable():a.enable(),a.setValue(t.extend({productType:n,nodeAmount:s},e))}else{var o=this.get("packageSelect").getValue(),c=r.PACKAGE_MAP[o].memory,l=r.PACKAGE_MAP[o].cpu,d=this.get("allocatedStorageInGB").getValue();parseFloat(c)===+i.allocatedMemoryInGB&&l===i.cpuCount&&parseFloat(this.get("allocatedStorageInGB").getValue())===i.allocatedStorageInGB||!this.model.get("purchaseValidation")?a.disable():a.enable(),a.setValue(t.extend({productType:n,cpuCount:l,allocatedStorageInGB:d,allocatedMemoryInGB:c},e))}},require("er/util").inherits(e,i),e}),define("rds/util",[],function(){return{encodeHTML:function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")},decodeHTML:function(e){return String(e).replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&#([\d]+);/g,function(e,t){return String.fromCharCode(parseInt(t,10))})}}}),define("rds/whitelist/config",["require","er/controller"],function(require){require("er/controller").registerAction([{type:"rds/whitelist/Edit",path:"/rds/whitelist/edit"},{type:"rds/whitelist/List",path:"/rds/whitelist/list"}]);return{}}),define("rds/whitelist/Edit",["require","bat-ria/mvc/BaseAction","../config","underscore","./EditModel","./EditView","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseAction"),n=require("../config").api,i=require("underscore");return e.prototype.modelType=require("./EditModel"),e.prototype.viewType=require("./EditView"),e.prototype.submit=function(e){var t=this.view.get("ipTextarea"),a=t.getValue();if(""!==i.trim(a)){for(var r=new RegExp("(^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(/(\\d|[1-2]\\d|3[0-2]))?$)|(^%$)"),s=[],o=a.replace(/\s+/g,",").replace(/\n+/g,",").replace(/,+/g,",").replace(/(^,|,$)/g,"").split(","),c=0;c<o.length;c++)r.test(o[c])||s.push(o[c]);if(s.length>0)t.showValidationMessage("invalid","以下ip不符合规则："+s.join("，"));else{var l=this.model.get("whitelist").concat(o);n.rdsSetWhitelist({instanceId:this.model.get("instanceId"),ETag:this.model.get("ETag"),securityIps:l}).then(e).fail(function(e){t.showValidationMessage("invalid",e.field.securityIps)})}}else t.showValidationMessage("invalid","请填写IP")},require("er/util").inherits(e,t),e}),define("rds/whitelist/edit.tpl",[],function(){return'\x3c!-- target: TPL_rds_whitelist_edit --\x3e\r\n<div class="rds-whitelist-edit">\r\n    <p class="tips">以英文逗号或者空格分割，%代表所有IP，支持CIDR模式（如10.10.0.0/16）。</p>\r\n    <div class="ip-container">\r\n        <textarea data-ui-id="ipTextarea"\r\n                  data-ui-type="TextBox"\r\n                  data-ui-mode="textarea"\r\n                  class="ip-textarea"></textarea>\r\n        <p>\r\n            <label data-ui-type="Validity"\r\n                data-ui-id="ipValidity"\r\n                class="ip-validity"></label>\r\n        </p>\r\n    </div>\r\n</div>\r\n\x3c!-- target: TPL_rds_whitelist_edit_child --\x3e\r\n\x3c!-- import: TPL_rds_whitelist_edit --\x3e\r\n'}),define("rds/whitelist/EditModel",["require","bat-ria/mvc/BaseModel","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel");return e.prototype.datasource={instance:function(e){return{instanceId:e.get("instanceId")}},whitelist:function(e){return e.get("whitelistInArray")}},require("er/util").inherits(e,t),e}),define("rds/whitelist/EditView",["require","bat-ria/tpl!./edit.tpl","bat-ria/mvc/BaseView","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./edit.tpl");var t=require("bat-ria/mvc/BaseView");return e.prototype.template="TPL_rds_whitelist_edit",e.prototype.uiProperties={ipTextarea:{width:400,validityLabel:"ipValidity"}},e.prototype.uiEvents={},require("er/util").inherits(e,t),e}),define("rds/whitelist/List",["require","bat-ria/mvc/BaseAction","er/util","underscore","jquery","../config","../helper","./ListModel","./ListView"],function(require){function e(){a.apply(this,arguments)}function t(){var e=[],t=o("input[name=whitelist-ip]");s.each(t,function(t){t.checked||e.push(t.value)}),c.rdsSetWhitelist({instanceId:this.model.get("instanceId"),ETag:this.model.get("ETag"),securityIps:e}).then(r.bind(this.reload,this))}function n(){var e=this.model.get("instance").instanceId,t=this.model.get("whitelistInArray"),n=this;this.view.waitActionDialog({title:"添加IP",width:500,needFoot:!0,url:"/rds/whitelist/edit",defaultFoot:'<div class="ok-button ui-dialog-ok-btn"data-ui="type:Button;id:btnFootOk;childName:btnOk;">确定</div><div data-ui="type:Button;id:btnFootCancel;childName:btnCancel;">取消</div>',actionOptions:{instanceId:e,ETag:this.model.get("ETag"),whitelistInArray:t}}).then(function(e){var t=e.target,i=t.getAction(),a=t.getChild("foot").getChild("btnOk"),r=t.getChild("foot").getChild("btnCancel"),s=function(){n.reload()};t.main.className+=" whitelist-dialog",a.on("click",function(){i.submit(s)}),r.on("click",function(){t.dispose()}),t.resize()})}function i(){this.view.get("selectAll").isChecked()?o("input[name=whitelist-ip]").prop("checked",!0):o("input[name=whitelist-ip]").removeAttr("checked"),this.checkBtnEnable()}var a=require("bat-ria/mvc/BaseAction"),r=require("er/util"),s=require("underscore"),o=require("jquery"),c=require("../config").api,l=require("../helper");return e.prototype.initBehavior=function(){a.prototype.initBehavior.apply(this,arguments);var e=this,r=this.view;l.handleDetailPublicEvent(this),r.on("delete",t,this),r.on("addIp",n,this),r.on("selectAll",i,this),o("input[name=whitelist-ip]").click(function(){e.checkBtnEnable(),r.get("selectAll").setChecked(o("input[name=whitelist-ip]:checked").length===o("input[name=whitelist-ip]").length)})},e.prototype.checkBtnEnable=function(){o("input[name=whitelist-ip]:checked").length>0?this.view.get("deleteBtn").enable():this.view.get("deleteBtn").disable()},e.prototype.modelType=require("./ListModel"),e.prototype.viewType=require("./ListView"),require("er/util").inherits(e,a),e}),define("rds/whitelist/list.tpl",[],function(){return'\x3c!-- target: TPL_rds_whitelist_list --\x3e\r\n<div class="rds-whitelist-list rds-main-wrap main-wrap-new">\r\n    \x3c!-- import: TPL_rds_side_bar_new --\x3e\r\n    <div class="content-wrap">\r\n        \x3c!-- import: TPL_rds_breadcrumb --\x3e\r\n            \x3c!-- block: list_link --\x3e\r\n            \x3c!-- if:${rdsType} --\x3e#/rds/list~rdsType=${rdsType}\r\n            \x3c!-- else --\x3e#/rds/list"\r\n            \x3c!-- /if --\x3e\r\n            \x3c!-- /block --\x3e\r\n            \x3c!-- block: text_content_wrapper --\x3e白名单设置\x3c!-- /block --\x3e\r\n        \x3c!-- /import --\x3e\r\n\r\n        \x3c!-- import: TPL_rds_tab --\x3e\r\n            <div class="ui-tab-content">\r\n                <div class="ui-smart-tab">\r\n                    \x3c!-- import: TPL_rds_security_tab --\x3e\r\n                </div>\r\n                <div class="table-wrap">\r\n                    <div class="ui-row">\r\n                        <button data-ui-type="Button" data-ui-id="addIpBtn"\r\n                            data-ui-skin="create">添加IP</button>\r\n                    </div>\r\n\r\n                    \x3c!-- if: ${whitelistInArray}.length > 0 --\x3e\r\n                    <ul class="whitelist-list">\r\n                        <li><input type="checkbox" data-ui-type="CheckBox" title="全选" class="select-all" data-ui-id="selectAll" />\r\n                            </li>\r\n                        \x3c!--for: ${whitelistInArray} as ${item}, ${index}--\x3e\r\n                        \x3c!--if: ${index} % 4 == 0 --\x3e\r\n                        <li>\r\n                        \x3c!--/if--\x3e\r\n                            <label>\r\n                                <input type="checkbox" name="whitelist-ip"\r\n                                    value="${item}" />\r\n                                ${item}\r\n                            </label>\r\n                        \x3c!--/for--\x3e\r\n                    </ul>\r\n                    \x3c!-- else --\x3e\r\n                    <p>暂未设置白名单</p>\r\n                    \x3c!-- /if --\x3e\r\n                    <div class="ui-row">\r\n                        <button data-ui-id="deleteBtn" data-ui-type="Button">删除</button>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n</div>\r\n'}),define("rds/whitelist/ListModel",["require","bat-ria/mvc/BaseModel","../config","../helper","../tips","er/util"],function(require){function e(){t.apply(this,arguments)}var t=require("bat-ria/mvc/BaseModel"),n=require("../config").api,i=require("../helper");return e.prototype.datasource={tips:function(){return require("../tips")},instance:function(e){return n.rdsInstanceDetail({instanceId:e.get("instanceId")}).then(function(e){return i.handlePublicData(e),e})},isWhiteAccount:function(){return n.rdsIsWhiteAccount()},tab:function(){return{security:"ui-tab-item-active",whitelist:"ui-tab-item-active"}},whitelist:function(e){return n.rdsWhitelist({instanceId:e.get("instanceId")}).then(function(t){e.set("whitelistInArray",t.ip),e.set("ETag",t.ETag)})}},e.prototype.prepare=function(){i.getDelayInfo(this)},require("er/util").inherits(e,t),e}),define("rds/whitelist/ListView",["require","bat-ria/tpl!./list.tpl","bat-ria/mvc/BaseView","er/util"],function(require){function e(){t.apply(this,arguments)}require("bat-ria/tpl!./list.tpl");var t=require("bat-ria/mvc/BaseView");return e.prototype.template="TPL_rds_whitelist_list",e.prototype.uiProperties={deleteBtn:{disabled:!0}},e.prototype.uiEvents={"deleteBtn:click":function(){this.fire("delete")},"addIpBtn:click":function(){this.fire("addIp")},"selectAll:click":function(){this.fire("selectAll")}},require("er/util").inherits(e,t),e});
//# sourceMappingURL=startup.js.map